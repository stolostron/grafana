"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[9604],{2864:(rn,ze,h)=>{h.d(ze,{h:()=>B,j:()=>N});var m=h(91890),t=h(8484);function B(Y){switch(Y){case m.CC.Logfmt:return{label:(0,t.t)("correlations.trans-details.logfmt-label","Logfmt"),value:m.CC.Logfmt,description:(0,t.t)("correlations.trans-details.logfmt-description","Parse provided field with logfmt to get variables"),expressionDetails:{show:!1},mapValueDetails:{show:!1}};case m.CC.Regex:return{label:(0,t.t)("correlations.trans-details.regex-label","Regular expression"),value:m.CC.Regex,description:(0,t.t)("correlations.trans-details.regex-description","Field will be parsed with regex. Use named capture groups to return multiple variables, or a single unnamed capture group to add variable to named map value. Regex is case insensitive."),expressionDetails:{show:!0,required:!0,helpText:(0,t.t)("correlations.trans-details.regex-expression","Use capture groups to extract a portion of the field.")},mapValueDetails:{show:!0,required:!1,helpText:(0,t.t)("correlations.trans-details.regex-map-values","Defines the name of the variable if the capture group is not named.")}};default:return{label:Y,value:Y,expressionDetails:{show:!1},mapValueDetails:{show:!1}}}}const N=()=>Object.values(m.CC).map(Y=>{const Te=B(Y);return{label:Te.label,value:Te.value,description:Te.description}})},52379:(rn,ze,h)=>{h.r(ze),h.d(ze,{default:()=>hl});var m=h(32196),t=h(96540),B=h(32264),N=h(40845),Y=h(66602),Te=h(58720),He=h(76888),ln=h(25249),C=h(8484),F=h(31678),Eo=h(24180),it=h(2739),xo=function(e,o){e===void 0&&(e=!0);var n=(0,t.useCallback)(function(a){var s=typeof e=="function"?e():!0;if(s)return a.preventDefault(),o&&(a.returnValue=o),o},[e,o]);(0,t.useEffect)(function(){if(e)return(0,it.on)(window,"beforeunload",n),function(){return(0,it.AU)(window,"beforeunload",n)}},[e,n])};const cn=xo;var So=h(64305),Ot=h(23596),M=h(14110),$e=h(67061),ye=h(56034),ce=h(14578),W=h(55852),Be=h(37390);const Co=({onSave:e,onDiscard:o,onCancel:n,message:a})=>t.createElement(Be.a,{isOpen:!0,title:"Unsaved changes to correlation",onDismiss:n,icon:"exclamation-triangle",className:(0,m.css)({width:"600px"})},t.createElement("h5",null,a),t.createElement(Be.a.ButtonRow,null,t.createElement(W.$n,{variant:"secondary",onClick:n,fill:"outline"},"Cancel"),t.createElement(W.$n,{variant:"destructive",onClick:o},"Continue without saving"),t.createElement(W.$n,{variant:"primary",onClick:e},"Save correlation")));var _=h(2543),wo=(e=>(e.SOURCE_TARGET_CHANGE="cause the query in the right pane to be re-ran and links added to that data",e.FULL_QUERY_LOSS="lose the changed query",e.FULL_CORR_LOSS="cause the correlation in progress to be lost",e.INVALID_VAR="remove the variables, and your changed query may no longer be valid",e))(wo||{});const Ro=(e,o,n,a)=>{const s=(0,_.template)("<%= actionStr %> will <%= consequenceStr %>. Would you like to save before continuing?");let r="",i="";if(e===F.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CLOSE_PANE)if(r="Closing the pane",o)if(n)i="cause the correlation in progress to be lost";else if(a)i="cause the query in the right pane to be re-ran and links added to that data";else return;else if(n)i="cause the correlation in progress to be lost";else if(a)i="lose the changed query";else return;else if(e===F.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CHANGE_DATASOURCE)if(r="Changing the datasource",o)if(n)i="cause the correlation in progress to be lost";else return;else if(a)i="lose the changed query";else return;else if(e===F.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CLOSE_EDITOR)if(r="Closing the editor",n)i="cause the correlation in progress to be lost";else if(a)i="remove the variables, and your changed query may no longer be valid";else return;return s({actionStr:r,consequenceStr:i})};var To=h(324),Ae=h(62860),we=h(62256),G=h(29436),j=h(23994),K=h(9955);const Lo=({panes:e})=>{const o=(0,F.useDispatch)(),n=(0,N.of)(Io),a=(0,F.useSelector)(K.vC),s=(0,F.useSelector)(K.st),[r,i]=(0,t.useState)(void 0);cn(a?.correlationDirty||!1,"Save correlation?"),cn(!a?.correlationDirty&&a?.queryEditorDirty||!1,"The query editor was changed. Save correlation before continuing?"),(0,t.useEffect)(()=>{if(a?.isExiting){const{correlationDirty:u,queryEditorDirty:v}=a;let g,E;a.postConfirmAction?(g=a.postConfirmAction.isActionLeft,E=a.postConfirmAction.action):(E=F.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CLOSE_EDITOR,g=!1);const f=Ro(E,g,u,v);if(f!==void 0)i(f);else if(E===F.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CHANGE_DATASOURCE&&a.postConfirmAction){const{exploreId:b,changeDatasourceUid:S}=a?.postConfirmAction;b&&S&&(o((0,Ae.wh)({exploreId:b,datasource:S,options:{importQueries:!0}})),o((0,G.am)({isExiting:!1})))}else if(E===F.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CLOSE_PANE&&a.postConfirmAction){const{exploreId:b}=a?.postConfirmAction;b!==void 0&&(o((0,G.J8)(b)),o((0,G.am)({isExiting:!1})))}else E===F.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CLOSE_EDITOR&&o((0,G.am)({editorMode:!1}))}},[a,o,s]),(0,So.A)(()=>{o((0,G.am)({editorMode:!1,isExiting:!1,correlationDirty:!1,label:void 0,description:void 0,canSave:!1})),e.forEach(u=>{o((0,we.nE)({exploreId:u[0],correlationEditorHelperData:void 0})),o((0,j.Od)({exploreId:u[0]}))})});const l=()=>{o((0,G.am)({editorMode:!0,isExiting:!1,correlationDirty:!1,label:void 0,description:void 0,canSave:!1})),e.forEach(u=>{o((0,we.nE)({exploreId:u[0],correlationEditorHelperData:void 0})),o((0,j.Od)({exploreId:u[0]}))})},d=u=>{i(void 0),o((0,G.J8)(u)),(0,M.rR)("grafana_explore_split_view_closed")},c=(u,v)=>{i(void 0),o((0,Ae.wh)({exploreId:u,datasource:v,options:{importQueries:!0}}))},p=u=>{if(o((0,To.v)(a?.label,a?.description,a?.transformations)),!u&&a?.postConfirmAction!==void 0){const{exploreId:v,action:g,changeDatasourceUid:E}=a?.postConfirmAction;g===F.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CLOSE_PANE?(d(v),l()):g===F.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CHANGE_DATASOURCE&&E!==void 0&&((0,Ae.wh)({exploreId:v,datasource:E}),l())}else o((0,G.am)({editorMode:!1,correlationDirty:!1,isExiting:!1}))};return t.createElement(t.Fragment,null,t.createElement(Eo.XG,{message:u=>u.pathname!=="/explore"&&a?.editorMode&&a?.correlationDirty?"You have unsaved correlation data. Continue?":!0}),r!==void 0&&t.createElement(Co,{onDiscard:()=>{if(a?.postConfirmAction!==void 0){const{exploreId:u,action:v,changeDatasourceUid:g}=a?.postConfirmAction;v===F.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CLOSE_PANE?d(u):v===F.CORRELATION_EDITOR_POST_CONFIRM_ACTION.CHANGE_DATASOURCE&&g!==void 0&&c(u,g),o((0,G.am)({isExiting:!1}))}else o((0,G.am)({editorMode:!1,correlationDirty:!1,isExiting:!1}))},onCancel:()=>{o((0,G.am)({isExiting:!1})),i(void 0)},onSave:()=>{p(!1)},message:r}),t.createElement("div",{className:n.correlationEditorTop},t.createElement($e.B,{gap:2,justifyContent:"flex-end",alignItems:"center"},t.createElement(ye.m,{content:"Correlations editor in Explore is an experimental feature."},t.createElement(ce.I,{className:n.iconColor,name:"info-circle",size:"xl"})),t.createElement(W.$n,{variant:"secondary",disabled:!a?.canSave,fill:"outline",className:a?.canSave?n.buttonColor:n.disabledButtonColor,onClick:()=>{p(!0)}},"Save"),t.createElement(W.$n,{variant:"secondary",fill:"outline",className:n.buttonColor,icon:"times",onClick:()=>{o((0,G.am)({isExiting:!0})),(0,M.rR)("grafana_explore_correlation_editor_exit_pressed")}},"Exit correlation editor"))))},Io=e=>{const o=e.colors.getContrastText(e.colors.primary.main),n=Ot.lighten(e.colors.primary.main,.1),a=Ot.darken(e.colors.primary.main,.2),s=Ot.darken(o,.2);return{correlationEditorTop:(0,m.css)({backgroundColor:e.colors.primary.main,marginTop:"3px",padding:e.spacing(1)}),iconColor:(0,m.css)({color:o}),buttonColor:(0,m.css)({color:o,borderColor:o,"&:hover":{color:o,borderColor:o,backgroundColor:n}}),disabledButtonColor:(0,m.css)({color:`${s} !important`,backgroundColor:`${a} !important`})}};var Dt=h(1503),lt=h(16233),ct=h(14678);const Fo=()=>{const[e,o]=(0,t.useState)([]),{query:n}=(0,Dt.useKBar)(),a=(0,F.useDispatch)(),s=(0,F.useSelector)(K.Qb),r=(0,F.useSelector)(K.pF),i=lt.TP.hasPermission(F.AccessControlAction.DataSourcesWrite);return(0,t.useEffect)(()=>{const l=Object.keys(s),d={name:"Explore",priority:Dt.Priority.HIGH+1},c=[];if(r)c.push({id:"explore/run-query-left",name:"Run query (left)",keywords:"query left",perform:()=>{a((0,j.Od)({exploreId:l[0]}))},section:d}),s[1],c.push({id:"explore/run-query-right",name:"Run query (right)",keywords:"query right",perform:()=>{a((0,j.Od)({exploreId:l[1]}))},section:d}),c.push({id:"explore/split-view-close-left",name:"Close split view left",keywords:"split",perform:()=>{a((0,G.J8)(l[0]))},section:d}),c.push({id:"explore/split-view-close-right",name:"Close split view right",keywords:"split",perform:()=>{a((0,G.J8)(l[1]))},section:d});else{const p=Object.values(s).some(u=>u?.datasourceInstance?.uid===ct.uv);B.$.featureToggles.correlations&&i&&!p&&c.push({id:"explore/correlations-editor",name:"Correlations editor",perform:()=>{a((0,G.am)({editorMode:!0})),a((0,j.Od)({exploreId:l[0]}))},section:d}),c.push({id:"explore/run-query",name:"Run query",keywords:"query",perform:()=>{a((0,j.Od)({exploreId:l[0]}))},section:d}),c.push({id:"explore/split-view-open",name:"Open split view",keywords:"split",perform:()=>{a((0,G.ve)())},section:d})}o(c)},[s,r,n,a,i]),(0,Dt.useRegisterActions)(n?e:[],[e,n]),null};var Oo=h(40961),Do=function(){var e=function(o,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(a,s){a.__proto__=s}||function(a,s){for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(a[r]=s[r])},e(o,n)};return function(o,n){e(o,n);function a(){this.constructor=o}o.prototype=n===null?Object.create(n):(a.prototype=n.prototype,new a)}}(),J=function(){return J=Object.assign||function(e){for(var o,n=1,a=arguments.length;n<a;n++){o=arguments[n];for(var s in o)Object.prototype.hasOwnProperty.call(o,s)&&(e[s]=o[s])}return e},J.apply(this,arguments)},dn={width:"100%",height:"10px",top:"0px",left:"0px",cursor:"row-resize"},un={width:"10px",height:"100%",top:"0px",left:"0px",cursor:"col-resize"},dt={width:"20px",height:"20px",position:"absolute"},Ao={top:J(J({},dn),{top:"-5px"}),right:J(J({},un),{left:void 0,right:"-5px"}),bottom:J(J({},dn),{top:void 0,bottom:"-5px"}),left:J(J({},un),{left:"-5px"}),topRight:J(J({},dt),{right:"-10px",top:"-10px",cursor:"ne-resize"}),bottomRight:J(J({},dt),{right:"-10px",bottom:"-10px",cursor:"se-resize"}),bottomLeft:J(J({},dt),{left:"-10px",bottom:"-10px",cursor:"sw-resize"}),topLeft:J(J({},dt),{left:"-10px",top:"-10px",cursor:"nw-resize"})},No=function(e){Do(o,e);function o(){var n=e!==null&&e.apply(this,arguments)||this;return n.onMouseDown=function(a){n.props.onResizeStart(a,n.props.direction)},n.onTouchStart=function(a){n.props.onResizeStart(a,n.props.direction)},n}return o.prototype.render=function(){return t.createElement("div",{className:this.props.className||"",style:J(J({position:"absolute",userSelect:"none"},Ao[this.props.direction]),this.props.replaceStyles||{}),onMouseDown:this.onMouseDown,onTouchStart:this.onTouchStart},this.props.children)},o}(t.PureComponent),ko=function(){var e=function(o,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(a,s){a.__proto__=s}||function(a,s){for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(a[r]=s[r])},e(o,n)};return function(o,n){e(o,n);function a(){this.constructor=o}o.prototype=n===null?Object.create(n):(a.prototype=n.prototype,new a)}}(),ve=function(){return ve=Object.assign||function(e){for(var o,n=1,a=arguments.length;n<a;n++){o=arguments[n];for(var s in o)Object.prototype.hasOwnProperty.call(o,s)&&(e[s]=o[s])}return e},ve.apply(this,arguments)},Po={width:"auto",height:"auto"},ut=function(e,o,n){return Math.max(Math.min(e,n),o)},pn=function(e,o){return Math.round(e/o)*o},Ve=function(e,o){return new RegExp(e,"i").test(o)},pt=function(e){return!!(e.touches&&e.touches.length)},Mo=function(e){return!!((e.clientX||e.clientX===0)&&(e.clientY||e.clientY===0))},hn=function(e,o,n){n===void 0&&(n=0);var a=o.reduce(function(r,i,l){return Math.abs(i-e)<Math.abs(o[r]-e)?l:r},0),s=Math.abs(o[a]-e);return n===0||s<n?o[a]:e},At=function(e){return e=e.toString(),e==="auto"||e.endsWith("px")||e.endsWith("%")||e.endsWith("vh")||e.endsWith("vw")||e.endsWith("vmax")||e.endsWith("vmin")?e:e+"px"},ht=function(e,o,n,a){if(e&&typeof e=="string"){if(e.endsWith("px"))return Number(e.replace("px",""));if(e.endsWith("%")){var s=Number(e.replace("%",""))/100;return o*s}if(e.endsWith("vw")){var s=Number(e.replace("vw",""))/100;return n*s}if(e.endsWith("vh")){var s=Number(e.replace("vh",""))/100;return a*s}}return e},zo=function(e,o,n,a,s,r,i){return a=ht(a,e.width,o,n),s=ht(s,e.height,o,n),r=ht(r,e.width,o,n),i=ht(i,e.height,o,n),{maxWidth:typeof a>"u"?void 0:Number(a),maxHeight:typeof s>"u"?void 0:Number(s),minWidth:typeof r>"u"?void 0:Number(r),minHeight:typeof i>"u"?void 0:Number(i)}},Ho=function(e){return Array.isArray(e)?e:[e,e]},$o=["as","ref","style","className","grid","snap","bounds","boundsByDirection","size","defaultSize","minWidth","minHeight","maxWidth","maxHeight","lockAspectRatio","lockAspectRatioExtraWidth","lockAspectRatioExtraHeight","enable","handleStyles","handleClasses","handleWrapperStyle","handleWrapperClass","children","onResizeStart","onResize","onResizeStop","handleComponent","scale","resizeRatio","snapGap"],mn="__resizable_base__",gn=function(e){ko(o,e);function o(n){var a,s,r,i,l=e.call(this,n)||this;return l.ratio=1,l.resizable=null,l.parentLeft=0,l.parentTop=0,l.resizableLeft=0,l.resizableRight=0,l.resizableTop=0,l.resizableBottom=0,l.targetLeft=0,l.targetTop=0,l.appendBase=function(){if(!l.resizable||!l.window)return null;var d=l.parentNode;if(!d)return null;var c=l.window.document.createElement("div");return c.style.width="100%",c.style.height="100%",c.style.position="absolute",c.style.transform="scale(0, 0)",c.style.left="0",c.style.flex="0 0 100%",c.classList?c.classList.add(mn):c.className+=mn,d.appendChild(c),c},l.removeBase=function(d){var c=l.parentNode;c&&c.removeChild(d)},l.state={isResizing:!1,width:(s=(a=l.propsSize)===null||a===void 0?void 0:a.width)!==null&&s!==void 0?s:"auto",height:(i=(r=l.propsSize)===null||r===void 0?void 0:r.height)!==null&&i!==void 0?i:"auto",direction:"right",original:{x:0,y:0,width:0,height:0},backgroundStyle:{height:"100%",width:"100%",backgroundColor:"rgba(0,0,0,0)",cursor:"auto",opacity:0,position:"fixed",zIndex:9999,top:"0",left:"0",bottom:"0",right:"0"},flexBasis:void 0},l.onResizeStart=l.onResizeStart.bind(l),l.onMouseMove=l.onMouseMove.bind(l),l.onMouseUp=l.onMouseUp.bind(l),l}return Object.defineProperty(o.prototype,"parentNode",{get:function(){return this.resizable?this.resizable.parentNode:null},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"window",{get:function(){return!this.resizable||!this.resizable.ownerDocument?null:this.resizable.ownerDocument.defaultView},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"propsSize",{get:function(){return this.props.size||this.props.defaultSize||Po},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"size",{get:function(){var n=0,a=0;if(this.resizable&&this.window){var s=this.resizable.offsetWidth,r=this.resizable.offsetHeight,i=this.resizable.style.position;i!=="relative"&&(this.resizable.style.position="relative"),n=this.resizable.style.width!=="auto"?this.resizable.offsetWidth:s,a=this.resizable.style.height!=="auto"?this.resizable.offsetHeight:r,this.resizable.style.position=i}return{width:n,height:a}},enumerable:!1,configurable:!0}),Object.defineProperty(o.prototype,"sizeStyle",{get:function(){var n=this,a=this.props.size,s=function(l){var d;if(typeof n.state[l]>"u"||n.state[l]==="auto")return"auto";if(n.propsSize&&n.propsSize[l]&&(!((d=n.propsSize[l])===null||d===void 0)&&d.toString().endsWith("%"))){if(n.state[l].toString().endsWith("%"))return n.state[l].toString();var c=n.getParentSize(),p=Number(n.state[l].toString().replace("px","")),u=p/c[l]*100;return u+"%"}return At(n.state[l])},r=a&&typeof a.width<"u"&&!this.state.isResizing?At(a.width):s("width"),i=a&&typeof a.height<"u"&&!this.state.isResizing?At(a.height):s("height");return{width:r,height:i}},enumerable:!1,configurable:!0}),o.prototype.getParentSize=function(){if(!this.parentNode)return this.window?{width:this.window.innerWidth,height:this.window.innerHeight}:{width:0,height:0};var n=this.appendBase();if(!n)return{width:0,height:0};var a=!1,s=this.parentNode.style.flexWrap;s!=="wrap"&&(a=!0,this.parentNode.style.flexWrap="wrap"),n.style.position="relative",n.style.minWidth="100%",n.style.minHeight="100%";var r={width:n.offsetWidth,height:n.offsetHeight};return a&&(this.parentNode.style.flexWrap=s),this.removeBase(n),r},o.prototype.bindEvents=function(){this.window&&(this.window.addEventListener("mouseup",this.onMouseUp),this.window.addEventListener("mousemove",this.onMouseMove),this.window.addEventListener("mouseleave",this.onMouseUp),this.window.addEventListener("touchmove",this.onMouseMove,{capture:!0,passive:!1}),this.window.addEventListener("touchend",this.onMouseUp))},o.prototype.unbindEvents=function(){this.window&&(this.window.removeEventListener("mouseup",this.onMouseUp),this.window.removeEventListener("mousemove",this.onMouseMove),this.window.removeEventListener("mouseleave",this.onMouseUp),this.window.removeEventListener("touchmove",this.onMouseMove,!0),this.window.removeEventListener("touchend",this.onMouseUp))},o.prototype.componentDidMount=function(){if(!(!this.resizable||!this.window)){var n=this.window.getComputedStyle(this.resizable);this.setState({width:this.state.width||this.size.width,height:this.state.height||this.size.height,flexBasis:n.flexBasis!=="auto"?n.flexBasis:void 0})}},o.prototype.componentWillUnmount=function(){this.window&&this.unbindEvents()},o.prototype.createSizeForCssProperty=function(n,a){var s=this.propsSize&&this.propsSize[a];return this.state[a]==="auto"&&this.state.original[a]===n&&(typeof s>"u"||s==="auto")?"auto":n},o.prototype.calculateNewMaxFromBoundary=function(n,a){var s=this.props.boundsByDirection,r=this.state.direction,i=s&&Ve("left",r),l=s&&Ve("top",r),d,c;if(this.props.bounds==="parent"){var p=this.parentNode;p&&(d=i?this.resizableRight-this.parentLeft:p.offsetWidth+(this.parentLeft-this.resizableLeft),c=l?this.resizableBottom-this.parentTop:p.offsetHeight+(this.parentTop-this.resizableTop))}else this.props.bounds==="window"?this.window&&(d=i?this.resizableRight:this.window.innerWidth-this.resizableLeft,c=l?this.resizableBottom:this.window.innerHeight-this.resizableTop):this.props.bounds&&(d=i?this.resizableRight-this.targetLeft:this.props.bounds.offsetWidth+(this.targetLeft-this.resizableLeft),c=l?this.resizableBottom-this.targetTop:this.props.bounds.offsetHeight+(this.targetTop-this.resizableTop));return d&&Number.isFinite(d)&&(n=n&&n<d?n:d),c&&Number.isFinite(c)&&(a=a&&a<c?a:c),{maxWidth:n,maxHeight:a}},o.prototype.calculateNewSizeFromDirection=function(n,a){var s=this.props.scale||1,r=Ho(this.props.resizeRatio||1),i=r[0],l=r[1],d=this.state,c=d.direction,p=d.original,u=this.props,v=u.lockAspectRatio,g=u.lockAspectRatioExtraHeight,E=u.lockAspectRatioExtraWidth,f=p.width,b=p.height,S=g||0,w=E||0;return Ve("right",c)&&(f=p.width+(n-p.x)*i/s,v&&(b=(f-w)/this.ratio+S)),Ve("left",c)&&(f=p.width-(n-p.x)*i/s,v&&(b=(f-w)/this.ratio+S)),Ve("bottom",c)&&(b=p.height+(a-p.y)*l/s,v&&(f=(b-S)*this.ratio+w)),Ve("top",c)&&(b=p.height-(a-p.y)*l/s,v&&(f=(b-S)*this.ratio+w)),{newWidth:f,newHeight:b}},o.prototype.calculateNewSizeFromAspectRatio=function(n,a,s,r){var i=this.props,l=i.lockAspectRatio,d=i.lockAspectRatioExtraHeight,c=i.lockAspectRatioExtraWidth,p=typeof r.width>"u"?10:r.width,u=typeof s.width>"u"||s.width<0?n:s.width,v=typeof r.height>"u"?10:r.height,g=typeof s.height>"u"||s.height<0?a:s.height,E=d||0,f=c||0;if(l){var b=(v-E)*this.ratio+f,S=(g-E)*this.ratio+f,w=(p-f)/this.ratio+E,y=(u-f)/this.ratio+E,x=Math.max(p,b),T=Math.min(u,S),R=Math.max(v,w),A=Math.min(g,y);n=ut(n,x,T),a=ut(a,R,A)}else n=ut(n,p,u),a=ut(a,v,g);return{newWidth:n,newHeight:a}},o.prototype.setBoundingClientRect=function(){if(this.props.bounds==="parent"){var n=this.parentNode;if(n){var a=n.getBoundingClientRect();this.parentLeft=a.left,this.parentTop=a.top}}if(this.props.bounds&&typeof this.props.bounds!="string"){var s=this.props.bounds.getBoundingClientRect();this.targetLeft=s.left,this.targetTop=s.top}if(this.resizable){var r=this.resizable.getBoundingClientRect(),i=r.left,l=r.top,d=r.right,c=r.bottom;this.resizableLeft=i,this.resizableRight=d,this.resizableTop=l,this.resizableBottom=c}},o.prototype.onResizeStart=function(n,a){if(!(!this.resizable||!this.window)){var s=0,r=0;if(n.nativeEvent&&Mo(n.nativeEvent)?(s=n.nativeEvent.clientX,r=n.nativeEvent.clientY):n.nativeEvent&&pt(n.nativeEvent)&&(s=n.nativeEvent.touches[0].clientX,r=n.nativeEvent.touches[0].clientY),this.props.onResizeStart&&this.resizable){var i=this.props.onResizeStart(n,a,this.resizable);if(i===!1)return}this.props.size&&(typeof this.props.size.height<"u"&&this.props.size.height!==this.state.height&&this.setState({height:this.props.size.height}),typeof this.props.size.width<"u"&&this.props.size.width!==this.state.width&&this.setState({width:this.props.size.width})),this.ratio=typeof this.props.lockAspectRatio=="number"?this.props.lockAspectRatio:this.size.width/this.size.height;var l,d=this.window.getComputedStyle(this.resizable);if(d.flexBasis!=="auto"){var c=this.parentNode;if(c){var p=this.window.getComputedStyle(c).flexDirection;this.flexDir=p.startsWith("row")?"row":"column",l=d.flexBasis}}this.setBoundingClientRect(),this.bindEvents();var u={original:{x:s,y:r,width:this.size.width,height:this.size.height},isResizing:!0,backgroundStyle:ve(ve({},this.state.backgroundStyle),{cursor:this.window.getComputedStyle(n.target).cursor||"auto"}),direction:a,flexBasis:l};this.setState(u)}},o.prototype.onMouseMove=function(n){var a=this;if(!(!this.state.isResizing||!this.resizable||!this.window)){if(this.window.TouchEvent&&pt(n))try{n.preventDefault(),n.stopPropagation()}catch{}var s=this.props,r=s.maxWidth,i=s.maxHeight,l=s.minWidth,d=s.minHeight,c=pt(n)?n.touches[0].clientX:n.clientX,p=pt(n)?n.touches[0].clientY:n.clientY,u=this.state,v=u.direction,g=u.original,E=u.width,f=u.height,b=this.getParentSize(),S=zo(b,this.window.innerWidth,this.window.innerHeight,r,i,l,d);r=S.maxWidth,i=S.maxHeight,l=S.minWidth,d=S.minHeight;var w=this.calculateNewSizeFromDirection(c,p),y=w.newHeight,x=w.newWidth,T=this.calculateNewMaxFromBoundary(r,i);this.props.snap&&this.props.snap.x&&(x=hn(x,this.props.snap.x,this.props.snapGap)),this.props.snap&&this.props.snap.y&&(y=hn(y,this.props.snap.y,this.props.snapGap));var R=this.calculateNewSizeFromAspectRatio(x,y,{width:T.maxWidth,height:T.maxHeight},{width:l,height:d});if(x=R.newWidth,y=R.newHeight,this.props.grid){var A=pn(x,this.props.grid[0]),O=pn(y,this.props.grid[1]),k=this.props.snapGap||0,V=k===0||Math.abs(A-x)<=k?A:x,z=k===0||Math.abs(O-y)<=k?O:y;x=V,y=z}var H={width:x-g.width,height:y-g.height};if(E&&typeof E=="string"){if(E.endsWith("%")){var te=x/b.width*100;x=te+"%"}else if(E.endsWith("vw")){var ee=x/this.window.innerWidth*100;x=ee+"vw"}else if(E.endsWith("vh")){var oe=x/this.window.innerHeight*100;x=oe+"vh"}}if(f&&typeof f=="string"){if(f.endsWith("%")){var te=y/b.height*100;y=te+"%"}else if(f.endsWith("vw")){var ee=y/this.window.innerWidth*100;y=ee+"vw"}else if(f.endsWith("vh")){var oe=y/this.window.innerHeight*100;y=oe+"vh"}}var L={width:this.createSizeForCssProperty(x,"width"),height:this.createSizeForCssProperty(y,"height")};this.flexDir==="row"?L.flexBasis=L.width:this.flexDir==="column"&&(L.flexBasis=L.height);var D=this.state.width!==L.width,P=this.state.height!==L.height,I=this.state.flexBasis!==L.flexBasis,Q=D||P||I;Q&&(0,Oo.flushSync)(function(){a.setState(L)}),this.props.onResize&&Q&&this.props.onResize(n,v,this.resizable,H)}},o.prototype.onMouseUp=function(n){var a,s,r=this.state,i=r.isResizing,l=r.direction,d=r.original;if(!(!i||!this.resizable)){var c={width:this.size.width-d.width,height:this.size.height-d.height};this.props.onResizeStop&&this.props.onResizeStop(n,l,this.resizable,c),this.props.size&&this.setState({width:(a=this.props.size.width)!==null&&a!==void 0?a:"auto",height:(s=this.props.size.height)!==null&&s!==void 0?s:"auto"}),this.unbindEvents(),this.setState({isResizing:!1,backgroundStyle:ve(ve({},this.state.backgroundStyle),{cursor:"auto"})})}},o.prototype.updateSize=function(n){var a,s;this.setState({width:(a=n.width)!==null&&a!==void 0?a:"auto",height:(s=n.height)!==null&&s!==void 0?s:"auto"})},o.prototype.renderResizer=function(){var n=this,a=this.props,s=a.enable,r=a.handleStyles,i=a.handleClasses,l=a.handleWrapperStyle,d=a.handleWrapperClass,c=a.handleComponent;if(!s)return null;var p=Object.keys(s).map(function(u){return s[u]!==!1?t.createElement(No,{key:u,direction:u,onResizeStart:n.onResizeStart,replaceStyles:r&&r[u],className:i&&i[u]},c&&c[u]?c[u]:null):null});return t.createElement("div",{className:d,style:l},p)},o.prototype.render=function(){var n=this,a=Object.keys(this.props).reduce(function(i,l){return $o.indexOf(l)!==-1||(i[l]=n.props[l]),i},{}),s=ve(ve(ve({position:"relative",userSelect:this.state.isResizing?"none":"auto"},this.props.style),this.sizeStyle),{maxWidth:this.props.maxWidth,maxHeight:this.props.maxHeight,minWidth:this.props.minWidth,minHeight:this.props.minHeight,boxSizing:"border-box",flexShrink:0});this.state.flexBasis&&(s.flexBasis=this.state.flexBasis);var r=this.props.as||"div";return t.createElement(r,ve({style:s,className:this.props.className},a,{ref:function(i){i&&(n.resizable=i)}}),this.state.isResizing&&t.createElement("div",{style:this.state.backgroundStyle}),this.props.children,this.renderResizer())},o.defaultProps={as:"div",onResizeStart:function(){},onResize:function(){},onResizeStop:function(){},enable:{top:!0,right:!0,bottom:!0,left:!0,topRight:!0,bottomRight:!0,bottomLeft:!0,topLeft:!0},style:{},grid:[1,1],lockAspectRatio:!1,lockAspectRatioExtraWidth:0,lockAspectRatioExtraHeight:0,scale:1,resizeRatio:1,snapGap:0},o}(t.PureComponent),Bo=h(69144);function fn(e){const{children:o,onResize:n,initialHeight:a}=e,s=(0,N.$j)(),r=(0,N.of)(Wo),i=(0,Bo.l)(s),l=a||`${s.components.horizontalDrawer.defaultHeight}px`;return t.createElement(gn,{className:(0,m.cx)(r.fixed,r.container,r.drawerActive),defaultSize:{width:"100%",height:l},handleClasses:{top:i.dragHandleHorizontal},enable:{top:!0,right:!1,bottom:!1,left:!1,topRight:!1,bottomRight:!1,bottomLeft:!1,topLeft:!1},maxHeight:"100vh",onResize:n},o)}const Vo=e=>(0,m.keyframes)`
  0% {
    transform: translateY(${e.components.horizontalDrawer.defaultHeight}px);
  }

  100% {
    transform: translateY(0px);
  }
`,Wo=e=>({fixed:(0,m.css)({position:"absolute !important"}),container:(0,m.css)({bottom:0,background:e.colors.background.primary,borderTop:`1px solid ${e.colors.border.weak}`,boxShadow:e.shadows.z3,zIndex:e.zIndex.navbarFixed}),drawerActive:(0,m.css)({opacity:1,[e.transitions.handleMotion("no-preference")]:{animation:`0.5s ease-out ${Vo(e)}`}})});var me=h(71468),Qo=h(18226),yn=h(1933),Qe=h(13544),mt=h(40276),je=h(87490),jo=h(70713),Z=h(9557),de=h(39070),Le=h(19347),Nt=h(52494),gt=h(88407),Ue=h(11401),ft=h(32901),vn=h(42941),Uo=h(23535),qo=function(e){var o=(0,Uo.A)({x:0,y:0}),n=o[0],a=o[1];return(0,t.useEffect)(function(){var s=function(){e.current&&a({x:e.current.scrollLeft,y:e.current.scrollTop})};return e.current&&(0,it.on)(e.current,"scroll",s,{capture:!1,passive:!0}),function(){e.current&&(0,it.AU)(e.current,"scroll",s)}},[e]),n};const Go=qo,kt=(0,t.createContext)(void 0);function Ko({children:e,refreshDependencies:o}){const[n,a]=(0,t.useState)([]),s=(0,t.useRef)({}),r=(0,t.useCallback)(c=>{const p=(0,_.uniqueId)(`${c.panelId}-${c.title}-${c.icon}_`);return a(u=>{if(c.level==="root"){const v=s.current[c.panelId]||[];return v.length>0&&s.current[c.panelId].forEach(E=>{E.type==="filter"&&(E.ref=c.ref)}),s.current[c.panelId]=[],[...u,{...c,id:p,children:v}].sort(Pt)}if(c.level==="child"){let v=!1;if(Object.keys(s.current).forEach(y=>{if(s.current[y].find(T=>T.title===c.title&&c.type==="filter"&&c.panelId===T.panelId)){v=!0;return}}),v)return[...u];const g=u.findIndex(y=>y.panelId===c.panelId&&y.level==="root");if(g===-1)return Object.keys(s.current).find(x=>x===c.panelId)?s.current[c.panelId].push({...c,id:p}):s.current[c.panelId]=[{...c,id:p}],[...u];const E=[...u],f={...E[g]},b=f.children?.find(y=>y.title===c.title&&c.type==="filter"&&c.panelId===y.panelId);if(b&&b.highlight!==c.highlight)return f.children?.map(y=>{y.title===b?.title&&(y.highlight=c.highlight)}),[...u];if(b)return[...u];let S=c.ref;c.type==="filter"&&(S=f.ref);const w=[...f.children||[],{...c,id:p,ref:S}];return w.sort(Pt),E[g]={...f,children:w},E}return[...u]}),p},[]),i=(0,t.useCallback)(c=>{a(p=>p.filter(u=>u.id!==c).map(u=>(u.children&&(u.children=u.children.filter(v=>v.id!==c)),u)))},[]),l=(0,t.useCallback)(c=>{a(c)},[]),d=(0,t.useCallback)((c,p)=>{a(u=>u.map(v=>(v.id===c&&(v.children=v.children?.filter(g=>g.type!==p)),v)))},[]);return(0,t.useEffect)(()=>{a(c=>{const p=[...c];for(const u of p)u.children?.sort(Pt);return p})},[o]),t.createElement(kt.Provider,{value:{outlineItems:n,register:r,unregister:i,updateOutlineItems:l,unregisterAllChildren:d}},e)}function Pt(e,o){if(e.ref&&o.ref){const n=e.ref.compareDocumentPosition(o.ref);if(n===Node.DOCUMENT_POSITION_PRECEDING)return 1;if(n===Node.DOCUMENT_POSITION_FOLLOWING)return-1}return 0}function bn(){return(0,t.useContext)(kt)}var Zo=h(8887);function Mt({contentOutlineExpanded:e,title:o,icon:n,tooltip:a,tooltipPlacement:s="bottom",className:r,indentStyle:i,collapsible:l,collapsed:d,isActive:c,extraHighlight:p,sectionId:u,toggleCollapsed:v,color:g,...E}){const f=(0,N.$j)(),b=Yo(f,g),S=(0,m.cx)(b.button,r),w=(0,t.useRef)(null),[y,x]=(0,t.useState)(!1);(0,t.useEffect)(()=>{w.current&&x(w.current?.scrollWidth>w.current?.clientWidth)},[o]);const T=t.createElement("div",{className:(0,m.cx)(b.buttonContainer,i)},l&&t.createElement("button",{className:b.collapseButton,onClick:v,"aria-label":"Content outline item collapse button","aria-expanded":!d,"aria-controls":u},t.createElement(En,{icon:d?"angle-right":"angle-down"})),t.createElement("button",{className:(0,m.cx)(S,{[b.active]:c,[b.extraHighlight]:p}),"aria-label":a,...E},t.createElement(En,{icon:n}),o&&t.createElement("span",{className:b.textContainer,ref:w},o)));return a&&(!e||y)?t.createElement(ye.m,{content:a,placement:s},T):T}function En({icon:e}){return e?(0,Zo.n6)(e)?t.createElement(ce.I,{name:e,size:"lg",title:e}):e:null}const Yo=(e,o)=>({buttonContainer:(0,m.css)({position:"relative",display:"flex",alignItems:"center",flexGrow:1,gap:e.spacing(1),overflow:"hidden",width:"100%"}),button:(0,m.css)({label:"content-outline-item-button",display:"flex",alignItems:"center",height:e.spacing(e.components.height.md),padding:e.spacing(0,1),gap:e.spacing(1),color:e.colors.text.secondary,width:"100%",background:"transparent",border:"none"}),collapseButton:(0,m.css)({display:"flex",alignItems:"center",justifyContent:"center",width:e.spacing(3),height:e.spacing(4),borderRadius:e.shape.radius.default,color:e.colors.text.secondary,background:"transparent",border:"none","&:hover":{color:e.colors.text.primary,background:e.colors.secondary.shade}}),textContainer:(0,m.css)({whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}),active:(0,m.css)({backgroundColor:e.colors.background.secondary,borderTopRightRadius:e.shape.radius.default,borderBottomRightRadius:e.shape.radius.default,position:"relative",height:e.spacing(e.components.height.md),"&::before":{backgroundImage:o!==void 0?"none":e.colors.gradients.brandVertical,backgroundColor:o!==void 0?o:"none",borderRadius:e.shape.radius.default,content:'" "',display:"block",height:"100%",position:"absolute",transform:"translateX(-50%)",width:e.spacing(.5),left:"2px"}}),extraHighlight:(0,m.css)({backgroundColor:e.colors.background.secondary,borderTopRightRadius:e.shape.radius.default,borderBottomRightRadius:e.shape.radius.default,position:"relative","&::before":{backgroundImage:o!==void 0?"none":e.colors.gradients.brandVertical,backgroundColor:o!==void 0?o:"none",borderRadius:e.shape.radius.default,content:'" "',display:"block",height:"100%",position:"absolute",transform:"translateX(-50%)",width:e.spacing(.5),left:"2px"}})});function xn(e){return e.children?.filter(o=>o.type!=="filter")||[]}function Sn(e,o,n,a){const s=o===e.id,r=n===e.id,i=!a[e.id],l=xn(e).length>0,d=vt(e,n)&&!a[e.id];return l?i&&(s||d):s||r}function Jo({scroller:e,panelId:o}){const[n,a]=(0,vn.A)(!1),s=(0,N.of)(Xo,n),r=(0,t.useRef)(e||null),{y:i}=Go(r),{outlineItems:l}=bn()??{outlineItems:[]},[d,c]=(0,t.useState)(l[0]?.id),[p,u]=(0,t.useState)(l[0]?.children?.[0]?.id),v=l.some(y=>y.children&&!(y.mergeSingleChild&&y.children?.length===1)&&y.children.length>0),[g,E]=(0,t.useState)(()=>l.reduce((y,x)=>(y[x.id]=!1,y),{})),f=(y,x,T=0)=>{let R=0,A=y;do R+=A?.offsetTop||0,A=A?.offsetParent instanceof HTMLElement?A.offsetParent:void 0;while(A&&A!==e);e?.scroll({top:R+T,behavior:"smooth"}),(0,M.rR)("explore_toolbar_contentoutline_clicked",{item:"select_section",type:x})},b=()=>{a(),(0,M.rR)("explore_toolbar_contentoutline_clicked",{item:"outline",type:n?"minimize":"expand"})},S=y=>{E(x=>({...x,[y]:!x[y]})),(0,M.rR)("explore_toolbar_contentoutline_clicked",{item:"section",type:g[y]?"expand":"minimize"})};(0,t.useEffect)(()=>{let y;for(const x of l){let T=x?.ref?.getBoundingClientRect().top;T&&T>=0&&(y=x);const R=xn(x).find(A=>{const O=A.customTopOffset||0;let k=A?.ref?.getBoundingClientRect().top;return k&&k>=O});if(R&&yt(x)){u(R.id),c(x.id);break}if(y){c(y.id),u(void 0);break}}},[l,i]);const w=y=>{const x=l.find(T=>T.children?.find(R=>R.id===y));x&&f(x.ref,x.panelId,x.customTopOffset)};return t.createElement(Nt._,{className:s.wrapper,id:o},t.createElement(mt.E,null,t.createElement("div",{className:s.content},t.createElement(Mt,{icon:"arrow-from-right",tooltip:n?"Collapse outline":"Expand outline",tooltipPlacement:n?"right":"bottom",onClick:b,className:(0,m.cx)(s.toggleContentOutlineButton,{[s.justifyCenter]:!n&&!v}),"aria-expanded":n}),l.map(y=>t.createElement(t.Fragment,{key:y.id},t.createElement(Mt,{key:y.id,title:n?y.title:void 0,contentOutlineExpanded:n,className:(0,m.cx)(s.buttonStyles,{[s.justifyCenter]:!n,[s.sectionHighlighter]:vt(y,p)&&!n}),indentStyle:(0,m.cx)({[s.indentRoot]:!yt(y)&&v,[s.sectionHighlighter]:vt(y,p)&&!n&&g[y.id]}),icon:y.icon,onClick:()=>f(y.ref,y.panelId),tooltip:y.title,collapsible:yt(y),collapsed:!g[y.id],toggleCollapsed:()=>S(y.id),isActive:Sn(y,d,p,g),sectionId:y.id,color:y.color}),t.createElement("div",{id:y.id,"data-testid":`section-wrapper-${y.id}`},y.children&&yt(y)&&g[y.id]&&y.children.map((x,T)=>t.createElement("div",{key:x.id,className:s.itemWrapper},n&&t.createElement("div",{className:(0,m.cx)(s.itemConnector,{[s.firstItemConnector]:T===0,[s.lastItemConnector]:T===(y.children?.length||0)-1})}),t.createElement(Mt,{key:x.id,title:n?x.title:void 0,contentOutlineExpanded:n,icon:n?void 0:y.icon,className:(0,m.cx)(s.buttonStyles,{[s.justifyCenter]:!n,[s.sectionHighlighter]:vt(y,p)&&!n}),indentStyle:s.indentChild,onClick:R=>{x.type==="filter"?w(x.id):f(x.ref,x.panelId,x.customTopOffset),x.onClick?.(R)},tooltip:x.title,isActive:Sn(x,d,p,g),extraHighlight:x.highlight,color:x.color})))))))))}const Xo=(e,o)=>({wrapper:(0,m.css)({label:"wrapper",position:"relative",display:"flex",justifyContent:"center",marginRight:e.spacing(1),height:"100%",backgroundColor:e.colors.background.primary,width:o?"160px":void 0,minWidth:o?"160px":void 0}),content:(0,m.css)({label:"content",marginLeft:e.spacing(.5),top:0}),buttonStyles:(0,m.css)({display:"flex","&:hover":{color:e.colors.text.primary,textDecoration:"underline"}}),toggleContentOutlineButton:(0,m.css)({"&:hover":{color:e.colors.text.primary},transform:o?"rotate(180deg)":"",marginRight:o?e.spacing(.5):void 0}),indentRoot:(0,m.css)({paddingLeft:e.spacing(4)}),indentChild:(0,m.css)({paddingLeft:o?e.spacing(7):e.spacing(4)}),itemWrapper:(0,m.css)({display:"flex",height:e.spacing(4),alignItems:"center"}),itemConnector:(0,m.css)({position:"relative",height:"100%",width:e.spacing(1.5),"&::before":{borderRight:`1px solid ${e.colors.border.medium}`,content:'""',height:"100%",left:48,position:"absolute",transform:"translateX(50%)"}}),firstItemConnector:(0,m.css)({"&::before":{top:e.spacing(1),height:`calc(100% - ${e.spacing(1)})`}}),lastItemConnector:(0,m.css)({"&::before":{height:`calc(100% - ${e.spacing(1)})`}}),justifyCenter:(0,m.css)({justifyContent:"center"}),sectionHighlighter:(0,m.css)({backgroundColor:e.colors.background.secondary})});function yt(e){return!!(e.children&&e.children.length>0&&(!e.mergeSingleChild||e.children.length!==1))}function vt(e,o){return e.children?.some(n=>n.id===o)}function ge({panelId:e,title:o,icon:n,customTopOffset:a,children:s,className:r,level:i="root",mergeSingleChild:l,type:d="scrollIntoView",onClick:c}){const{register:p,unregister:u}=bn()??{},v=(0,t.useRef)(null);return(0,t.useEffect)(()=>{if(!p||!u)return;const g=p({panelId:e,title:o,icon:n,ref:v.current,customTopOffset:a,level:i,mergeSingleChild:l,type:d});return()=>u(g)},[e,o,n,a,i,l,p,u,d,c]),t.createElement("div",{className:r,ref:v},s)}var qe=h(49785),bt=h(16817),Ge=h(42418),Et=h(82762),ie=h(88575),Ne=h(10354),xt=h(10860),We=h(29158),_o=h(91605),zt=h(67023),ea=h(18380),ta=h(23257),na=h.n(ta),oa=h(60029),Ie=h(21594),Ht=h(2864);const Cn=({label:e,tooltipText:o})=>t.createElement($e.B,{gap:1,direction:"row",wrap:"wrap",alignItems:"flex-start"},t.createElement(oa.J,null,e),t.createElement(ye.m,{content:o},t.createElement(ce.I,{name:"info-circle",size:"sm"}))),aa=({onSave:e,onCancel:o,fieldList:n,transformationToEdit:a})=>{const[s,r]=(0,t.useState)(void 0),[i,l]=(0,t.useState)({}),[d,c]=(0,t.useState)({mapValueDetails:{show:!1},expressionDetails:{show:!1}}),[p,u]=(0,t.useState)(!1),[v,g]=(0,t.useState)(!1),{getValues:E,control:f,register:b,watch:S}=(0,qe.mN)({defaultValues:(0,t.useMemo)(()=>{if(a){const y=n[a?.field];r(y),a?.expression&&u(!0);const x=(0,Ht.h)(a?.type);c({mapValueDetails:x.mapValueDetails,expressionDetails:x.expressionDetails});const T=(0,zt.k)({type:a?.type,expression:a?.expression,mapValue:a?.mapValue},y||"",a?.field);return l({...T}),g(!0),{type:a?.type,field:a?.field,mapValue:a?.mapValue,expression:a?.expression}}else return},[n,a])}),w=(0,t.useId)();return(0,t.useEffect)(()=>{const y=S(x=>{const T=x.expression;let R=!1;if(T!==void 0){R=!0;try{new RegExp(T)}catch{R=!1}}else R=!d.expressionDetails.show;u(R);let A=[];if(x.type){const O=(0,zt.k)({type:x.type,expression:R?T:"",mapValue:x.mapValue},n[x.field]||"",x.field);A=Object.keys(O),l(A.length>0?{...O}:{})}A.length===0||!R?g(!1):g(!0)});return()=>y.unsubscribe()},[n,d.expressionDetails.show,S]),t.createElement(Be.a,{isOpen:!0,title:`${a?"Edit":"Add"} transformation`,onDismiss:o,className:(0,m.css)({width:"700px"})},t.createElement("p",null,"A transformation extracts variables out of a single field. These variables will be available along with your field variables."),t.createElement(ie.D,{label:"Field"},t.createElement(qe.xI,{control:f,render:({field:{onChange:y,ref:x,...T}})=>t.createElement(Ie.l6,{...T,onChange:R=>{R.value&&(y(R.value),r(n[R.value]))},options:Object.entries(n).map(R=>({label:R[0],value:R[0]})),"aria-label":"field"}),name:"field"})),s&&t.createElement(t.Fragment,null,t.createElement("pre",null,t.createElement(na(),{textToHighlight:s,searchWords:[p?E("expression")??"":""],autoEscape:!1})),t.createElement(ie.D,{label:"Type"},t.createElement(qe.xI,{control:f,render:({field:{onChange:y,ref:x,...T}})=>t.createElement(Ie.l6,{...T,onChange:R=>{y(R.value);const A=(0,Ht.h)(R.value);c({mapValueDetails:A.mapValueDetails,expressionDetails:A.expressionDetails})},options:(0,Ht.j)(),"aria-label":"type"}),name:"type"})),d.expressionDetails.show&&t.createElement(ie.D,{label:d.expressionDetails.helpText?t.createElement(Cn,{label:"Expression",tooltipText:d.expressionDetails.helpText}):"Expression",htmlFor:`${w}-expression`,required:d.expressionDetails.required},t.createElement(Ne.p,{...b("expression"),id:`${w}-expression`})),d.mapValueDetails.show&&t.createElement(ie.D,{label:d.mapValueDetails.helpText?t.createElement(Cn,{label:"Variable Name",tooltipText:d.mapValueDetails.helpText}):"Variable Name",htmlFor:`${w}-mapValue`},t.createElement(Ne.p,{...b("mapValue"),id:`${w}-mapValue`})),Object.entries(i).length>0&&t.createElement(t.Fragment,null,"This transformation will add the following variables:",t.createElement("pre",null,Object.entries(i).map(y=>`\${${y[0]}} = ${y[1]?.value}
`)))),t.createElement(Be.a.ButtonRow,null,t.createElement(W.$n,{variant:"secondary",onClick:o,fill:"outline"},"Cancel"),t.createElement(W.$n,{variant:"primary",onClick:()=>e(E()),disabled:!v},a?"Edit transformation":"Add transformation to correlation")))},sa=({exploreId:e,correlations:o})=>{const n=(0,F.useDispatch)(),a=(0,N.of)(ra),s=(0,F.useSelector)(K.Qb),r=Object.values(s),{value:i,loading:l}=(0,bt.A)(async()=>await(0,ea.tZ)(r[0],r[1]),[r[0]?.datasourceInstance,r[0]?.queries[0].datasource,r[1]?.datasourceInstance,r[1]?.queries[0].datasource]),{register:d,watch:c,getValues:p,setValue:u}=(0,qe.mN)(),[v,g]=(0,t.useState)(!1),[E,f]=(0,t.useState)(!1),[b,S]=(0,t.useState)(!1),[w,y]=(0,t.useState)([]),[x,T]=(0,t.useState)(void 0),R=(0,F.useSelector)(K.vC),A=(0,t.useId)();return(0,t.useEffect)(()=>(n((0,G.am)({canSave:!0})),()=>{n((0,G.am)({canSave:!1}))}),[n]),(0,t.useEffect)(()=>{!l&&i!==void 0&&!R?.correlationDirty&&p("label")!==""&&u("label",i)},[R?.correlationDirty,i,p,l,u]),(0,t.useEffect)(()=>{const O=c(k=>{let V=R?.correlationDirty||!1,z=k.description||"";!V&&(k.label!==i||z!=="")?V=!0:V&&k.label===i&&z.trim()===""&&(V=!1),n((0,G.am)({label:k.label,description:k.description,correlationDirty:V}))});return()=>O.unsubscribe()},[R?.correlationDirty,i,n,c]),(0,t.useEffect)(()=>{const O=!R?.correlationDirty&&w.length>0?!0:R?.correlationDirty;n((0,G.am)({transformations:w,correlationDirty:O}));let k={};w.forEach(V=>{const z=(0,zt.k)({type:V.type,expression:V.expression,mapValue:V.mapValue},o.vars[V.field],V.field);Object.keys(z).forEach(H=>{k[H]=z[H]?.value})}),n((0,we.nE)({exploreId:e,correlationEditorHelperData:{resultField:o.resultField,origVars:o.origVars,vars:{...o.origVars,...k}}}))},[n,w]),t.createElement(t.Fragment,null,b&&t.createElement(aa,{onCancel:()=>{T(void 0),S(!1)},onSave:O=>{if(x!==void 0){const k=[...w];k[x]=O,y(k),T(void 0)}else y([...w,O]);S(!1)},fieldList:o.origVars,transformationToEdit:x!==void 0?w[x]:void 0}),t.createElement(Ge.F,{title:"Correlation details",severity:"info"},"The correlation link will appear by the ",t.createElement("code",null,o.resultField)," field. You can use the following variables to set up your correlations:",t.createElement("pre",null,Object.entries(o.vars).map(O=>`\${${O[0]}} = ${O[1]}
`)),t.createElement(Et.S,{collapsible:!0,isOpen:v,onToggle:()=>{g(!v)},label:t.createElement($e.B,{gap:1,direction:"row",wrap:"wrap",alignItems:"center"},"Label / Description",!v&&!l&&t.createElement("span",{className:a.labelCollapseDetails},`Label: ${p("label")||i}`))},t.createElement(ie.D,{label:"Label",htmlFor:`${A}-label`},t.createElement(Ne.p,{...d("label"),id:`${A}-label`,onBlur:()=>{p("label")===""&&i!==void 0&&u("label",i)}})),t.createElement(ie.D,{label:"Description",htmlFor:`${A}-description`},t.createElement(Ne.p,{...d("description"),id:`${A}-description`}))),t.createElement(Et.S,{collapsible:!0,isOpen:E,onToggle:()=>{f(!E)},label:t.createElement($e.B,{gap:1,direction:"row",wrap:"wrap",alignItems:"center"},"Transformations",t.createElement(ye.m,{content:"A transformation extracts one or more variables out of a single field."},t.createElement(ce.I,{name:"info-circle",size:"sm"})))},t.createElement(W.$n,{variant:"secondary",fill:"outline",onClick:()=>{S(!0)},className:a.transformationAction},"Add transformation"),w.map((O,k)=>{const{type:V,field:z,expression:H,mapValue:te}=O,ee=[(te??"").length>0?`Variable name: ${te}`:void 0,(H??"").length>0?t.createElement(t.Fragment,null,"Expression: ",t.createElement("code",null,H)):void 0].filter(oe=>oe);return t.createElement(xt.Z,{key:`trans-${k}`},t.createElement(xt.Z.Heading,null,z,": ",V),ee.length>0&&t.createElement(xt.Z.Meta,{className:a.transformationMeta},ee),t.createElement(xt.Z.SecondaryActions,null,t.createElement(We.K,{key:"edit",name:"edit","aria-label":"edit transformation",onClick:()=>{T(k),S(!0)}}),t.createElement(_o.e,{"aria-label":"delete transformation",onConfirm:()=>y(w.filter((oe,L)=>k!==L)),closeOnConfirm:!0})))}))))},ra=e=>({labelCollapseDetails:(0,m.css)({marginLeft:e.spacing(2),...e.typography.bodySmall,fontStyle:"italic"}),transformationAction:(0,m.css)({marginBottom:e.spacing(2)}),transformationMeta:(0,m.css)({alignItems:"baseline"})});var be=h(47232),ia=h(24308),la=h(79041),Re=h(91052),ca=h(15162),da=h(33368);function ua({width:e,height:o,timeZone:n,state:a,pluginId:s,frames:r,absoluteRange:i,splitOpenFn:l,eventBus:d}){const c=(0,t.useMemo)(()=>({from:(0,be.KQ)(i.from),to:(0,be.KQ)(i.to),raw:{from:(0,be.KQ)(i.from),to:(0,be.KQ)(i.to)}}),[i.from,i.to]),p=(0,ca.d4)(s),v={dataLinkPostProcessor:(0,da.h)(l,c),eventBus:d,eventsScope:"explore"};return t.createElement(la.XF,{value:v},t.createElement(Re.NR,{title:p.name,width:e,height:o,loadingState:a},(g,E)=>t.createElement(ia.m,{data:{series:r,state:a,timeRange:c},pluginId:s,title:"",width:g,height:E,timeZone:n})))}var pa=h(67570),ha=h(95247),ne=h(27746),$t=h(19727),St=h(11134),ma=h(75269),ga=h(51612),Bt=h(76698),ue=h(64756),Vt=h(10096),wn=h(81862),Rn=h(85858),fa=h(25573),Tn=h(80582);function ya(e){const{onClick:o,isSynced:n}=e,a=()=>{const{isSynced:s}=e,r=s?"Unsync all views":"Sync all views to this time range";return t.createElement(t.Fragment,null,r)};return t.createElement(ye.m,{content:a,placement:"bottom"},t.createElement(ne.I,{icon:"link",variant:n?"active":"canvas","aria-label":n?"Synced times":"Unsynced times",onClick:o}))}class va extends t.Component{constructor(){super(...arguments),this.onMoveTimePicker=o=>{const{range:n,onChangeTime:a,timeZone:s}=this.props,{from:r,to:i}=(0,Tn.Wb)(o,n),l={from:(0,be.oZ)(s,r),to:(0,be.oZ)(s,i)};a(l)},this.onMoveForward=()=>this.onMoveTimePicker(1),this.onMoveBack=()=>this.onMoveTimePicker(-1),this.onChangeTimePicker=o=>{const n=Rn.isMathString(o.raw.from)?o.raw.from:o.from,a=Rn.isMathString(o.raw.to)?o.raw.to:o.to;this.props.onChangeTime({from:n,to:a}),(0,M.rR)("grafana_explore_time_picker_time_range_changed",{timeRangeFrom:n,timeRangeTo:a})},this.onZoom=()=>{const{range:o,onChangeTime:n,timeZone:a}=this.props,{from:s,to:r}=(0,Tn.Zk)(o,2),i={from:(0,be.oZ)(a,s),to:(0,be.oZ)(a,r)};n(i)}}render(){const{range:o,timeZone:n,fiscalYearStartMonth:a,splitted:s,syncedTimes:r,onChangeTimeSync:i,hideText:l,onChangeTimeZone:d,onChangeFiscalYearStartMonth:c}=this.props,p=s?t.createElement(ya,{onClick:i,isSynced:r}):void 0,u={value:o,timeZone:n,fiscalYearStartMonth:a,onMoveBackward:this.onMoveBack,onMoveForward:this.onMoveForward,onZoom:this.onZoom,hideText:l};return t.createElement(fa.m,{isOnCanvas:!0,...u,timeSyncButton:p,isSynced:r,widthOverride:s?window.innerWidth/2:void 0,onChange:this.onChangeTimePicker,onChangeTimeZone:d,onChangeFiscalYearStartMonth:c})}}var Ln=h(86634);function ba(e){const o=(0,t.useRef)(null),{start:n,pause:a,resume:s,isLive:r,isPaused:i,stop:l,splitted:d}=e,c=r&&!i?"active":"canvas",p=r?i?s:a:n;return t.createElement($t.e,null,t.createElement(ye.m,{content:r&&!i?t.createElement(t.Fragment,null,"Pause the live stream"):t.createElement(t.Fragment,null,"Start live stream your logs"),placement:"bottom"},t.createElement(ne.I,{iconOnly:d,variant:c,icon:!r||i?"play":"pause",onClick:p},r&&i?"Paused":"Live")),t.createElement(Ln.A,{mountOnEnter:!0,unmountOnExit:!0,timeout:100,in:r,classNames:{enter:Ct.stopButtonEnter,enterActive:Ct.stopButtonEnterActive,exit:Ct.stopButtonExit,exitActive:Ct.stopButtonExitActive},nodeRef:o},t.createElement(ye.m,{content:t.createElement(t.Fragment,null,"Stop and exit the live stream"),placement:"bottom"},t.createElement(ne.I,{ref:o,variant:c,onClick:l,icon:"square-shape"}))))}const Ct={stopButtonEnter:(0,m.css)({label:"stopButtonEnter",width:0,opacity:0,overflow:"hidden"}),stopButtonEnterActive:(0,m.css)({label:"stopButtonEnterActive",opacity:1,width:"32px"}),stopButtonExit:(0,m.css)({label:"stopButtonExit",width:"32px",opacity:1,overflow:"hidden"}),stopButtonExitActive:(0,m.css)({label:"stopButtonExitActive",opacity:0,width:0})};var fe=h(38138),Ke=h(83122),ke=(e=>(e.QueryLibrary="Query library",e.RichHistory="Query history",e.Starred="Starred",e.Settings="Settings",e))(ke||{});const In=(0,t.createContext)({selectedTab:void 0,setSelectedTab:()=>{},queryLibraryAvailable:!1,drawerOpened:!1,setDrawerOpened:()=>{}});function Ze(){return(0,t.useContext)(In)}function Ea({children:e}){const o=B.$.featureToggles.queryLibrary===!0,[n,a]=(0,t.useState)(o?"Query library":void 0),[s,r]=(0,t.useState)(!1),i=(0,F.useSelector)(K.i6);return(0,t.useEffect)(()=>{i&&!o&&a(i.starredTabAsFirstTab?"Starred":"Query history")},[i,a,o]),t.createElement(In.Provider,{value:{queryLibraryAvailable:o,selectedTab:n,setSelectedTab:a,drawerOpened:s,setDrawerOpened:r}},e)}const wt={queryLibrary:(0,C.t)("explore.rich-history.query-library","Query library"),queryHistory:(0,C.t)("explore.rich-history.query-history","Query history")};function xa({variant:e}){const{selectedTab:o,setSelectedTab:n,queryLibraryAvailable:a,drawerOpened:s,setDrawerOpened:r}=Ze(),i=(0,N.of)(Sa);if(!a)return;function l(c){n(c),r(!1),r(!0)}const d=t.createElement(fe.W,null,t.createElement(fe.W.Item,{label:wt.queryLibrary,onClick:()=>l(ke.QueryLibrary)}),t.createElement(fe.W.Item,{label:wt.queryHistory,onClick:()=>l(ke.RichHistory)}));return t.createElement($t.e,null,t.createElement(ne.I,{icon:"book",variant:s?"active":"canvas",onClick:()=>r(!s),"aria-label":o},e==="full"?o:void 0),s?t.createElement(W.$n,{className:i.close,variant:"secondary",icon:"times",onClick:()=>r(!1)}):t.createElement(Ke.m,{overlay:d},t.createElement(ne.I,{className:i.toggle,variant:"canvas",icon:"angle-down"})))}const Sa=()=>({toggle:(0,m.css)({width:"36px"}),close:(0,m.css)({width:"36px","> svg":{position:"relative",left:2}})});var Ca=h(59093),wa=h(15068),Wt=h(7030),Pe=h(96192);const Ra={key:"copy-link",label:(0,C.t)("explore.toolbar.copy-shortened-link","Copy shortened URL"),icon:"share-alt",getUrl:()=>{},shorten:!0,absTime:!1};function Ta(){const e=(0,F.useSelector)(K.Qb),[o,n]=(0,t.useState)(!1),[a,s]=(0,t.useState)(Ra),r=(d,c,p)=>{d?((0,Wt.VP)(p||h.g.location.href),(0,M.rR)("grafana_explore_shortened_link_clicked",{isAbsoluteTime:c})):((0,je.uJ)(p!==void 0?`${window.location.protocol}//${window.location.host}${B.$.appSubUrl}${p}`:h.g.location.href),(0,M.rR)("grafana_explore_copy_link_clicked",{isAbsoluteTime:c}))},i=[{key:"normal",label:(0,C.t)("explore.toolbar.copy-links-normal-category","Normal URL links"),items:[{key:"copy-shortened-link",icon:"link",label:(0,C.t)("explore.toolbar.copy-shortened-link","Copy shortened URL"),getUrl:()=>{},shorten:!0,absTime:!1},{key:"copy-link",icon:"link",label:(0,C.t)("explore.toolbar.copy-link","Copy URL"),getUrl:()=>{},shorten:!1,absTime:!1}]},{key:"timesync",label:(0,C.t)("explore.toolbar.copy-links-absolute-category","Time-sync URL links (share with time range intact)"),items:[{key:"copy-short-link-abs-time",icon:"clock-nine",label:(0,C.t)("explore.toolbar.copy-shortened-link-abs-time","Copy absolute shortened URL"),shorten:!0,getUrl:()=>(0,Pe._O)(e),absTime:!0},{key:"copy-link-abs-time",icon:"clock-nine",label:(0,C.t)("explore.toolbar.copy-link-abs-time","Copy absolute URL"),shorten:!1,getUrl:()=>(0,Pe._O)(e),absTime:!0}]}],l=t.createElement(fe.W,null,i.map(d=>t.createElement(Ca.r,{key:d.key,label:d.label},d.items.map(c=>t.createElement(fe.W.Item,{key:c.key,label:c.label,icon:c.icon,onClick:()=>{const p=c.getUrl();r(c.shorten,c.absTime,p),s(c)}})))));return t.createElement(wa.U,null,t.createElement($e.B,{gap:0,direction:"row",alignItems:"center",wrap:"nowrap"},t.createElement(ne.I,{tooltip:a.label,icon:a.icon,iconOnly:!0,narrow:!0,onClick:()=>{const d=a.getUrl();r(a.shorten,a.absTime,d)},"aria-label":(0,C.t)("explore.toolbar.copy-shortened-link","Copy shortened URL")}),t.createElement(Ke.m,{overlay:l,placement:"bottom-end",onVisibleChange:n},t.createElement(ne.I,{narrow:!0,isOpen:o,"aria-label":(0,C.t)("explore.toolbar.copy-shortened-link-menu","Open copy link options")}))))}var La=h(74135),Ia=h(3197),Fa=h(24401),Oa=h(30973);const Da=(0,t.lazy)(()=>h.e(4787).then(h.bind(h,74787)).then(({AddToDashboard:e})=>({default:e})));function Aa(e){const{exploreId:o}=e,[n,a]=(0,t.useState)(),[s,r]=(0,t.useState)(!1),i=Na(e),{extensions:l}=(0,Ia.vl)({extensionPointId:La.S.ExploreToolbarAction,context:i,limitPerPlugin:3}),d=(0,K.qq)(o),c=(0,F.useSelector)(d)?.queries?.length;if(l.length<=1)return lt.TP.hasPermission(F.AccessControlAction.DashboardsCreate)||lt.TP.hasPermission(F.AccessControlAction.DashboardsWrite)?t.createElement(t.Suspense,{fallback:null},t.createElement(Da,{exploreId:o})):null;const p=t.createElement(Oa.w,{extensions:l,onSelect:a});return t.createElement(t.Fragment,null,t.createElement(Ke.m,{onVisibleChange:r,placement:"bottom-start",overlay:p},t.createElement(ne.I,{"aria-label":"Add",disabled:!c,variant:"canvas",isOpen:s},"Add")),!!n&&!!n.path&&t.createElement(Fa.s,{path:n.path,title:n.title,onDismiss:()=>a(void 0)}))}function Na(e){const{exploreId:o,timeZone:n}=e,s=(0,F.useSelector)(K.vC)?.editorMode||!1,{queries:r,queryResponse:i,range:l}=(0,F.useSelector)((0,K.qq)(o)),d=(0,F.useSelector)((0,K.Jr)(o)),c=r.map(v=>v?.datasource?.uid).filter(v=>v!==void 0),p=[...new Set(c)].length,u=lt.TP.hasPermission(F.AccessControlAction.DataSourcesWrite);return(0,t.useMemo)(()=>({exploreId:o,targets:r,data:i,timeRange:l.raw,timeZone:(0,yn.O)({timeZone:n}),shouldShowAddCorrelation:B.$.featureToggles.correlations===!0&&u&&!s&&d&&p===1}),[o,r,i,l.raw,n,u,s,d,p])}var pe=h(89224);function ka(e){const o=(0,F.useDispatch)(),n=(0,t.useCallback)(()=>{o((0,j.qk)({exploreId:e,isPaused:!0}))},[e,o]),a=(0,t.useCallback)(()=>{o((0,j.qk)({exploreId:e,isPaused:!1}))},[e,o]),s=(0,t.useCallback)(()=>{n(),o((0,pe.hO)({exploreId:e,refreshInterval:St.cC.offOption.value})),o((0,j.Od)({exploreId:e}))},[e,o,n]),r=(0,t.useCallback)(()=>{o((0,pe.hO)({exploreId:e,refreshInterval:St.cC.liveOption.value}))},[e,o]),i=(0,t.useCallback)(()=>{o((0,j.rR)({exploreId:e}))},[e,o]);return{pause:n,resume:a,stop:s,start:r,clear:i}}function Fn(e){const o=ka(e.exploreId);return e.children(o)}const Pa=(e,o)=>({rotateIcon:(0,m.css)({"> div > svg":{transform:"rotate(180deg)"}}),toolbarButton:(0,m.css)({display:"flex",justifyContent:"center",marginRight:e.spacing(.5),width:o&&e.spacing(6)})});function Ma({exploreId:e,onChangeTime:o,onContentOutlineToogle:n,isContentOutlineOpen:a}){const s=(0,ue.wA)(),r=(0,ue.d4)(K.pF),i=(0,N.of)(Pa,r),l=(0,ue.d4)(I=>(0,ft.O)(I.user)),d=(0,ue.d4)(I=>(0,ft.q)(I.user)),{refreshInterval:c,datasourceInstance:p,range:u,isLive:v,isPaused:g,syncedTimes:E}=(0,ue.d4)(I=>({...(0,_.pick)(I.explore.panes[e],"refreshInterval","datasourceInstance","range","isLive","isPaused"),syncedTimes:I.explore.syncedTimes}),me.shallowEqual),f=(0,ue.d4)((0,j.h1)(e)),b=(0,ue.d4)(I=>I.explore.largerExploreId===e),S=(0,ue.d4)(I=>r||I.explore.panes[e].containerWidth<1210),w=(0,ue.d4)(I=>I.explore.panes[e].containerWidth<(r?700:800)),y=(0,ue.d4)(K.K6),x=(0,ue.d4)(K.vC),T=x?.editorMode||!1,R=(0,ue.d4)((0,K.Jr)(e)),A=(0,t.useMemo)(()=>R&&b||!R&&!b,[R,b]),O=f?(0,C.t)("explore.toolbar.refresh-picker-cancel","Cancel"):(0,C.t)("explore.toolbar.refresh-picker-run","Run query"),k=async I=>{T?x?.correlationDirty||x?.queryEditorDirty?s((0,G.am)({isExiting:!0,postConfirmAction:{exploreId:e,action:Bt.IW.CHANGE_DATASOURCE,changeDatasourceUid:I.uid,isActionLeft:R}})):(R&&y.forEach(Q=>{s((0,we.nE)({exploreId:Q[0],correlationEditorHelperData:void 0}))}),s((0,Ae.wh)({exploreId:e,datasource:I.uid,options:{importQueries:!0}}))):s((0,Ae.wh)({exploreId:e,datasource:I.uid,options:{importQueries:!0}}))},V=(I=!1)=>s(I?(0,j.hS)(e):(0,j.Od)({exploreId:e})),z=I=>s((0,wn.Cj)(I)),H=()=>{s((0,G.ve)()),(0,M.rR)("grafana_explore_split_view_opened",{origin:"menu"})},te=()=>{T?x?.correlationDirty||x?.queryEditorDirty?s((0,G.am)({isExiting:!0,postConfirmAction:{exploreId:e,action:Bt.IW.CLOSE_PANE,isActionLeft:R}})):(y.forEach(I=>{s((0,we.nE)({exploreId:I[0],correlationEditorHelperData:void 0}))}),s((0,G.J8)(e)),(0,M.rR)("grafana_explore_split_view_closed")):(s((0,G.J8)(e)),(0,M.rR)("grafana_explore_split_view_closed"))},ee=()=>{s(b?(0,G.JA)():(0,G.tP)({exploreId:e}))},oe=()=>{s((0,pe.iO)(e))},L=I=>s((0,wn.c1)(I)),D=I=>{s((0,pe.hO)({exploreId:e,refreshInterval:I}))},P=[t.createElement(Ta,{key:"share"}),t.createElement("div",{style:{flex:1},key:"spacer0"})];return t.createElement("div",null,c&&t.createElement(pa.u,{func:V,interval:c,loading:f}),t.createElement("div",null,t.createElement(ma.H,{actions:P})),t.createElement(ha.d,{"aria-label":(0,C.t)("explore.toolbar.aria-label","Explore toolbar"),leftItems:[B.$.featureToggles.exploreContentOutline&&t.createElement(ne.I,{key:"content-outline",variant:"canvas",tooltip:"Content outline",icon:"list-ui-alt",iconOnly:r,onClick:n,"aria-expanded":a,"aria-controls":a?"content-outline-container":void 0,className:i.toolbarButton},"Outline"),t.createElement(ga.s,{key:`${e}-ds-picker`,mixed:!T,onChange:k,current:p?.getRef(),hideTextValue:w,width:w?8:void 0})].filter(Boolean),forceShowLeftItems:!0},[t.createElement(xa,{key:"queryLibrary",variant:r?"compact":"full"}),r?t.createElement($t.e,{key:"split-controls"},t.createElement(ne.I,{variant:"canvas",tooltip:b?(0,C.t)("explore.toolbar.split-narrow","Narrow pane"):(0,C.t)("explore.toolbar.split-widen","Widen pane"),onClick:ee,icon:b?"gf-movepane-left":"gf-movepane-right",iconOnly:!0,className:(0,m.cx)(A&&i.rotateIcon)}),t.createElement(ne.I,{tooltip:(0,C.t)("explore.toolbar.split-close-tooltip","Close split pane"),onClick:te,icon:"times",variant:"canvas"},t.createElement(C.x6,{i18nKey:"explore.toolbar.split-close"}," Close "))):t.createElement(ne.I,{variant:"canvas",key:"split",tooltip:(0,C.t)("explore.toolbar.split-tooltip","Split the pane"),onClick:H,icon:"columns",disabled:v},t.createElement(C.x6,{i18nKey:"explore.toolbar.split-title"},"Split")),t.createElement(Aa,{key:"toolbar-extension-point",exploreId:e,timeZone:l}),!v&&t.createElement(va,{key:"timeControls",exploreId:e,range:u,timeZone:l,fiscalYearStartMonth:d,onChangeTime:o,splitted:r,syncedTimes:E,onChangeTimeSync:oe,hideText:S,onChangeTimeZone:z,onChangeFiscalYearStartMonth:L}),t.createElement(St.cC,{key:"refreshPicker",onIntervalChanged:D,value:c,isLoading:f,text:S?void 0:O,tooltip:S?O:void 0,intervals:Vt.TP.getValidIntervals(St.cb),isLive:v,onRefresh:()=>V(f),noIntervalPicker:v,primary:!0,width:(S?35:108)+"px"}),p?.meta.streaming&&t.createElement(Fn,{key:"liveControls",exploreId:e},I=>{const Q={...I,start:()=>{(0,M.rR)("grafana_explore_logs_live_tailing_clicked",{datasourceType:p?.type}),I.start()}};return t.createElement(ba,{splitted:r,isLive:v,isPaused:g,start:Q.start,pause:Q.pause,resume:Q.resume,stop:Q.stop})})].filter(Boolean)))}var Ye=h(41987),za=h(85194);function Rt(e,o={}){(0,M.rR)(`grafana_flamegraph_${e}`,{app:Ye.Jk.Unknown,grafana_version:B.$.buildInfo.version,...o})}const Ha=e=>{const o=(0,N.of)(n=>$a(n));return t.createElement("div",{className:o.container},t.createElement(za.A,{data:e.dataFrames[0],stickyHeader:!0,getTheme:()=>B.$.theme2,onTableSymbolClick:()=>Rt("table_item_selected"),onViewSelected:n=>Rt("view_selected",{view:n}),onTextAlignSelected:n=>Rt("text_align_selected",{align:n}),onTableSort:n=>Rt("table_sort_selected",{sort:n}),disableCollapsing:!B.$.featureToggles.flameGraphItemCollapsing}))},$a=e=>({container:(0,m.css)({background:e.colors.background.primary,display:"flow-root",padding:e.spacing(0,1,1,1),border:`1px solid ${e.components.panel.borderColor}`,borderRadius:e.shape.radius.default})});var Ba=h(72519),On=h(84140),U=h(52622),Qt=h(72724),Va=h(85492),Wa=h(77020),Ee=h(91002),Qa=h(10940),ja=h(97814);const Dn=150,Ua=({resetKey:e,humanize:o,className:n})=>{const[a,s]=(0,t.useState)(0);return(0,Qa.A)(()=>s(a+Dn),Dn),(0,t.useEffect)(()=>s(0),[e]),t.createElement(ja.g,{timeInMs:a,className:n,humanize:o})};var qa=h(34028);const Ga=e=>({logsRowsLive:(0,m.css)`
    label: logs-rows-live;
    font-family: ${e.typography.fontFamilyMonospace};
    font-size: ${e.typography.bodySmall.fontSize};
    display: flex;
    flex-flow: column nowrap;
    height: 60vh;
    overflow-y: scroll;
    :first-child {
      margin-top: auto !important;
    }
  `,logsRowFade:(0,m.css)`
    label: logs-row-fresh;
    color: ${e.colors.text};
    background-color: ${(0,On.A)(e.colors.info.transparent).setAlpha(.25).toString()};
    animation: fade 1s ease-out 1s 1 normal forwards;
    @keyframes fade {
      from {
        background-color: ${(0,On.A)(e.colors.info.transparent).setAlpha(.25).toString()};
      }
      to {
        background-color: transparent;
      }
    }
  `,logsRowsIndicator:(0,m.css)`
    font-size: ${e.typography.h6.fontSize};
    padding-top: ${e.spacing(1)};
    display: flex;
    align-items: center;
  `,button:(0,m.css)`
    margin-right: ${e.spacing(1)};
  `,fullWidth:(0,m.css)`
    width: 100%;
  `});class Ka extends t.PureComponent{constructor(o){super(o),this.liveEndDiv=null,this.scrollContainerRef=t.createRef(),this.onScroll=n=>{const{isPaused:a,onPause:s}=this.props,{scrollTop:r,clientHeight:i,scrollHeight:l}=n.currentTarget;l-(r+i)>=5&&!a&&s()},this.rowsToRender=()=>{const{isPaused:n}=this.props;let{logRowsToRender:a=[]}=this.state;return n||(a=(0,Ee.oR)(a,U.uH.Ascending).slice(-100)),a},this.state={logRowsToRender:o.logRows}}static getDerivedStateFromProps(o,n){return o.isPaused&&o.clearedAtIndex?{logRowsToRender:(0,qa.pg)(o.clearedAtIndex,n.logRowsToRender)}:o.isPaused?null:{logRowsToRender:o.logRows}}render(){const{theme:o,timeZone:n,onPause:a,onResume:s,onClear:r,isPaused:i}=this.props,l=Ga(o),{logsRow:d,logsRowLocalTime:c,logsRowMessage:p}=(0,Wa.D)(o);return t.createElement("div",null,t.createElement("table",{className:l.fullWidth},t.createElement("tbody",{onScroll:i?void 0:this.onScroll,className:l.logsRowsLive,ref:this.scrollContainerRef},this.rowsToRender().map(u=>t.createElement("tr",{className:(0,m.cx)(d,l.logsRowFade),key:u.uid},t.createElement("td",{className:c},(0,Qt.LE)(u.timeEpochMs,{timeZone:n})),t.createElement("td",{className:p},u.hasAnsi?t.createElement(Va.$,{value:u.raw}):u.entry))),t.createElement("tr",{ref:u=>{this.liveEndDiv=u,this.liveEndDiv&&this.scrollContainerRef.current?.scrollTo&&!i&&this.scrollContainerRef.current?.scrollTo(0,this.scrollContainerRef.current.scrollHeight)}}))),t.createElement("div",{className:l.logsRowsIndicator},t.createElement(W.$n,{icon:i?"play":"pause",variant:"secondary",onClick:i?s:a,className:l.button},i?"Resume":"Pause"),t.createElement(W.$n,{icon:"trash-alt",variant:"secondary",onClick:r,className:l.button},"Clear logs"),t.createElement(W.$n,{icon:"square-shape",variant:"secondary",onClick:this.props.stopLive,className:l.button},"Exit live mode"),i||this.rowsToRender().length>0&&t.createElement("span",null,"Last line received: ",t.createElement(Ua,{resetKey:this.props.logRows,humanize:!0})," ago")))}}const Za=(0,N.cV)(Ka);var Je=h(41811),An=h(69129),Nn=h(76885),Xe=h(65879),_e=h(94354),Ya=h(39268),xe=h(14186),Fe=h(15292),Ja=h(44895),ae=h(33390),kn=h(81073);const Xa=({children:e,loading:o,loadMoreLogs:n,range:a,rows:s,scrollElement:r,sortOrder:i,timeZone:l,topScrollEnabled:d=!1})=>{const[c,p]=(0,t.useState)(!1),[u,v]=(0,t.useState)(!1),[g,E]=(0,t.useState)(!1),[f,b]=(0,t.useState)(!1),S=(0,t.useRef)(s),w=(0,t.useRef)(r?.scrollTop||0);(0,t.useEffect)(()=>{p(!1),v(!1)},[a,s,i]),(0,t.useEffect)(()=>{o||(E(!1),b(!1))},[o]),(0,t.useEffect)(()=>{f&&r&&r.scrollTo(0,r.scrollHeight-r.clientHeight)},[f,r]),(0,t.useEffect)(()=>{s!==S.current&&s.length===S.current.length&&(g||f)&&(i===U.uH.Descending&&f?v(!0):i===U.uH.Ascending&&g&&p(!0)),S.current=s},[f,s,i,g]),(0,t.useEffect)(()=>{if(!r||!n)return;function T(O){if(!r||!n||!s.length||o||!B.$.featureToggles.logsInfiniteScrolling)return;O.stopImmediatePropagation();const k=ts(O,r,w.current);w.current=r.scrollTop,k!==0&&(k===-1&&d?R():k===1&&A())}function R(){const O=ns(Mn(s),a,l,i);if(!O){p(!0);return}p(!1),n?.(O),E(!0),(0,M.rR)("grafana_logs_infinite_scrolling",{direction:"top",sort_order:i})}function A(){const O=os(Mn(s),a,l,i);if(!O){v(!0);return}v(!1),n?.(O),b(!0),(0,M.rR)("grafana_logs_infinite_scrolling",{direction:"bottom",sort_order:i})}return r.addEventListener("scroll",T),r.addEventListener("wheel",T),()=>{r.removeEventListener("scroll",T),r.removeEventListener("wheel",T)}},[n,o,a,s,r,i,l,d]);const y=i===U.uH.Descending&&(0,Xe.isRelativeTime)(a.raw.to),x=i===U.uH.Ascending&&(0,Xe.isRelativeTime)(a.raw.to);return t.createElement(t.Fragment,null,g&&t.createElement(kn.I,{adjective:i===U.uH.Descending?"newer":"older"}),!y&&c&&Pn,e,!x&&u&&Pn,f&&t.createElement(kn.I,{adjective:i===U.uH.Descending?"older":"newer"}))},_a={messageContainer:(0,m.css)({textAlign:"center",padding:.25})},Pn=t.createElement("div",{className:_a.messageContainer,"data-testid":"end-of-range"},"End of the selected time range.");var es=(e=>(e[e.Top=-1]="Top",e[e.Bottom=1]="Bottom",e[e.NoScroll=0]="NoScroll",e))(es||{});function ts(e,o,n){if(o.scrollHeight<=o.clientHeight)return 0;const a=e instanceof WheelEvent?e.deltaY:o.scrollTop-n;if(a===0)return 0;const s=a<0?-1:1;return(s===-1?o.scrollTop:o.scrollHeight-o.scrollTop-o.clientHeight)<=1?s:0}function Mn(e){const o=e[0].timeEpochMs,n=e[e.length-1].timeEpochMs;return n<o?{from:n,to:o}:{from:o,to:n}}function zn(e,o){return{from:o.from.valueOf(),to:e.from}}function Hn(e,o,n){return o=jt(o,n),{from:e.to,to:o.to.valueOf()}}const Tt=1e3;function ns(e,o,n,a){return a===U.uH.Descending?(o=jt(o,n),o.to.valueOf()-e.to>Tt?Hn(e,o,n):void 0):Math.abs(o.from.valueOf()-e.from)>Tt?zn(e,o):void 0}function os(e,o,n,a){return a===U.uH.Descending?Math.abs(o.from.valueOf()-e.from)>Tt?zn(e,o):void 0:(o=jt(o,n),o.to.valueOf()-e.to>Tt?Hn(e,o,n):void 0)}function jt(e,o){return(0,Xe.isRelativeTimeRange)(e.raw)?(0,Xe.convertRawToRange)(e.raw,o):e}var Oe=h(99140),$n=h(14647),as=h(81166),et=h(69147),Bn=h(39590);function ss({feedbackUrl:e}){const o=(0,N.of)(rs);return t.createElement($e.B,null,t.createElement("a",{href:e,className:o.link,title:"The logs table is new, please let us know how we can improve it",target:"_blank",rel:"noreferrer noopener"},t.createElement(ce.I,{name:"comment-alt-message"})," Give feedback"))}function rs(e){return{link:(0,m.css)({color:e.colors.text.secondary,fontSize:e.typography.bodySmall.fontSize,":hover":{color:e.colors.text.link}})}}var is=h(4213),ls=h.n(is),Vn=h(75505),Wn=h(2514),Qn=h(18358),jn=h(93463),cs=h(40455);const Un=e=>({metaContainer:(0,m.css)({flex:1,color:e.colors.text.secondary,marginBottom:e.spacing(2),minWidth:"30%",display:"flex",flexWrap:"wrap"}),metaItem:(0,m.css)({marginRight:e.spacing(2),marginTop:e.spacing(.5),display:"flex",alignItems:"center",".logs-meta-item__error":{color:e.colors.error.text}}),metaLabel:(0,m.css)({marginRight:`calc(${e.spacing(2)} / 2)`,fontSize:e.typography.bodySmall.fontSize,fontWeight:e.typography.fontWeightMedium}),metaValue:(0,m.css)({fontFamily:e.typography.fontFamilyMonospace,fontSize:e.typography.bodySmall.fontSize})}),ds=(0,t.memo)(function(o){const n=(0,N.of)(Un),{label:a,value:s}=o;return t.createElement("div",{"data-testid":"meta-info-text-item",className:n.metaItem},a&&t.createElement("span",{className:n.metaLabel},a,":"),t.createElement("span",{className:n.metaValue},s))}),Ut=(0,t.memo)(function(o){const n=(0,N.of)(Un),{metaItems:a}=o;return t.createElement("div",{className:n.metaContainer,"data-testid":"meta-info-text"},a.map((s,r)=>t.createElement(ds,{key:`${r}-${s.label}`,label:s.label,value:s.value})))});var qn=h(14236),Lt=h(90708),tt=h(11261),Gn=h(41260),qt=h(77093);function us(e){const{timeZone:o,splitOpen:n,range:a,logsSortOrder:s,width:r,dataFrame:i,columnsWithMeta:l,logsFrame:d}=e,[c,p]=(0,t.useState)(void 0),u=d?.timeField.index,v=(0,t.useCallback)(E=>{if(!E.length)return E;const f=(0,qn.ES)(E,u,s===U.uH.Descending),[b]=(0,Lt.we)({data:[f],timeZone:o,theme:B.$.theme2,replaceVariables:S=>S,fieldConfig:{defaults:{custom:{}},overrides:[]}});for(const S of b.fields)S.getLinks=w=>(0,Pe.QL)({field:S,rowIndex:w.valueRowIndex,splitOpenFn:n,range:a,dataFrame:f}),S.config={...S.config,custom:{inspect:!0,filterable:!0,width:gs(S),...S.config.custom},filterable:ps(S,d?.bodyField.name??"",d?.timeField.name??"")},S.type=S.type===tt.PU.string?(0,qn.dF)(S)??tt.PU.string:S.type;return b},[s,o,n,a,d?.bodyField.name,d?.timeField.name,u]);if((0,t.useEffect)(()=>{(async()=>{if(!d?.timeField.name||!d?.bodyField.name){p(void 0);return}const f=Kn(i);let b=hs(l);const S=ms(b);if(S?f.push(S):f.push({id:"organize",options:{indexByName:{[d.bodyField.name]:0,[d.timeField.name]:1},includeByName:{[d.bodyField.name]:!0,[d.timeField.name]:!0}}}),f.length>0){const w=await(0,Vn.s)((0,Wn.m)(f,[i])),y=v(w[0]);p(y)}else p(v(i))})()},[l,i,s,v,d?.bodyField.name,d?.timeField.name]),!c)return null;const g=E=>{const{value:f,key:b,operator:S}=E,{onClickFilterLabel:w,onClickFilterOutLabel:y}=e;!w||!y||(S===gt.mc&&w(b,f,i),S===gt.Zi&&y(b,f,i))};return t.createElement(qt.X,{data:c,width:r,onCellFilterAdded:e.onClickFilterLabel&&e.onClickFilterOutLabel?g:void 0,height:e.height,footerOptions:{show:!0,reducer:["count"],countRows:!0},initialSortBy:[{displayName:d?.timeField.name||"",desc:s===U.uH.Descending}]})}const ps=(e,o,n)=>!(!o||!n||o===e.name||n===e.name||e.config.links?.length);function Kn(e){return e.fields.filter(o=>{const n=o.typeInfo?.frame==="json.RawMessage"&&o.name==="labels"&&e?.meta?.type!==Gn.m.LogLines,a=o.name==="labels"&&o.type===tt.PU.other&&e?.meta?.type===Gn.m.LogLines;return n||a}).flatMap(o=>[{id:"extractFields",options:{format:"json",keepTime:!1,replace:!1,source:o.name}}])}function hs(e){let o={};return Object.keys(e).filter(n=>e[n].active).forEach(n=>{const a=e[n].index;a!==void 0&&(o[n]=a)}),o}function ms(e){let o={};for(const n in e)o[n]=!0;return Object.keys(e).length>0?{id:"organize",options:{indexByName:e,includeByName:o}}:null}function gs(e){if(e.type===tt.PU.time)return 200}const fs=()=>({metaContainer:(0,m.css)`
    flex: 1;
    display: flex;
    flex-wrap: wrap;
  `});var ys=(e=>(e.Text="text",e.Json="json",e.CSV="csv",e))(ys||{});const Zn=t.memo(({meta:e,dedupStrategy:o,dedupCount:n,displayedFields:a,clearDetectedFields:s,hasUnescapedContent:r,forceEscape:i,onEscapeNewlines:l,logRows:d})=>{const c=(0,N.of)(fs),p=async g=>{switch((0,M.rR)("grafana_logs_download_logs_clicked",{app:Ye.Jk.Explore,format:g,area:"logs-meta-row"}),g){case"text":(0,Qn.Zy)({meta:e,rows:d},"Explore");break;case"json":const E=(0,Ee.Dg)(d),f=new Blob([JSON.stringify(E)],{type:"application/json;charset=utf-8"}),b=`Explore-logs-${(0,Qt.LE)(new Date)}.json`;ls()(f,b);break;case"csv":const S=new Map;d.forEach(w=>{w.dataFrame?.refId&&!S.has(w.dataFrame?.refId)&&S.set(w.dataFrame?.refId,w.dataFrame)}),S.forEach(async w=>{const y=Kn(w);y.push({id:"organize",options:{excludeByName:{labels:!0,labelTypes:!0}}});const x=await(0,Vn.s)((0,Wn.m)(y,[w]));(0,Qn.EM)(x[0],`Explore-logs-${w.refId}`)})}},u=[...e];o!==U.fY.none&&u.push({label:"Deduplication count",value:n,kind:Z.tG.Number}),d.some(g=>g.entry.length>cs.S)&&u.push({label:"Info",value:"Logs with more than 100,000 characters could not be parsed and highlighted",kind:Z.tG.String}),a?.length>0&&u.push({label:"Showing only selected fields",value:t.createElement(jn.A,{labels:a})},{label:"",value:t.createElement(W.$n,{variant:"secondary",size:"sm",onClick:s},"Show original line")}),r&&u.push({label:"Your logs might have incorrectly escaped content",value:t.createElement(ye.m,{content:"Fix incorrectly escaped newline and tab sequences in log lines. Manually review the results to confirm that the replacements are correct.",placement:"right"},t.createElement(W.$n,{variant:"secondary",size:"sm",onClick:l},i?"Remove escaping":"Escape newlines"))});const v=t.createElement(fe.W,null,t.createElement(fe.W.Item,{label:"txt",onClick:()=>p("text")}),t.createElement(fe.W.Item,{label:"json",onClick:()=>p("json")}),t.createElement(fe.W.Item,{label:"csv",onClick:()=>p("csv")}));return t.createElement(t.Fragment,null,u&&t.createElement("div",{className:c.metaContainer},t.createElement(Ut,{metaItems:u.map(g=>({label:g.label,value:"kind"in g?vs(g.value,g.kind):g.value}))}),t.createElement(Ke.m,{overlay:v},t.createElement(ne.I,{isOpen:!1,variant:"canvas",icon:"download-alt"},"Download"))))});Zn.displayName="LogsMetaRow";function vs(e,o){return typeof e=="string"||typeof e=="number"?t.createElement(t.Fragment,null,e):o===Z.tG.LabelsMap?t.createElement(jn.h,{labels:e}):o===Z.tG.Error?t.createElement("span",{className:"logs-meta-item__error"},e.toString()):(console.error(`Meta type ${typeof e} ${e} not recognized.`),t.createElement(t.Fragment,null))}var nt=h(62930),bs=h(57571),Es=h(42994);function xs({pages:e,currentPageIndex:o,oldestLogsFirst:n,timeZone:a,loading:s,onClick:r}){const i=p=>`${(0,Qt.LE)(p,{format:Es.WC.interval.second,timeZone:a})}`,l=(p,u)=>{if(o===u&&s)return t.createElement(nt.y,null);const v=i(n?p.logsRange.from:p.logsRange.to),g=i(n?p.logsRange.to:p.logsRange.from);return`${v} \u2014 ${g}`},d=(0,N.$j)(),c=Ss(d,s);return t.createElement(mt.E,{autoHide:!0},t.createElement("div",{className:c.pagesWrapper,"data-testid":"logsNavigationPages"},t.createElement("div",{className:c.pagesContainer},e.map((p,u)=>t.createElement("button",{type:"button","data-testid":`page${u+1}`,className:(0,m.cx)((0,W.my)(d),c.page),key:p.queryRange.to,onClick:()=>{r(p,u+1)},disabled:s},t.createElement("div",{className:(0,m.cx)(c.line,{selectedBg:o===u})}),t.createElement("div",{className:(0,m.cx)(c.time,{selectedText:o===u})},l(p,u)))))))}const Ss=(e,o)=>({pagesWrapper:(0,m.css)`
      height: 100%;
      padding-left: ${e.spacing(.5)};
      display: flex;
      flex-direction: column;
      overflow-y: scroll;
      &::after {
        content: '';
        display: block;
        background: repeating-linear-gradient(
          135deg,
          ${e.colors.background.primary},
          ${e.colors.background.primary} 5px,
          ${e.colors.background.secondary} 5px,
          ${e.colors.background.secondary} 15px
        );
        width: 3px;
        height: inherit;
        margin-bottom: 8px;
      }
    `,pagesContainer:(0,m.css)`
      display: flex;
      padding: 0;
      flex-direction: column;
    `,page:(0,m.css)`
      display: flex;
      margin: ${e.spacing(2)} 0;
      cursor: ${o?"auto":"pointer"};
      white-space: normal;
      .selectedBg {
        background: ${e.colors.primary.main};
      }
      .selectedText {
        color: ${e.colors.primary.main};
      }
    `,line:(0,m.css)`
      width: 3px;
      height: 100%;
      align-items: center;
      background: ${e.colors.text.secondary};
    `,time:(0,m.css)`
      width: 60px;
      min-height: 80px;
      font-size: ${e.v1.typography.size.sm};
      padding-left: ${e.spacing(.5)};
      display: flex;
      align-items: center;
    `});function Cs({absoluteRange:e,logsSortOrder:o,timeZone:n,loading:a,onChangeTime:s,scrollToTopLogs:r,visibleRange:i,queries:l,clearCache:d,addResultsToCache:c}){const[p,u]=(0,t.useState)([]),v=(0,t.useRef)(),g=(0,t.useRef)(),E=(0,t.useRef)(0),f=(0,t.useMemo)(()=>p.findIndex(z=>z.queryRange.to===e.to),[e.to,p]),b=o===U.uH.Ascending,S=b?f===p.length-1:f===0,w=b?f===0:f===p.length-1,y=(0,N.$j)(),x=Rs(y,b);(0,t.useEffect)(()=>{const z={logsRange:i,queryRange:e};let H=[];!(0,_.isEqual)(g.current,e)||!(0,_.isEqual)(v.current,l)?(d(),u([z]),v.current=l,E.current=e.to-e.from):u(te=>(H=te.filter(ee=>!(0,_.isEqual)(z.queryRange,ee.queryRange)),H=[...H,z].sort((ee,oe)=>R(ee,oe,o)),H))},[i,e,o,l,d,c]);const T=(0,t.useCallback)(({from:z,to:H})=>{c(),g.current={from:z,to:H},s({from:z,to:H})},[s,c]),R=(z,H,te)=>te===U.uH.Ascending?z.queryRange.to>H.queryRange.to?1:-1:z.queryRange.to>H.queryRange.to?-1:1,A=t.createElement(W.$n,{"data-testid":"olderLogsButton",className:x.navButton,variant:"secondary",onClick:()=>{if((0,M.rR)("grafana_explore_logs_pagination_clicked",{pageType:"olderLogsButton"}),w)T({from:i.from-E.current,to:i.from});else{const z=b?-1:1;T({from:p[f+z].queryRange.from,to:p[f+z].queryRange.to})}r()},disabled:a},t.createElement("div",{className:x.navButtonContent},a?t.createElement(nt.y,null):t.createElement(ce.I,{name:b?"angle-up":"angle-down",size:"lg"}),"Older logs")),O=t.createElement(W.$n,{"data-testid":"newerLogsButton",className:x.navButton,variant:"secondary",onClick:()=>{if((0,M.rR)("grafana_explore_logs_pagination_clicked",{pageType:"newerLogsButton"}),!S){const z=b?1:-1;T({from:p[f+z].queryRange.from,to:p[f+z].queryRange.to})}r()},disabled:a||S},t.createElement("div",{className:x.navButtonContent},a&&t.createElement(nt.y,null),S||a?null:t.createElement(ce.I,{name:b?"angle-down":"angle-up",size:"lg"}),S?"Start of range":"Newer logs")),k=(0,t.useCallback)((z,H)=>{(0,M.rR)("grafana_explore_logs_pagination_clicked",{pageType:"page",pageNumber:H}),T({from:z.queryRange.from,to:z.queryRange.to}),r()},[T,r]),V=(0,t.useCallback)(()=>{(0,M.rR)("grafana_explore_logs_scroll_top_clicked"),r()},[r]);return t.createElement("div",{className:x.navContainer},!B.$.featureToggles.logsInfiniteScrolling&&t.createElement(t.Fragment,null,b?A:O,t.createElement(xs,{pages:p,currentPageIndex:f,oldestLogsFirst:b,timeZone:n,loading:a,onClick:k}),b?O:A),t.createElement(W.$n,{"data-testid":"scrollToTop",className:x.scrollToTopButton,variant:"secondary",onClick:V,title:"Scroll to top"},t.createElement(ce.I,{name:"arrow-up",size:"lg"})))}const ws=(0,t.memo)(Cs),Rs=(e,o)=>{const n=`calc(100vh - 2*${e.spacing(2)} - 2*${bs.l}px)`;return{navContainer:(0,m.css)`
      max-height: ${n};
      display: flex;
      flex-direction: column;
      ${B.$.featureToggles.logsInfiniteScrolling?"justify-content: flex-end;":`justify-content: ${o?"flex-start":"space-between"};`}
      position: sticky;
      top: ${e.spacing(2)};
      right: 0;
    `,navButton:(0,m.css)`
      width: 58px;
      height: 68px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      line-height: 1;
    `,navButtonContent:(0,m.css)`
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
      white-space: normal;
    `,scrollToTopButton:(0,m.css)`
      width: 40px;
      height: 40px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      margin-top: ${e.spacing(1)};
    `}};var Yn=h(98101);function Ts(e){return{searchWrap:(0,m.css)({padding:`${e.spacing(.4)} 0 ${e.spacing(.4)} ${e.spacing(.4)}`})}}function Ls(e){const o=(0,N.$j)(),n=Ts(o);return t.createElement(ie.D,{className:n.searchWrap},t.createElement(Ne.p,{value:e.value,type:"text",placeholder:"Search fields by name",onChange:e.onChange}))}var Gt=h(75494);function Is(e){return{empty:(0,m.css)({marginBottom:e.spacing(2),marginLeft:e.spacing(1.75),fontSize:e.typography.fontSize})}}function Jn(){const e=(0,N.$j)(),o=Is(e);return t.createElement("div",{className:o.empty},"No fields")}var Fs=h(10880);function Os(e){return{dragIcon:(0,m.css)({cursor:"drag",marginLeft:e.spacing(1),opacity:.4}),labelCount:(0,m.css)({marginLeft:e.spacing(.5),marginRight:e.spacing(.5),appearance:"none",background:"none",border:"none",fontSize:e.typography.pxToRem(11),opacity:.6}),contentWrap:(0,m.css)({display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%"}),checkboxLabel:(0,m.css)({"> span":{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",display:"block",maxWidth:"100%"}})}}function Xn(e){const o=(0,N.$j)(),n=Os(o);if(e.labels[e.label])return t.createElement(t.Fragment,null,t.createElement("div",{className:n.contentWrap},t.createElement(Fs.S,{className:n.checkboxLabel,label:e.label,onChange:e.onChange,checked:e.labels[e.label]?.active??!1}),e.showCount&&t.createElement("button",{className:n.labelCount,onClick:e.onChange},e.labels[e.label]?.percentOfLinesWithLabel,"%")),e.draggable&&t.createElement(ce.I,{"aria-label":"Drag and drop icon",title:"Drag and drop to reorder",name:"draggabledots",size:"lg",className:n.dragIcon}))}function _n(e){return{wrap:(0,m.css)({marginTop:e.spacing(1),marginBottom:e.spacing(1),display:"flex",background:e.colors.background.primary}),dragging:(0,m.css)({background:e.colors.background.secondary}),columnWrapper:(0,m.css)({marginBottom:e.spacing(1.5),paddingLeft:e.spacing(.5)})}}function Ds(e){return(o,n)=>{const a=e[o],s=e[n];return a.index!=null&&s.index!=null?a.index-s.index:0}}const As=e=>{const{reorderColumn:o,labels:n,valueFilter:a,toggleColumn:s}=e,r=(0,N.$j)(),i=_n(r),l=Object.keys(n).filter(p=>a(p)),d=p=>{p.destination&&o(p.source.index,p.destination.index)},c=p=>{const u=n[p];if(u)return`${p} appears in ${u?.percentOfLinesWithLabel}% of log lines`};return l.length?t.createElement(Gt.JY,{onDragEnd:d},t.createElement(Gt.gL,{droppableId:"order-fields",direction:"vertical"},p=>t.createElement("div",{className:i.columnWrapper,...p.droppableProps,ref:p.innerRef},l.sort(Ds(n)).map((u,v)=>t.createElement(Gt.sx,{draggableId:u,key:u,index:v},(g,E)=>t.createElement("div",{className:(0,m.cx)(i.wrap,E.isDragging?i.dragging:void 0),ref:g.innerRef,...g.draggableProps,...g.dragHandleProps,title:c(u)},t.createElement(Xn,{label:u,onChange:()=>s(u),labels:n,draggable:!0})))),p.placeholder))):t.createElement(Jn,null)},Ns=new Intl.Collator(void 0,{sensitivity:"base"});function ks(e){return(o,n)=>{const a=e[o],s=e[n];return a!=null&&s!=null?+(s.type==="TIME_FIELD")-+(a.type==="TIME_FIELD")||+(s.type==="BODY_FIELD")-+(a.type==="BODY_FIELD")||Ns.compare(o,n):0}}const Ps=e=>{const{labels:o,valueFilter:n,toggleColumn:a}=e,s=(0,N.$j)(),r=_n(s),i=Object.keys(o).filter(l=>n(l));return i.length?t.createElement("div",{className:r.columnWrapper},i.sort(ks(o)).map((l,d)=>t.createElement("div",{key:l,className:r.wrap,title:`${l} appears in ${o[l]?.percentOfLinesWithLabel}% of log lines`},t.createElement(Xn,{showCount:!0,label:l,onChange:()=>a(l),labels:o})))):t.createElement(Jn,null)};function Ms(e){return{sidebarWrap:(0,m.css)({overflowY:"scroll",height:"calc(100% - 50px)","&::-webkit-scrollbar":{display:"none"},scrollbarWidth:"none"}),columnHeaderButton:(0,m.css)({appearance:"none",background:"none",border:"none",fontSize:e.typography.pxToRem(11)}),columnHeader:(0,m.css)({display:"flex",justifyContent:"space-between",fontSize:e.typography.h6.fontSize,background:e.colors.background.secondary,position:"sticky",top:0,left:0,paddingTop:e.spacing(.75),paddingRight:e.spacing(.75),paddingBottom:e.spacing(.75),paddingLeft:e.spacing(1.5),zIndex:3,marginBottom:e.spacing(2)})}}const zs=e=>{const o=(0,N.$j)(),n=Ms(o);return t.createElement("div",{className:n.sidebarWrap},t.createElement(t.Fragment,null,t.createElement("div",{className:n.columnHeader},"Selected fields",t.createElement("button",{onClick:e.clear,className:n.columnHeaderButton},"Reset")),t.createElement(As,{reorderColumn:e.reorderColumn,toggleColumn:e.toggleColumn,labels:e.filteredColumnsWithMeta??e.columnsWithMeta,valueFilter:a=>e.columnsWithMeta[a]?.active??!1,id:"selected-fields"}),t.createElement("div",{className:n.columnHeader},"Fields"),t.createElement(Ps,{toggleColumn:e.toggleColumn,labels:e.filteredColumnsWithMeta??e.columnsWithMeta,valueFilter:a=>!e.columnsWithMeta[a]?.active})))};var eo=h(53076);const Hs=new eo.A({intraMode:1,intraIns:1,intraSub:1,intraTrn:1,intraDel:1});function to(e,o,n){const[a,s,r]=Hs.search(e,o,0,1e5);let i=[],l=new Set;if(a&&r){const d=(c,p)=>{p&&l.add(c)};for(let c=0;c<r.length;c++){let p=r[c];eo.A.highlight(e[s.idx[p]],s.ranges[p],d),i.push(e[s.idx[p]])}n([i,[...l]])}else o||n([[],[]])}const Sl=(0,_.debounce)(to,300);function $s(e){const{logsFrames:o,updatePanelState:n,panelState:a}=e,s=a?.columns,[r,i]=(0,t.useState)(void 0),[l,d]=(0,t.useState)(void 0),[c,p]=(0,t.useState)(""),u=no(),v=e?.panelState?.refId,[g,E]=(0,t.useState)(o.find(L=>L.refId===v)??o[0]),f=(0,t.useCallback)(L=>{const D=e.panelState?.columns;return D&&Object.values(D).forEach((P,I)=>{L[P]&&(L[P].active=!0,L[P].index=I)}),L},[e.panelState?.columns]),b=(0,Yn.O)(g);(0,t.useEffect)(()=>{if(b?.timeField.name&&b?.bodyField.name&&!s){const L={0:b?.timeField.name??"",1:b?.bodyField.name??""};n({columns:Object.values(L),visualisationType:"table",labelFieldName:b?.getLabelFieldName()??void 0})}},[b,s,n]),(0,t.useEffect)(()=>{const L=o.find(D=>D.refId===v)??o[0];L&&E(L)},[o,v]),(0,t.useEffect)(()=>{if(!r||!l)return;let L={...l},D=!1;Object.keys(r).forEach(P=>{L[P]&&L[P].active!==r[P].active&&(L[P]=r[P],D=!0)}),D&&d(L)},[r,l]),(0,t.useEffect)(()=>{if(!g.length)return;const L=g?g.length:0,D=(0,Yn.O)(g),P=D?.getLogFrameLabelsAsLabels(),I=[];D&&I.push(...D.extraFields.filter(X=>!X?.config?.custom?.hidden)),D?.severityField&&I.push(D?.severityField),D?.bodyField&&I.push(D?.bodyField),D?.timeField&&I.push(D?.timeField);const Q=new Map;let $={};P?.length&&L&&(P.forEach(X=>{Object.keys(X).forEach(he=>{if(Q.has(he)){const le=Q.get(he);le&&(le?.active?Q.set(he,{percentOfLinesWithLabel:le.percentOfLinesWithLabel+1,active:!0,index:le.index}):Q.set(he,{percentOfLinesWithLabel:le.percentOfLinesWithLabel+1,active:!1,index:void 0}))}else Q.set(he,{percentOfLinesWithLabel:1,active:!1,index:void 0})})}),$=Object.fromEntries(Q),Object.keys($).forEach(X=>{$[X].percentOfLinesWithLabel=Kt($[X].percentOfLinesWithLabel,L)})),I.forEach(X=>{const q=$[X.name]?.active,he=$[X.name]?.index;q&&he!==void 0?$[X.name]={percentOfLinesWithLabel:Kt(X.values.filter(le=>le!=null).length,L),active:!0,index:he}:$[X.name]={percentOfLinesWithLabel:Kt(X.values.filter(le=>le!=null).length,L),active:!1,index:void 0}}),$=f($),Object.keys($).filter(X=>$[X].active).length===0&&(D?.bodyField?.name&&($[D.bodyField.name].active=!0),D?.timeField?.name&&($[D.timeField.name].active=!0)),D?.bodyField?.name&&D?.timeField?.name&&($[D.bodyField.name].type="BODY_FIELD",$[D.timeField.name].type="TIME_FIELD"),i($)},[g,f]);const[S,w]=(0,t.useState)(220),y=e.width-S;if(!r)return null;function x(L){if(r){const D=!r[L]?.active,P=Object.keys(r).filter(Q=>r[Q]?.active)?.length,I={columnAction:D?"add":"remove",columnCount:D?P+1:P-1,datasourceType:e.datasourceType};(0,M.rR)("grafana_explore_logs_table_column_filter_clicked",I)}}function T(L){(0,M.rR)("grafana_explore_logs_table_text_search_result_count",{resultCount:L,datasourceType:e.datasourceType??"unknown"})}const R=()=>{const L={...r};let D=0;Object.keys(L).forEach(P=>{const I=!!L[P].type;L[P].active=I,L[P].index=I?D++:void 0}),i(L)},A=(L,D)=>{if(L===D)return;const P={...r},I=Object.keys(P).filter($=>P[$].active).map($=>({fieldName:$,index:P[$].index??0})).sort(($,Ce)=>$.index-Ce.index),[Q]=I.splice(L,1);I.splice(D,0,Q),I.forEach(($,Ce)=>{P[$.fieldName].index=Ce}),i(P),O(P)};function O(L){const D=Object.keys(L).filter($=>L[$]?.active).sort(($,Ce)=>{const X=L[$],q=L[Ce];return X.index!==void 0&&q.index!==void 0?X.index-q.index:0}),P=Object.assign({},D),I={0:b?.timeField.name??"",1:b?.bodyField.name??""},Q={...e.panelState,columns:Object.keys(P).length?P:I,refId:g.refId,visualisationType:"table",labelFieldName:b?.getLabelFieldName()??void 0};n(Q)}const k=L=>{if(!r||!(L in r)){console.warn("failed to get column",r);return}const D=Object.keys(r).filter(Q=>r[Q].active).length,P=r[L].active?void 0:!0;let I;if(P?I={...r,[L]:{...r[L],active:P,index:D}}:I={...r,[L]:{...r[L],active:!1,index:void 0}},x(L),i(I),l){const Q=!l[L]?.active;let $;Q?$={...l,[L]:{...l[L],active:Q,index:D}}:$={...l,[L]:{...l[L],active:!1,index:void 0}},d($)}O(I)},V=L=>{const D=L[0];let P={},I=0;D.forEach(Q=>{Q in r&&(P[Q]=r[Q],I++)}),d(P),T(I)},z=L=>{to(Object.keys(r),L,V)},H=L=>{const D=L.currentTarget?.value;p(D),D?z(D):d(void 0)},te=L=>{o.find(P=>P.refId===L.value)&&E(o.find(P=>P.refId===L.value)??o[0]),e.updatePanelState({refId:L.value,labelFieldName:b?.getLabelFieldName()??void 0})},ee=Bs(e.theme,u,S),oe=(L,D,P)=>{const I=Number(P.style.width.slice(0,-2));isNaN(I)||w(I)};return t.createElement(t.Fragment,null,t.createElement("div",null,o.length>1&&t.createElement("div",null,t.createElement(xe.I,{label:"Select query",htmlFor:"explore_logs_table_frame_selector",labelWidth:22,tooltip:"Select a query to visualize in the table."},t.createElement(Ie.l6,{inputId:"explore_logs_table_frame_selector","aria-label":"Select query by name",value:g.refId,options:o.map(L=>({label:L.refId,value:L.refId})),onChange:te})))),t.createElement("div",{className:ee.wrapper},t.createElement(gn,{enable:{right:!0},handleClasses:{right:ee.rzHandle},onResize:oe},t.createElement("section",{className:ee.sidebar},t.createElement(Ls,{value:c,onChange:H}),t.createElement(zs,{reorderColumn:A,toggleColumn:k,filteredColumnsWithMeta:l,columnsWithMeta:r,clear:R}))),t.createElement(us,{logsFrame:b,onClickFilterLabel:e.onClickFilterLabel,onClickFilterOutLabel:e.onClickFilterOutLabel,logsSortOrder:e.logsSortOrder,range:e.range,splitOpen:e.splitOpen,timeZone:e.timeZone,width:y,dataFrame:g,columnsWithMeta:r,height:u})))}const Kt=(e,o)=>Math.ceil(100*e/o);function Bs(e,o,n){return{wrapper:(0,m.css)({display:"flex"}),sidebar:(0,m.css)({height:o,fontSize:e.typography.pxToRem(11),overflowY:"hidden",width:n,paddingRight:e.spacing(3)}),rzHandle:(0,m.css)({background:e.colors.secondary.main,[e.transitions.handleMotion("no-preference","reduce")]:{transition:"0.3s background ease-in-out"},position:"relative",height:"50% !important",width:`${e.spacing(1)} !important`,top:"25% !important",right:`${e.spacing(1)} !important`,cursor:"grab",borderRadius:e.shape.radius.pill,"&:hover":{background:e.colors.secondary.shade}})}}const no=()=>Math.max(window.innerHeight-500,500);function Zt(e){const[o,n]=(0,t.useState)(!1),a=100,{error:s,title:r,suggestedAction:i,onSuggestedAction:l,onRemove:d,severity:c="warning"}=e,p=s?.message||s?.data?.message||"",u=!o&&p.length>a,v=(0,N.$j)(),g=Vs(v);return t.createElement("div",{className:g.supplementaryErrorContainer},t.createElement(Ge.F,{title:r,severity:c,onRemove:d},t.createElement("div",{className:g.suggestedActionWrapper},u?t.createElement(W.$n,{variant:"secondary",size:"xs",onClick:()=>{n(!0)}},"Show details"):p,i&&l&&t.createElement("div",{className:g.suggestedActionWrapper},t.createElement(W.$n,{variant:"primary",size:"xs",onClick:l},i)))))}const Vs=e=>({supplementaryErrorContainer:(0,m.css)({width:"50%",minWidth:`${e.breakpoints.values.sm}px`,margin:"0 auto"}),suggestedActionWrapper:(0,m.css)({height:e.spacing(6),button:{position:"absolute",right:e.spacing(2),top:e.spacing(7)}})});var Ws=h(9791);function Qs(e){const{width:o,timeZone:n,splitOpen:a,onUpdateTimeRange:s,onHiddenSeriesChanged:r,allLogsVolumeMaximum:i,toggleLegendRef:l}=e,d=(0,N.$j)(),c=(0,N.of)(js),p=parseInt(d.spacing(2).slice(0,-2),10),u=150,v=e.logsVolumeData,g=(0,Ee.Dm)(v?.data);let E=g?`${g.name}`:"";(0,Ee.e3)(v.data)&&(E=[E,"This datasource does not support full-range histograms. The graph below is based on the logs seen in the response."].filter(_.identity).join(". "));let f=t.createElement("span",null,E);return v.state===de.Gu.Streaming&&(f=t.createElement(t.Fragment,null,f,t.createElement(ye.m,{content:"Streaming"},t.createElement(ce.I,{name:"circle-mono",size:"md",className:c.streaming,"data-testid":"logs-volume-streaming"})))),t.createElement("div",{style:{height:u},className:c.contentContainer},t.createElement(Ws.k,{toggleLegendRef:l,vizLegendOverrides:{calcs:["sum"]},graphStyle:"lines",loadingState:v.state??de.Gu.Done,data:v.data,height:u,width:o-p*2,absoluteRange:e.absoluteRange,onChangeTime:s,timeZone:n,splitOpenFn:a,tooltipDisplayMode:U.$N.Multi,onHiddenSeriesChanged:r,anchorToZero:!0,yAxisMaximum:i,eventBus:e.eventBus,annotations:e.annotations}),f&&t.createElement("div",{className:c.extraInfoContainer},f))}const js=e=>({extraInfoContainer:(0,m.css)`
      display: flex;
      justify-content: end;
      position: absolute;
      right: 5px;
      top: -10px;
      font-size: ${e.typography.bodySmall.fontSize};
      color: ${e.colors.text.secondary};
    `,contentContainer:(0,m.css)`
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    `,streaming:(0,m.css)`
      color: ${e.colors.success.text};
    `});function Us(e){return!e||!e.error&&!e.errors?!1:(e.error?[e.error]:e.errors||[]).some(n=>(`${n.message||n.data?.message}`?.toLowerCase()).includes("timeout"))}const qs=({logsVolumeData:e,absoluteRange:o,onUpdateTimeRange:n,width:a,onLoadLogsVolume:s,onHiddenSeriesChanged:r,eventBus:i,splitOpen:l,timeZone:d,onClose:c,toggleLegendRef:p})=>{const{logVolumes:u,maximumValue:v,maximumRange:g,annotations:E}=(0,t.useMemo)(()=>{let x=-1/0;const T=e?.data.filter(z=>z.meta?.dataTopic!==U.QR.Annotations),R=e?.data.filter(z=>z.meta?.dataTopic===U.QR.Annotations)||[],A=(0,_.sortBy)(T||[],"meta.custom.datasourceName"),O=(0,_.groupBy)(A,"meta.custom.datasourceName"),k=(0,_.mapValues)(O,z=>{const H=(0,Ee.oT)(z);return x=Math.max(x,H.maximum),H.dataFrames}),V=(0,Ee.Dx)((0,_.flatten)(Object.values(k)));return{maximumValue:x,maximumRange:V,logVolumes:k,annotations:R}},[e]),f=(0,N.of)(Gs),b=Object.keys(u).length,S=Object.values(u).some(x=>{const T=Ks(x,o);return!(0,Ee.e3)(x)&&T&&T<1}),w=Us(e),y={from:Math.max(o.from,g.from),to:Math.min(o.to,g.to)};return e?.state===de.Gu.Loading?t.createElement("span",null,"Loading..."):w?t.createElement(Zt,{title:"The logs volume query has timed out",severity:"info",suggestedAction:"Retry",onSuggestedAction:s,onRemove:c}):e?.error!==void 0?t.createElement(Zt,{error:e.error,title:"Failed to load log volume for this query"}):b===0?t.createElement("div",{className:f.alertContainer},t.createElement(Ge.F,{severity:"info",title:"No logs volume available"},"No volume information available for the current queries and time range.")):t.createElement("div",{className:f.listContainer},Object.keys(u).map((x,T)=>{const R={data:u[x]};return t.createElement(Qs,{toggleLegendRef:p,key:T,absoluteRange:y,allLogsVolumeMaximum:v,width:a,logsVolumeData:R,onUpdateTimeRange:n,timeZone:d,splitOpen:l,onLoadLogsVolume:s,onHiddenSeriesChanged:b>1?()=>{}:r,eventBus:i,annotations:E})}),S&&t.createElement("div",{className:f.extraInfoContainer},t.createElement(xe.I,{label:"Reload log volume",transparent:!0},t.createElement(W.$n,{size:"xs",icon:"sync",variant:"secondary",onClick:s,id:"reload-volume"}))))},Gs=e=>({listContainer:(0,m.css)`
      padding-top: 10px;
    `,extraInfoContainer:(0,m.css)`
      display: flex;
      justify-content: end;
      position: absolute;
      right: 5px;
      top: 5px;
    `,oldInfoText:(0,m.css)`
      font-size: ${e.typography.bodySmall.fontSize};
      color: ${e.colors.text.secondary};
    `,alertContainer:(0,m.css)`
      width: 50%;
      min-width: ${e.breakpoints.values.sm}px;
      margin: 0 auto;
    `});function Ks(e,o){const n=e&&e[0]&&e[0].meta?.custom?.absoluteRange;return n?(o.from-o.to)/(n.from-n.to):void 0}var se=h(97186);const Zs=[U.fY.none,U.fY.exact,U.fY.numbers,U.fY.signature],Yt=()=>{const e=ae.A.get(se.r);return e==="table"?"table":e==="logs"?"logs":B.$.featureToggles.logsExploreTableDefaultVisualization?"table":"logs"};class Ys extends t.PureComponent{constructor(o){super(o),this.topLogsRef=(0,t.createRef)(),this.toggleLegendRef=t.createRef(),this.state={showLabels:ae.A.getBool(se.$.showLabels,!1),showTime:ae.A.getBool(se.$.showTime,!0),wrapLogMessage:ae.A.getBool(se.$.wrapLogMessage,!0),prettifyLogMessage:ae.A.getBool(se.$.prettifyLogMessage,!1),dedupStrategy:U.fY.none,hiddenLogLevels:[],logsSortOrder:ae.A.get(se.$.logsSortOrder)||U.uH.Descending,isFlipping:!1,displayedFields:[],forceEscape:!1,contextOpen:!1,contextRow:void 0,tableFrame:void 0,visualisationType:this.props.panelState?.logs?.visualisationType??Yt(),logsContainer:void 0},this.registerLogLevelsWithContentOutline=()=>{const n=Object.keys(et.cZ),a=new Set(this.props.logsVolumeData?.data),s=this.getNumberOfLogVolumes(),r=this.context?.outlineItems.find(c=>c.panelId==="Logs"&&c.level==="root");r&&this.context?.unregisterAllChildren(r.id,"filter");const i=[];a.forEach(c=>{const{level:p}=(0,Ee.tX)(c);i.push({levelStr:p,logLevel:(0,Ee.XM)(p)})});const l=i.sort((c,p)=>n.indexOf(c.logLevel.toString())>n.indexOf(p.logLevel.toString())?1:-1),d=new Set(l);d.size>1&&this.props.logsVolumeEnabled&&s===1&&d.forEach(c=>{const p=this.state.hiddenLogLevels.length===0,u=!this.state.hiddenLogLevels.find(v=>v===c.levelStr);this.context?.register({title:c.levelStr,icon:"gf-logs",panelId:"Logs",level:"child",type:"filter",highlight:u&&!p,onClick:v=>{this.toggleLegendRef.current?.(c.levelStr,(0,Ja.W)(v))},ref:null,color:et.cZ[c.logLevel]})})},this.updatePanelState=n=>{const a=(0,Oe.Gu)().explore.panes[this.props.exploreId];a?.panelsState&&(0,Oe.JD)((0,we.EA)(this.props.exploreId,"logs",{...a.panelsState.logs,columns:n.columns??this.props.panelState?.logs?.columns,visualisationType:n.visualisationType??this.state.visualisationType,labelFieldName:n.labelFieldName,refId:n.refId??this.props.panelState?.logs?.refId}))},this.onLogRowHover=n=>{n?this.props.eventBus.publish(new An.b_({point:{time:n.timeEpochMs}})):this.props.eventBus.publish(new An.ql)},this.onLogsContainerRef=n=>{this.setState({logsContainer:n})},this.onChangeLogsSortOrder=()=>{this.setState({isFlipping:!0}),this.flipOrderTimer=window.setTimeout(()=>{this.setState(n=>{const a=n.logsSortOrder===U.uH.Descending?U.uH.Ascending:U.uH.Descending;return ae.A.set(se.$.logsSortOrder,a),{logsSortOrder:a}})},0),this.cancelFlippingTimer=window.setTimeout(()=>this.setState({isFlipping:!1}),1e3)},this.onEscapeNewlines=()=>{this.setState(n=>({forceEscape:!n.forceEscape}))},this.onChangeVisualisation=n=>{this.setState(()=>({visualisationType:n}));const a={...this.props.panelState?.logs,visualisationType:n};this.updatePanelState(a),(0,M.rR)("grafana_explore_logs_visualisation_changed",{newVisualizationType:n,datasourceType:this.props.datasourceType??"unknown",defaultVisualisationType:B.$.featureToggles.logsExploreTableDefaultVisualization?"table":"logs"})},this.onChangeDedup=n=>{(0,M.rR)("grafana_explore_logs_deduplication_clicked",{deduplicationType:n,datasourceType:this.props.datasourceType}),this.setState({dedupStrategy:n})},this.onChangeLabels=n=>{const{target:a}=n;if(a){const s=a.checked;this.setState({showLabels:s}),ae.A.set(se.$.showLabels,s)}},this.onChangeTime=n=>{const{target:a}=n;if(a){const s=a.checked;this.setState({showTime:s}),ae.A.set(se.$.showTime,s)}},this.onChangeWrapLogMessage=n=>{const{target:a}=n;if(a){const s=a.checked;this.setState({wrapLogMessage:s}),ae.A.set(se.$.wrapLogMessage,s)}},this.onChangePrettifyLogMessage=n=>{const{target:a}=n;if(a){const s=a.checked;this.setState({prettifyLogMessage:s}),ae.A.set(se.$.prettifyLogMessage,s)}},this.onToggleLogLevel=n=>{const a=n.map(s=>(0,Ee.EK)(s));this.setState({hiddenLogLevels:a})},this.onToggleLogsVolumeCollapse=n=>{this.props.onSetLogsVolumeEnabled(!n),(0,M.rR)("grafana_explore_logs_histogram_toggle_clicked",{datasourceType:this.props.datasourceType,type:n?"close":"open"})},this.onClickScan=n=>{n.preventDefault(),this.props.onStartScanning&&(this.props.onStartScanning(),(0,M.rR)("grafana_explore_logs_scanning_button_clicked",{type:"start",datasourceType:this.props.datasourceType}))},this.onClickStopScan=n=>{n.preventDefault(),this.props.onStopScanning&&this.props.onStopScanning()},this.showField=n=>{this.state.displayedFields.indexOf(n)===-1&&this.setState(s=>({displayedFields:s.displayedFields.concat(n)}))},this.hideField=n=>{this.state.displayedFields.indexOf(n)>-1&&this.setState(s=>({displayedFields:s.displayedFields.filter(r=>n!==r)}))},this.clearDetectedFields=()=>{this.setState(n=>({displayedFields:[]}))},this.onCloseContext=()=>{this.setState({contextOpen:!1,contextRow:void 0})},this.onOpenContext=(n,a)=>{this.setState({contextOpen:!0,contextRow:n}),(0,M.rR)("grafana_explore_logs_log_context_opened",{datasourceType:n.datasourceType,logRowUid:n.uid}),this.onCloseContext=()=>{this.setState({contextOpen:!1,contextRow:void 0}),(0,M.rR)("grafana_explore_logs_log_context_closed",{datasourceType:n.datasourceType,logRowUid:n.uid}),a()}},this.onPermalinkClick=async n=>{if(n.rowId===void 0)return;const a=(0,Bn.m)((0,Oe.Gu)().explore.panes[this.props.exploreId]);a.panelsState={...this.props.panelState,logs:{id:n.uid,visualisationType:this.state.visualisationType??Yt()}},a.range=this.getPermalinkRange(n);const s=(0,Nn.Pp)(a),r=/.*(?=\/explore)/.exec(`${window.location.href}`)[0],i=Nn.kM.renderUrl(`${r}/explore`,{left:s});await(0,Wt.VP)(i),(0,M.rR)("grafana_explore_logs_permalink_clicked",{datasourceType:n.datasourceType??"unknown",logRowUid:n.uid,logRowLevel:n.logLevel})},this.scrollIntoView=n=>{if(B.$.featureToggles.logsInfiniteScrolling){this.state.logsContainer&&(this.topLogsRef.current?.scrollIntoView(),this.state.logsContainer.scroll({behavior:"smooth",top:this.state.logsContainer.scrollTop+n.getBoundingClientRect().top-window.innerHeight/2}));return}const{scrollElement:a}=this.props;a&&a.scroll({behavior:"smooth",top:a.scrollTop+n.getBoundingClientRect().top-window.innerHeight/2})},this.checkUnescapedContent=(0,Je.A)(n=>!!n.some(a=>a.hasUnescapedContent)),this.dedupRows=(0,Je.A)((n,a)=>{const s=(0,et.M0)(n,a),r=s.reduce((i,l)=>l.duplicates?i+l.duplicates:i,0);return{dedupedRows:s,dedupCount:r}}),this.filterRows=(0,Je.A)((n,a)=>(0,et.ct)(n,new Set(a))),this.createNavigationRange=(0,Je.A)(n=>{if(!n||n.length===0)return;const a=n[0].timeEpochMs,s=n[n.length-1].timeEpochMs;return s<a?{from:s,to:a}:{from:a,to:s}}),this.scrollToTopLogs=()=>{B.$.featureToggles.logsInfiniteScrolling&&this.state.logsContainer&&this.state.logsContainer.scroll({behavior:"auto",top:0}),this.topLogsRef.current?.scrollIntoView()},this.logsVolumeEventBus=o.eventBus.newScopedBus("logsvolume",{onlyLocal:!1})}static{this.contextType=kt}componentDidMount(){this.registerLogLevelsWithContentOutline()}componentWillUnmount(){this.flipOrderTimer&&window.clearTimeout(this.flipOrderTimer),this.cancelFlippingTimer&&window.clearTimeout(this.cancelFlippingTimer),(this.props?.panelState?.logs?.columns||this.props?.panelState?.logs?.refId||this.props?.panelState?.logs?.labelFieldName)&&(0,Oe.JD)((0,we.EA)(this.props.exploreId,"logs",{...this.props.panelState?.logs,columns:void 0,visualisationType:this.state.visualisationType,labelFieldName:void 0,refId:void 0}))}getNumberOfLogVolumes(){const o=this.props.logsVolumeData?.data.filter(s=>s.meta?.dataTopic!==U.QR.Annotations),n=(0,_.groupBy)(o,"meta.custom.datasourceName");return Object.keys(n).length}componentDidUpdate(o,n){if(this.props.loading&&!o.loading&&this.props.panelState?.logs?.id&&(delete this.props.panelState.logs.id,(0,Oe.JD)((0,we.EA)(this.props.exploreId,"logs",{...this.props.panelState}))),this.props.panelState?.logs?.visualisationType!==o.panelState?.logs?.visualisationType){const a=this.props.panelState?.logs?.visualisationType??Yt();this.setState({visualisationType:a}),ae.A.set(se.r,a)}(o.logsVolumeData?.data!==this.props.logsVolumeData?.data||n.hiddenLogLevels!==this.state.hiddenLogLevels)&&this.registerLogLevelsWithContentOutline()}getPreviousLog(o,n){for(let a=n.indexOf(o)-1;a>=0;a--)if(n[a].timeEpochMs>o.timeEpochMs)return n[a];return null}getPermalinkRange(o){const n={from:new Date(this.props.absoluteRange.from).toISOString(),to:new Date(this.props.absoluteRange.to).toISOString()};if(!B.$.featureToggles.logsInfiniteScrolling)return n;const a=this.props.logRows.filter(r=>r.dataFrame.refId===o.dataFrame.refId),s=this.getPreviousLog(o,a);return o.timeEpochMs>this.props.absoluteRange.to&&!s?{from:new Date(this.props.absoluteRange.from).toISOString(),to:new Date(o.timeEpochMs+1).toISOString()}:{from:new Date(this.props.absoluteRange.from).toISOString(),to:new Date(s?s.timeEpochMs:this.props.absoluteRange.to).toISOString()}}render(){const{width:o,splitOpen:n,logRows:a,logsMeta:s,logsVolumeEnabled:r,logsVolumeData:i,loadLogsVolumeData:l,loading:d=!1,onClickFilterLabel:c,onClickFilterOutLabel:p,timeZone:u,scanning:v,scanRange:g,showContextToggle:E,absoluteRange:f,onChangeTime:b,getFieldLinks:S,theme:w,logsQueries:y,clearCache:x,addResultsToCache:T,exploreId:R,getRowContext:A,getLogRowContextUi:O,getRowContextQuery:k,loadMoreLogs:V}=this.props,{showLabels:z,showTime:H,wrapLogMessage:te,prettifyLogMessage:ee,dedupStrategy:oe,hiddenLogLevels:L,logsSortOrder:D,isFlipping:P,displayedFields:I,forceEscape:Q,contextOpen:$,contextRow:Ce}=this.state,X=no(),q=Xs(w,te,X),he=a&&a.length>0,le=this.checkUnescapedContent(a),fl=this.filterRows(a,L),{dedupedRows:yl,dedupCount:vl}=this.dedupRows(fl,oe),bl=this.createNavigationRange(a),El=g?`Scanning ${Xe.describeTimeRange(g)}`:"Scanning...";return t.createElement(t.Fragment,null,A&&Ce&&t.createElement(as.V,{open:$,row:Ce,onClose:this.onCloseContext,getRowContext:(rt,xl)=>A(rt,Ce,xl),getRowContextQuery:k,getLogRowContextUi:O,logsSortOrder:D,timeZone:u}),t.createElement(Re.NR,{title:"Logs volume",collapsible:!0,collapsed:!r,onToggleCollapse:this.onToggleLogsVolumeCollapse},r&&t.createElement(qs,{toggleLegendRef:this.toggleLegendRef,absoluteRange:f,width:o,logsVolumeData:i,onUpdateTimeRange:b,timeZone:u,splitOpen:n,onLoadLogsVolume:l,onHiddenSeriesChanged:this.onToggleLogLevel,eventBus:this.logsVolumeEventBus,onClose:()=>this.onToggleLogsVolumeCollapse(!0)})),t.createElement(Re.NR,{titleItems:[B.$.featureToggles.logsExploreTableVisualisation?this.state.visualisationType==="logs"?null:t.createElement(Re.NR.TitleItem,{title:"Feedback",key:"A"},t.createElement(ss,{feedbackUrl:"https://forms.gle/5YyKdRQJ5hzq4c289"})):null],title:"Logs",actions:t.createElement(t.Fragment,null,B.$.featureToggles.logsExploreTableVisualisation&&t.createElement("div",{className:q.visualisationType},t.createElement(_e.z,{className:q.visualisationTypeRadio,options:[{label:"Logs",value:"logs",description:"Show results in logs visualisation"},{label:"Table",value:"table",description:"Show results in table visualisation"}],size:"sm",value:this.state.visualisationType,onChange:this.onChangeVisualisation}))),loadingState:d?de.Gu.Loading:de.Gu.Done},t.createElement("div",{className:q.stickyNavigation},this.state.visualisationType!=="table"&&t.createElement("div",{className:q.logOptions},t.createElement(Ya.C,null,t.createElement(xe.I,{label:"Time",className:q.horizontalInlineLabel,transparent:!0},t.createElement(Fe.K,{value:H,onChange:this.onChangeTime,className:q.horizontalInlineSwitch,transparent:!0,id:`show-time_${R}`})),t.createElement(xe.I,{label:"Unique labels",className:q.horizontalInlineLabel,transparent:!0},t.createElement(Fe.K,{value:z,onChange:this.onChangeLabels,className:q.horizontalInlineSwitch,transparent:!0,id:`unique-labels_${R}`})),t.createElement(xe.I,{label:"Wrap lines",className:q.horizontalInlineLabel,transparent:!0},t.createElement(Fe.K,{value:te,onChange:this.onChangeWrapLogMessage,className:q.horizontalInlineSwitch,transparent:!0,id:`wrap-lines_${R}`})),t.createElement(xe.I,{label:"Prettify JSON",className:q.horizontalInlineLabel,transparent:!0},t.createElement(Fe.K,{value:ee,onChange:this.onChangePrettifyLogMessage,className:q.horizontalInlineSwitch,transparent:!0,id:`prettify_${R}`})),t.createElement(xe.I,{label:"Deduplication",className:q.horizontalInlineLabel,transparent:!0},t.createElement(_e.z,{options:Zs.map(rt=>({label:(0,_.capitalize)(rt),value:rt,description:Z._C[rt]})),value:oe,onChange:this.onChangeDedup,className:q.radioButtons}))),t.createElement("div",null,t.createElement(xe.I,{label:"Display results",className:q.horizontalInlineLabel,transparent:!0,disabled:P||d},t.createElement(_e.z,{options:[{label:"Newest first",value:U.uH.Descending,description:"Show results newest to oldest"},{label:"Oldest first",value:U.uH.Ascending,description:"Show results oldest to newest"}],value:D,onChange:this.onChangeLogsSortOrder,className:q.radioButtons})))),t.createElement("div",{ref:this.topLogsRef}),t.createElement(Zn,{logRows:a,meta:s||[],dedupStrategy:oe,dedupCount:vl,hasUnescapedContent:le,forceEscape:Q,displayedFields:I,onEscapeNewlines:this.onEscapeNewlines,clearDetectedFields:this.clearDetectedFields})),t.createElement("div",{className:(0,m.cx)(q.logsSection,this.state.visualisationType==="table"?q.logsTable:void 0)},this.state.visualisationType==="table"&&he&&t.createElement("div",{className:q.logRows,"data-testid":"logRowsTable"},t.createElement($s,{logsSortOrder:this.state.logsSortOrder,range:this.props.range,splitOpen:this.props.splitOpen,timeZone:u,width:o-80,logsFrames:this.props.logsFrames??[],onClickFilterLabel:c,onClickFilterOutLabel:p,panelState:this.props.panelState?.logs,theme:w,updatePanelState:this.updatePanelState,datasourceType:this.props.datasourceType})),this.state.visualisationType==="logs"&&he&&t.createElement("div",{className:B.$.featureToggles.logsInfiniteScrolling?q.scrollableLogRows:q.logRows,"data-testid":"logRows",ref:this.onLogsContainerRef},t.createElement(Xa,{loading:d,loadMoreLogs:V,range:this.props.range,timeZone:u,rows:a,scrollElement:this.state.logsContainer,sortOrder:D},t.createElement($n.k,{logRows:a,deduplicatedRows:yl,dedupStrategy:oe,onClickFilterLabel:c,onClickFilterOutLabel:p,showContextToggle:E,getRowContextQuery:k,showLabels:z,showTime:H,enableLogDetails:!0,forceEscape:Q,wrapLogMessage:te,prettifyLogMessage:ee,timeZone:u,getFieldLinks:S,logsSortOrder:D,displayedFields:I,onClickShowField:this.showField,onClickHideField:this.hideField,app:Ye.Jk.Explore,onLogRowHover:this.onLogRowHover,onOpenContext:this.onOpenContext,onPermalinkClick:this.onPermalinkClick,permalinkedRowId:this.props.panelState?.logs?.id,scrollIntoView:this.scrollIntoView,isFilterLabelActive:this.props.isFilterLabelActive,containerRendered:!!this.state.logsContainer,onClickFilterValue:this.props.onClickFilterValue,onClickFilterOutValue:this.props.onClickFilterOutValue}))),!d&&!he&&!v&&t.createElement("div",{className:q.logRows},t.createElement("div",{className:q.noData},"No logs found.",t.createElement(W.$n,{size:"sm",variant:"secondary",onClick:this.onClickScan},"Scan for older logs"))),v&&t.createElement("div",{className:q.logRows},t.createElement("div",{className:q.noData},t.createElement("span",null,El),t.createElement(W.$n,{size:"sm",variant:"secondary",onClick:this.onClickStopScan},"Stop scan"))),t.createElement(ws,{logsSortOrder:D,visibleRange:bl??f,absoluteRange:f,timeZone:u,onChangeTime:b,loading:d,queries:y??[],scrollToTopLogs:this.scrollToTopLogs,addResultsToCache:T,clearCache:x}))))}}const Js=(0,N.cV)(Ys),Xs=(e,o,n)=>({noData:(0,m.css)({"& > *":{marginLeft:"0.5em"}}),logOptions:(0,m.css)({display:"flex",justifyContent:"space-between",alignItems:"baseline",flexWrap:"wrap",backgroundColor:e.colors.background.primary,padding:`${e.spacing(1)} ${e.spacing(2)}`,borderRadius:e.shape.radius.default,margin:`${e.spacing(0,0,1)}`,border:`1px solid ${e.colors.border.medium}`}),headerButton:(0,m.css)({margin:`${e.spacing(.5,0,0,1)}`}),horizontalInlineLabel:(0,m.css)({"& > label":{marginRight:"0"}}),horizontalInlineSwitch:(0,m.css)({padding:`0 ${e.spacing(1)} 0 0`}),radioButtons:(0,m.css)({margin:"0"}),logsSection:(0,m.css)({display:"flex",flexDirection:"row",justifyContent:"space-between"}),logsTable:(0,m.css)({maxHeight:`${n}px`}),scrollableLogRows:(0,m.css)({overflowY:"scroll",width:"100%",maxHeight:"75vh"}),logRows:(0,m.css)({overflowX:`${o?"unset":"scroll"}`,overflowY:"visible",width:"100%"}),visualisationType:(0,m.css)({display:"flex",flex:"1",justifyContent:"space-between"}),visualisationTypeRadio:(0,m.css)({margin:`0 0 0 ${e.spacing(1)}`}),stickyNavigation:(0,m.css)({overflow:"visible",...B.$.featureToggles.logsInfiniteScrolling&&{marginBottom:"0px"}})}),Jt=500,Xt=100,_s=(0,Je.A)(()=>({logsEnter:(0,m.css)`
      label: logsEnter;
      position: absolute;
      opacity: 0;
      height: auto;
      width: 100%;
    `,logsEnterActive:(0,m.css)`
      label: logsEnterActive;
      opacity: 1;
      transition: opacity ${Jt}ms ease-out ${Xt}ms;
    `,logsExit:(0,m.css)`
      label: logsExit;
      position: absolute;
      opacity: 1;
      height: auto;
      width: 100%;
    `,logsExitActive:(0,m.css)`
      label: logsExitActive;
      opacity: 0;
      transition: opacity ${Jt}ms ease-out ${Xt}ms;
    `}));function oo(e){const{visible:o,children:n}=e,a=(0,t.useRef)(null),s=_s();return t.createElement(Ln.A,{in:o,mountOnEnter:!0,unmountOnExit:!0,timeout:Jt+Xt,classNames:{enter:s.logsEnter,enterActive:s.logsEnterActive,exit:s.logsExit,exitActive:s.logsExitActive},nodeRef:a},t.createElement("div",{ref:a},n))}class er extends t.PureComponent{constructor(){super(...arguments),this.state={dsInstances:{}},this.onChangeTime=o=>{const{exploreId:n,updateTimeRange:a}=this.props;a({exploreId:n,absoluteRange:o})},this.loadMoreLogs=o=>{const{exploreId:n,loadMoreLogs:a}=this.props;a({exploreId:n,absoluteRange:o})},this.getLogRowContext=async(o,n,a)=>{const{logsQueries:s}=this.props;if(!n.dataFrame.refId||!this.state.dsInstances[n.dataFrame.refId])return Promise.resolve([]);const r=this.state.dsInstances[n.dataFrame.refId];if(!(0,Z.Ol)(r))return Promise.resolve([]);const i=this.getQuery(s,n,r);return i?r.getLogRowContext(o,a,i):Promise.resolve([])},this.getLogRowContextQuery=async(o,n,a=!0)=>{const{logsQueries:s}=this.props;if(!o.dataFrame.refId||!this.state.dsInstances[o.dataFrame.refId])return Promise.resolve(null);const r=this.state.dsInstances[o.dataFrame.refId];if(!(0,Z.Ol)(r))return Promise.resolve(null);const i=this.getQuery(s,o,r);return i&&r.getLogRowContextQuery?r.getLogRowContextQuery(o,n,i,a):Promise.resolve(null)},this.getLogRowContextUi=(o,n)=>{const{logsQueries:a}=this.props;if(!o.dataFrame.refId||!this.state.dsInstances[o.dataFrame.refId])return t.createElement(t.Fragment,null);const s=this.state.dsInstances[o.dataFrame.refId];if(!(0,Z.Ol)(s))return t.createElement(t.Fragment,null);const r=this.getQuery(a,o,s);return r&&(0,Z.wj)(s)&&s.getLogRowContextUi?s.getLogRowContextUi(o,n,r):t.createElement(t.Fragment,null)},this.showContextToggle=o=>!o?.dataFrame.refId||!this.state.dsInstances[o.dataFrame.refId]?!1:(0,Z.Ol)(this.state.dsInstances[o.dataFrame.refId]),this.getFieldLinks=(o,n,a)=>{const{splitOpenFn:s,range:r}=this.props;return(0,Pe.QL)({field:o,rowIndex:n,splitOpenFn:s,range:r,dataFrame:a})},this.logDetailsFilterAvailable=()=>Object.values(this.state.dsInstances).some(o=>o?.modifyQuery||(0,Z._0)(o)||(0,Z.FP)(o)),this.filterValueAvailable=()=>Object.values(this.state.dsInstances).some(o=>(0,Z._0)(o)&&o?.getSupportedQueryModifications().includes("ADD_STRING_FILTER")),this.filterOutValueAvailable=()=>Object.values(this.state.dsInstances).some(o=>(0,Z._0)(o)&&o?.getSupportedQueryModifications().includes("ADD_STRING_FILTER_OUT")),this.addResultsToCache=()=>{this.props.addResultsToCache(this.props.exploreId)},this.clearCache=()=>{this.props.clearCache(this.props.exploreId)}}componentDidMount(){this.updateDataSourceInstances()}componentDidUpdate(o){o.logsQueries!==this.props.logsQueries&&this.updateDataSourceInstances()}updateDataSourceInstances(){const{logsQueries:o,datasourceInstance:n}=this.props;if(!o||!n)return;const a={};if(n.uid!==ct.uv){o.forEach(({refId:r})=>{a[r]=n}),this.setState({dsInstances:a});return}const s=[];for(const r of o){if(!r.datasource)continue;(!a[r.refId]||a[r.refId].uid!==r.datasource.uid)&&s.push(new Promise(l=>{(0,Le.l)().get(r.datasource).then(d=>{l({ds:d,refId:r.refId})})}))}s.length&&Promise.all(s).then(r=>{r.forEach(({ds:i,refId:l})=>{a[l]=i}),this.setState({dsInstances:a})})}getQuery(o,n,a){return(o??[]).find(s=>s.refId===n.dataFrame.refId&&s.datasource!=null&&s.datasource.type===a.type)}render(){const{loading:o,loadingState:n,logRows:a,logsMeta:s,logsSeries:r,logsQueries:i,loadSupplementaryQueryData:l,setSupplementaryQueryEnabled:d,onClickFilterLabel:c,onClickFilterOutLabel:p,onStartScanning:u,onStopScanning:v,absoluteRange:g,timeZone:E,visibleRange:f,scanning:b,range:S,width:w,splitOpenFn:y,isLive:x,exploreId:T,logsVolume:R,scrollElement:A}=this.props;return a?t.createElement(t.Fragment,null,t.createElement(oo,{visible:x},t.createElement(Et.S,{label:"Logs",loading:!1,isOpen:!0},t.createElement(Fn,{exploreId:T},O=>t.createElement(Za,{logRows:a,timeZone:E,stopLive:O.stop,isPaused:this.props.isPaused,onPause:O.pause,onResume:O.resume,onClear:O.clear,clearedAtIndex:this.props.clearedAtIndex})))),t.createElement(oo,{visible:!x},t.createElement(Js,{exploreId:T,datasourceType:this.props.datasourceInstance?.type,logRows:a,logsMeta:s,logsSeries:r,logsVolumeEnabled:R.enabled,onSetLogsVolumeEnabled:O=>d(T,O,Z.cF.LogsVolume),logsVolumeData:R.data,logsQueries:i,width:w,splitOpen:y,loading:o,loadingState:n,loadLogsVolumeData:()=>l(T,Z.cF.LogsVolume),onChangeTime:this.onChangeTime,loadMoreLogs:this.loadMoreLogs,onClickFilterLabel:this.logDetailsFilterAvailable()?c:void 0,onClickFilterOutLabel:this.logDetailsFilterAvailable()?p:void 0,onStartScanning:u,onStopScanning:v,absoluteRange:g,visibleRange:f,timeZone:E,scanning:b,scanRange:S.raw,showContextToggle:this.showContextToggle,getRowContext:this.getLogRowContext,getRowContextQuery:this.getLogRowContextQuery,getLogRowContextUi:this.getLogRowContextUi,getFieldLinks:this.getFieldLinks,addResultsToCache:this.addResultsToCache,clearCache:this.clearCache,eventBus:this.props.eventBus,panelState:this.props.panelState,logsFrames:this.props.logsFrames,scrollElement:A,isFilterLabelActive:this.logDetailsFilterAvailable()?this.props.isFilterLabelActive:void 0,range:S,onClickFilterValue:this.filterValueAvailable()?this.props.onClickFilterValue:void 0,onClickFilterOutValue:this.filterOutValueAvailable()?this.props.onClickFilterOutValue:void 0}))):null}}function tr(e,{exploreId:o}){const a=e.explore.panes[o],{logsResult:s,scanning:r,datasourceInstance:i,isLive:l,isPaused:d,clearedAtIndex:c,range:p,absoluteRange:u,supplementaryQueries:v}=a,g=(0,j.h1)(o)(e),E=a.panelsState,f=(0,ft.O)(e.user),b=v[Z.cF.LogsVolume];return{loading:g,logRows:s?.rows,logsMeta:s?.meta,logsSeries:s?.series,logsQueries:s?.queries,visibleRange:s?.visibleRange,scanning:r,timeZone:f,datasourceInstance:i,isLive:l,isPaused:d,clearedAtIndex:c,range:p,absoluteRange:u,logsVolume:b,panelState:E,logsFrames:a.queryResponse.logsFrames}}const nr={updateTimeRange:pe.GH,loadMoreLogs:pe.zY,addResultsToCache:j.He,clearCache:j.IL,loadSupplementaryQueryData:j.Az,setSupplementaryQueryEnabled:j.TO},or=(0,me.connect)(tr,nr)(er);function ar(e){const{queryResponse:o,timeZone:n,enabled:a,setLogsSampleEnabled:s,datasourceInstance:r,queries:i,splitOpen:l}=e,d=(0,N.of)(sr),c=v=>{s(v),(0,M.rR)("grafana_explore_logs_sample_toggle_clicked",{datasourceType:r?.type??"unknown",type:v?"open":"close"})},p=()=>{if(!r||!(0,Z.Nc)(r,Z.cF.LogsSample))return null;const v=i.map(E=>r.getSupplementaryQuery({type:Z.cF.LogsSample},E)).filter(E=>!!E);if(!v.length)return null;const g=()=>{l({queries:v,datasourceUid:r.uid}),(0,M.rR)("grafana_explore_logs_sample_split_button_clicked",{datasourceType:r?.type??"unknown",queriesCount:v.length})};return t.createElement(W.$n,{size:"sm",className:d.logSamplesButton,onClick:g},"Open logs in split view")};let u;if(o===void 0)u=null;else if(o.error!==void 0)u=t.createElement(Zt,{error:o.error,title:"Failed to load logs sample for this query"});else if(o.state===de.Gu.Loading)u=t.createElement("span",null,"Logs sample is loading...");else if(o.data.length===0||o.data.every(v=>v.length===0))u=t.createElement("span",null,"No logs sample data.");else{const v=(0,et.HT)(o.data);u=t.createElement(t.Fragment,null,t.createElement(p,null),t.createElement("div",{className:d.logContainer},t.createElement($n.k,{logRows:v.rows,dedupStrategy:U.fY.none,showLabels:ae.A.getBool(se.$.showLabels,!1),showTime:ae.A.getBool(se.$.showTime,!0),wrapLogMessage:ae.A.getBool(se.$.wrapLogMessage,!0),prettifyLogMessage:ae.A.getBool(se.$.prettifyLogMessage,!1),timeZone:n,enableLogDetails:!0})))}return o?.state!==de.Gu.NotStarted?t.createElement(Et.S,{label:t.createElement("div",null,"Logs sample",t.createElement(ye.m,{content:"Show log lines that contributed to visualized metrics"},t.createElement(ce.I,{name:"info-circle",className:d.infoTooltip}))),isOpen:a,collapsible:!0,onToggle:c},u):null}const sr=e=>({logSamplesButton:(0,m.css)`
      position: absolute;
      top: ${e.spacing(1)};
      right: ${e.spacing(1)};
    `,logContainer:(0,m.css)`
      overflow: scroll;
    `,infoTooltip:(0,m.css)`
      margin-left: ${e.spacing(1)};
    `}),rr=()=>{const e=(0,N.of)(ir);return t.createElement(t.Fragment,null,t.createElement(Nt._,{"data-testid":"explore-no-data",className:e.wrapper},t.createElement("span",{className:e.message},"No data")))},ir=e=>({wrapper:(0,m.css)({label:"no-data-card",padding:e.spacing(3),background:e.colors.background.primary,borderRadius:e.shape.radius.default,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",flexGrow:1}),message:(0,m.css)({fontSize:e.typography.h2.fontSize,padding:e.spacing(4),color:e.colors.text.disabled})});var lr=h(76442);function cr(e){return(0,m.css)({maxWidth:`${e.breakpoints.values.lg}px`,marginTop:e.spacing(2),alignSelf:"center"})}const dr=()=>{const e=(0,N.of)(cr),o=Vt.TP.hasPermission(F.AccessControlAction.DataSourcesCreate)&&Vt.TP.hasPermission(F.AccessControlAction.DataSourcesWrite),n="Explore requires at least one data source. Once you have added a data source, you can query it here.",a=t.createElement(t.Fragment,null,t.createElement(ce.I,{name:"rocket"}),t.createElement(t.Fragment,null," ProTip: You can also define data sources through configuration files. "),t.createElement("a",{href:"http://docs.grafana.org/administration/provisioning/?utm_source=explore#data-sources",target:"_blank",rel:"noreferrer",className:"text-link"},"Learn more")),s=t.createElement(W.z9,{size:"lg",href:"datasources/new",icon:"database",disabled:!o},"Add data source");return t.createElement(lr.c,{callToActionElement:s,className:e,footer:a,message:n})};var _t=h(52908),ur=h(95511),pr=h(94382);const hr=e=>({warningText:(0,m.css)`
    label: warningText;
    display: flex;
    align-items: center;
    font-size: ${e.typography.bodySmall.fontSize};
    color: ${e.colors.text.secondary};
  `});function mr(e){const{dataFrames:o,range:n,splitOpenFn:a,withTraceView:s,datasourceType:r}=e,i=(0,Pe.JQ)(n,a),l=(0,N.$j)(),d=(0,N.of)(hr),c=(0,Lt.we)({fieldConfig:{defaults:{},overrides:[]},data:o,replaceVariables:x=>x,theme:l}),{nodes:p}=(0,pr.d)(c),[u,v]=(0,vn.A)(!0),g=()=>{v(),(0,M.rR)("grafana_traces_node_graph_panel_clicked",{datasourceType:r,grafana_version:B.$.buildInfo.version,isExpanded:!open})},{height:E}=(0,_t.A)(),f=(0,t.useRef)(null),[b,S]=(0,t.useState)(250);(0,t.useEffect)(()=>{if(f.current){const{top:x}=f.current.getBoundingClientRect();S(x)}},[f]);const w=E-b-32,y=s&&p[0]?.length>1e3?t.createElement("span",{className:d.warningText}," (",p[0].length," nodes, can be slow to load)"):null;return t.createElement(Re.NR,{title:"Node graph",titleItems:y,collapsible:!!s,collapsed:s?u:!1,onToggleCollapse:s?g:void 0},t.createElement("div",{ref:f,style:s?{height:500}:{minHeight:600,height:w}},t.createElement(ur.F,{dataFrames:c,getLinks:i})))}function gr(e,{exploreId:o}){return{range:e.explore.panes[o].range}}const fr=(0,me.connect)(gr,{})(mr);var ot=h(25508),yr=h(77789),ao=h(31193),vr=h(44932);const br=e=>{const o=(0,K.qq)(e);return{getQueries:(0,ot.Mz)(o,n=>n.queries),getQueryResponse:(0,ot.Mz)(o,n=>n.queryResponse),getHistory:(0,ot.Mz)(o,n=>n.history),getEventBridge:(0,ot.Mz)(o,n=>n.eventBridge),getDatasourceInstanceSettings:(0,ot.Mz)(o,n=>(0,ao.tR)().getInstanceSettings(n.datasourceInstance?.uid))}},Er=({exploreId:e})=>{const o=(0,F.useDispatch)(),{getQueries:n,getDatasourceInstanceSettings:a,getQueryResponse:s,getHistory:r,getEventBridge:i}=(0,t.useMemo)(()=>br(e),[e]),l=(0,F.useSelector)(n),d=(0,F.useSelector)(a),c=(0,F.useSelector)(s),p=(0,F.useSelector)(r),u=(0,F.useSelector)(i),v=(0,t.useCallback)(()=>{o((0,j.Od)({exploreId:e}))},[o,e]),g=(0,t.useCallback)(w=>{o((0,j.bO)({exploreId:e,queries:w}))},[o,e]),E=(0,t.useCallback)(w=>{g([...l,{...w,refId:(0,yr.M)(l)}])},[g,l]),f=()=>{(0,M.rR)("grafana_explore_query_row_copy")},b=()=>{(0,M.rR)("grafana_explore_query_row_remove")},S=w=>{(0,M.rR)("grafana_query_row_toggle",w===void 0?{}:{queryEnabled:w})};return t.createElement(vr.L,{dsSettings:d,queries:l,onQueriesChange:g,onAddQuery:E,onRunQueries:v,onQueryCopied:f,onQueryRemoved:b,onQueryToggled:S,data:c,app:Ye.Jk.Explore,history:p,eventBus:u,queryRowWrapper:(w,y)=>t.createElement(ge,{title:y,icon:"arrow",key:y,panelId:"Queries",customTopOffset:-10,level:"child"},w)})};var It=h(72574),en=h(2913),xr=h(15054),Sr=h(91793),Cr=h(9651),wr=h(9663),so=h(57408);const at={wrapper:(0,m.css)`
    height: 100%;
    overflow: scroll;
  `,switchWrapper:(0,m.css)`
    display: flex;
    flex-direction: row;
    margin-bottom: 0;
  `,switchLabel:(0,m.css)`
    margin-left: 15px;
    margin-bottom: 0;
  `,switch:(0,m.css)`
    margin-left: 10px;
  `,resultCount:(0,m.css)`
    margin-bottom: 4px;
  `,header:(0,m.css)`
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    font-size: 12px;
    line-height: 1.25;
  `},Rr=480,Tr=2,Lr=e=>{const{tableResult:o}=e,n=(0,_.cloneDeep)(o),a=(0,t.useRef)(null),s=n.fields.filter(g=>g.name.includes("Value")),r=(0,so.E)(n),{width:i}=(0,_t.A)(),[l,d]=(0,t.useState)(i<=Rr||s.length>Tr),c=()=>{d(!l);const g={isExpanded:!l};(0,M.rR)("grafana_explore_prometheus_instant_query_ui_raw_toggle_expand",g)};(0,t.useEffect)(()=>{a.current?.resetAfterIndex(0,!0)},[l]);const p=g=>{if(g<10){let b=0;for(let S=0;S<g;S++)b+=u(S,!0);return Math.min(600,b)}return 600},u=(g,E)=>{if(!E)return 32;const S=r[g];return 1.5*32+(Object.keys(S).length-s.length)*22},v=`isExpandedView ${(0,t.useId)()}`;return t.createElement("section",null,t.createElement("header",{className:at.header},t.createElement(ie.D,{className:at.switchWrapper,label:"Expand results",htmlFor:"isExpandedView"},t.createElement("div",{className:at.switch},t.createElement(Fe.d,{onChange:c,id:v,value:l,label:"Expand results"}))),t.createElement("div",{className:at.resultCount},"Result series: ",r.length)),t.createElement("div",{role:"table"},t.createElement(t.Fragment,null,s.length>1&&!l&&t.createElement(Cr.d,{valueLabels:s,expanded:l}),t.createElement(Sr._m,{ref:a,itemCount:r.length,className:at.wrapper,itemSize:g=>u(g,l),height:p(r.length),width:"100%"},({index:g,style:E})=>{let f;return l&&(f=s.filter(b=>{const S=r[g][b.name];return S&&S!==so.M})),t.createElement("div",{role:"row",style:{...E,overflow:"hidden"}},t.createElement(wr.Ay,{isExpandedView:l,valueLabels:f,totalNumberOfValues:s.length,listKey:r[g].__name__,listItemData:r[g]}))}))))};function Ir(e,{exploreId:o}){const a=e.explore.panes[o],{tableResult:s,rawPrometheusResult:r,range:i,queryResponse:l}=a,d=r?[r]:[],c=(s?.length??0)>0&&r?s:d;return{loading:l.state,tableResult:c,range:i}}const Fr=(0,me.connect)(Ir,{});class Or extends t.PureComponent{constructor(o){super(o),this.onChangeResultsStyle=n=>{this.setState({resultsStyle:n})},this.renderLabel=()=>{const n=(0,m.css)({display:"flex",justifyContent:"space-between",flex:"1"}),a=Bt.jH.map(s=>({value:s,label:s[0].toUpperCase()+s.slice(1).replace(/_/," ")}));return t.createElement("div",{className:n},t.createElement(_e.z,{onClick:()=>{const s={state:this.state.resultsStyle===F.TABLE_RESULTS_STYLE.table?F.TABLE_RESULTS_STYLE.raw:F.TABLE_RESULTS_STYLE.table};(0,M.rR)("grafana_explore_prometheus_instant_query_ui_toggle_clicked",s)},size:"sm",options:a,value:this.state?.resultsStyle,onChange:this.onChangeResultsStyle}))},o.showRawPrometheus&&(this.state={resultsStyle:F.TABLE_RESULTS_STYLE.raw})}getTableHeight(){const{tableResult:o}=this.props;return!o||o.length===0?200:Math.max(Math.min(600,o[0].length*35)+35)}render(){const{loading:o,onCellFilterAdded:n,tableResult:a,width:s,splitOpenFn:r,range:i,ariaLabel:l,timeZone:d}=this.props,c=this.getTableHeight(),p=s-en.config.theme.panelPadding*2-xr.IZ;let u=a;const v=(0,Pe.YV)(r,i);u?.length&&(u=(0,Lt.we)({data:u,timeZone:d,theme:en.config.theme2,replaceVariables:(0,It.w)().replace.bind((0,It.w)()),fieldConfig:{defaults:{},overrides:[]},dataLinkPostProcessor:v}));const g=u?.filter(S=>!!S&&S.length!==0),E=this.state.resultsStyle===F.TABLE_RESULTS_STYLE.raw?"Raw":"Table",f=this.state?.resultsStyle!==void 0?this.renderLabel():"Table",b=!this.state?.resultsStyle||this.state?.resultsStyle===F.TABLE_RESULTS_STYLE.table;return t.createElement(Re.NR,{title:E,actions:f,loadingState:o},g?.length&&t.createElement(t.Fragment,null,b&&t.createElement(qt.X,{ariaLabel:l,data:g[0],width:p,height:c,onCellFilterAdded:n}),this.state?.resultsStyle===F.TABLE_RESULTS_STYLE.raw&&t.createElement(Lr,{tableResult:g[0]})),!g?.length&&t.createElement(Ut,{metaItems:[{value:"0 series returned"}]}))}}const Dr=Fr(Or);var Ar=h(22669);const Nr=e=>{const o=(0,t.useRef)(null),n={transition:`opacity ${e.duration}ms linear`,opacity:0},a={exited:{opacity:0,display:"none"},entering:{opacity:0},entered:{opacity:1},exiting:{opacity:0}};return t.createElement(Ar.Ay,{in:e.in,timeout:e.duration,unmountOnExit:e.unmountOnExit||!1,onExited:e.onExited,nodeRef:o},s=>t.createElement("div",{ref:o,style:{...n,...a[s]}},e.children))},kr=e=>{const{queryError:o}=e,n=!!o,a=n?100:10,s=o?"Query error":"Unknown error",r=o?.message||o?.data?.message||null;return t.createElement(Nr,{in:n,duration:a},t.createElement(Ge.F,{severity:"error",title:s,topSpacing:2},r))};function Pr(e){const o=(0,F.useSelector)(a=>a.explore.panes[e.exploreId].queryResponse),n=o?.state===de.Gu.Error?o?.error:void 0;return n?.refId?null:t.createElement(kr,{queryError:n})}var Mr=h(13390);const zr=e=>({containerMargin:(0,m.css)({display:"flex",flexWrap:"wrap",gap:e.spacing(1),marginTop:e.spacing(2)})});function Hr(e){const o=(0,N.$j)(),n=zr(o),{drawerOpened:a,setDrawerOpened:s,queryLibraryAvailable:r}=Ze(),i=!e.richHistoryRowButtonHidden&&!r;return t.createElement("div",{className:n.containerMargin},!e.addQueryRowButtonHidden&&t.createElement(ne.I,{variant:"canvas","aria-label":(0,C.t)("explore.secondary-actions.query-add-button-aria-label","Add query"),onClick:e.onClickAddQueryRowButton,disabled:e.addQueryRowButtonDisabled,icon:"plus"},t.createElement(C.x6,{i18nKey:"explore.secondary-actions.query-add-button"},"Add query")),i&&t.createElement(ne.I,{variant:a?"active":"canvas","aria-label":(0,C.t)("explore.secondary-actions.query-history-button-aria-label","Query history"),onClick:()=>s(!a),"data-testid":Mr.X.QueryTab.queryHistoryButton,icon:"history"},t.createElement(C.x6,{i18nKey:"explore.secondary-actions.query-history-button"},"Query history")),t.createElement(ne.I,{variant:e.queryInspectorButtonActive?"active":"canvas","aria-label":(0,C.t)("explore.secondary-actions.query-inspector-button-aria-label","Query inspector"),onClick:e.onClickQueryInspectorButton,icon:"info-circle"},t.createElement(C.x6,{i18nKey:"explore.secondary-actions.query-inspector-button"},"Query inspector")))}var ro=h(65885);function $r(e,{exploreId:o}){const a=e.explore.panes[o],{tableResult:s,range:r}=a,i=(0,j.h1)(o);return{loading:s&&s.length>0?!1:i,tableResult:s,range:r}}const Br=(0,me.connect)($r,{});class io extends t.PureComponent{constructor(){super(...arguments),this.hasSubFrames=o=>o.fields.some(n=>n.type===tt.PU.nestedFrames)}getTableHeight(o,n){return o===0?200:Math.min(600,Math.max(o*36,n?300:0)+40+46)}getTableTitle(o,n,a){let s=n.name;return!s&&(o?.length??0)>1&&(s=n.refId||`${a}`),s?(0,C.t)("explore.table.title-with-name","Table - {{name}}",{name:s,interpolation:{escapeValue:!1}}):(0,C.t)("explore.table.title","Table")}render(){const{loading:o,onCellFilterAdded:n,tableResult:a,width:s,splitOpenFn:r,range:i,ariaLabel:l,timeZone:d,theme:c}=this.props;let p=(0,ro.gy)(a)?(0,ro.S5)(a):a;const u=(0,Pe.YV)(r,i);p?.length&&(p=(0,Lt.we)({data:p,timeZone:d,theme:en.config.theme2,replaceVariables:(0,It.w)().replace.bind((0,It.w)()),fieldConfig:{defaults:{},overrides:[]},dataLinkPostProcessor:u}));const v=p?.filter(g=>!!g&&g.length!==0);return t.createElement(t.Fragment,null,v&&v.length===0&&t.createElement(Re.NR,{title:(0,C.t)("explore.table.title","Table"),width:s,height:200},()=>t.createElement(Ut,{metaItems:[{value:(0,C.t)("explore.table.no-data","0 series returned")}]})),v&&v.length>0&&t.createElement("div",{className:(0,m.css)({display:"flex",flexDirection:"column",gap:c.spacing(1)})},v.map((g,E)=>t.createElement(Re.NR,{key:g.refId||`table-${E}`,title:this.getTableTitle(p,g,E),width:s,height:this.getTableHeight(g.length,this.hasSubFrames(g)),loadingState:o?de.Gu.Loading:void 0},(f,b)=>t.createElement(qt.X,{ariaLabel:l,data:g,width:f,height:b,onCellFilterAdded:n})))))}}const Tl=(0,N.cV)(io),Vr=(0,N.cV)(Br(io));var Wr=h(92599),Qr=h(35090);function jr(e){const o=e.dataFrames[0],{dataFrames:n,splitOpenFn:a,exploreId:s,scrollElement:r}=e,i=(0,t.useMemo)(()=>(0,Qr.L)(o),[o]),l=(0,F.useSelector)(d=>d.explore.panes[e.exploreId]?.datasourceInstance??void 0);return i?t.createElement(Re.NR,{padding:"none",title:"Trace"},t.createElement(Wr.V,{exploreId:s,dataFrames:n,splitOpenFn:a,scrollElement:r,traceProp:i,datasource:l})):null}const Ur=e=>({exploreMain:(0,m.css)({label:"exploreMain",position:"relative",marginTop:"21px",display:"flex",flexDirection:"column",gap:e.spacing(1)}),queryContainer:(0,m.css)({label:"queryContainer",padding:e.spacing(1)}),exploreContainer:(0,m.css)({label:"exploreContainer",display:"flex",flexDirection:"column",paddingRight:e.spacing(2),marginBottom:e.spacing(2)}),wrapper:(0,m.css)({position:"absolute",top:0,left:e.spacing(2),right:0,bottom:0,display:"flex"})});class qr extends t.PureComponent{constructor(o){super(o),this.onChangeTime=n=>{const{updateTimeRange:a,exploreId:s}=this.props;a({exploreId:s,rawRange:n})},this.onClickExample=n=>{this.props.setQueries(this.props.exploreId,[n])},this.onCellFilterAdded=n=>{const{value:a,key:s,operator:r}=n;r===gt.mc&&this.onClickFilterLabel(s,a),r===gt.Zi&&this.onClickFilterOutLabel(s,a)},this.onContentOutlineToogle=()=>{this.setState(n=>((0,M.rR)("explore_toolbar_contentoutline_clicked",{item:"outline",type:n.contentOutlineVisible?"close":"open"}),{contentOutlineVisible:!n.contentOutlineVisible}))},this.isFilterLabelActive=async(n,a,s)=>{const r=this.props.queries.find(l=>l.refId===s);if(!r)return!1;const i=await(0,Le.l)().get(r.datasource);return!!((0,Z.FP)(i)&&i.queryHasFilter(r,{key:n,value:a.toString()}))},this.onClickFilterLabel=(n,a,s)=>{this.onModifyQueries({type:"ADD_FILTER",options:{key:n,value:a.toString()},frame:s},s?.refId)},this.onClickFilterOutLabel=(n,a,s)=>{this.onModifyQueries({type:"ADD_FILTER_OUT",options:{key:n,value:a.toString()},frame:s},s?.refId)},this.onClickFilterValue=(n,a)=>{this.onModifyQueries({type:"ADD_STRING_FILTER",options:{value:n.toString()}},a)},this.onClickFilterOutValue=(n,a)=>{this.onModifyQueries({type:"ADD_STRING_FILTER_OUT",options:{value:n.toString()}},a)},this.onClickAddQueryRowButton=()=>{const{exploreId:n,queryKeys:a}=this.props;this.props.addQueryRow(n,a.length)},this.onModifyQueries=(n,a)=>{const s=async(r,i)=>{if(a&&a!==r.refId)return r;const{datasource:l}=r;if(l==null)return r;const d=await(0,Le.l)().get(l),c=["ADD_FILTER","ADD_FILTER_OUT"];return(0,Z.FP)(d)&&c.includes(i.type)?d.toggleQueryFilter(r,{type:i.type==="ADD_FILTER"?"FILTER_FOR":"FILTER_OUT",options:i.options??{},frame:i.frame}):d.modifyQuery?d.modifyQuery(r,i):r};this.props.modifyQueries(this.props.exploreId,n,s)},this.onResize=n=>{this.props.changeSize(this.props.exploreId,n)},this.onStartScanning=()=>{this.props.scanStart(this.props.exploreId)},this.onStopScanning=()=>{this.props.scanStopAction({exploreId:this.props.exploreId})},this.onUpdateTimeRange=n=>{const{exploreId:a,updateTimeRange:s}=this.props;s({exploreId:a,absoluteRange:n})},this.onSplitOpen=n=>async a=>{if(this.props.splitOpen(a),a&&this.props.datasourceInstance){const s=(await(0,Le.l)().get(a.datasourceUid)).type,r=this.props.datasourceInstance.uid===ct.uv?(0,_.get)(this.props.queries,"0.datasource.type"):this.props.datasourceInstance.type,i={origin:"panel",panelType:n,source:r,target:s,exploreId:this.props.exploreId};(0,M.rR)("grafana_explore_split_view_opened",i)}},this.state={contentOutlineVisible:!1},this.graphEventBus=o.eventBus.newScopedBus("graph",{onlyLocal:!1}),this.logsEventBus=o.eventBus.newScopedBus("logs",{onlyLocal:!1})}renderEmptyState(o){return t.createElement("div",{className:(0,m.cx)(o)},t.createElement(dr,null))}renderNoData(){return t.createElement(rr,null)}renderCustom(o){const{timeZone:n,queryResponse:a,absoluteRange:s,eventBus:r}=this.props,i=(0,_.groupBy)(a?.customFrames,"meta.preferredVisualisationPluginId");return Object.entries(i).map(([l,d],c)=>t.createElement(ge,{panelId:l,title:l,icon:"plug",key:c},t.createElement(ua,{key:c,timeZone:n,pluginId:l,frames:d,state:a.state,absoluteRange:s,height:400,width:o,splitOpenFn:this.onSplitOpen(l),eventBus:r})))}renderGraphPanel(o){const{graphResult:n,absoluteRange:a,timeZone:s,queryResponse:r,showFlameGraph:i}=this.props;return t.createElement(ge,{panelId:"Graph",title:"Graph",icon:"graph-bar"},t.createElement(Ba.y,{data:n,height:i?180:400,width:o,absoluteRange:a,timeZone:s,onChangeTime:this.onUpdateTimeRange,annotations:r.annotations,splitOpenFn:this.onSplitOpen("graph"),loadingState:r.state,eventBus:this.graphEventBus}))}renderTablePanel(o){const{exploreId:n,timeZone:a}=this.props;return t.createElement(ge,{panelId:"Table",title:"Table",icon:"table"},t.createElement(Vr,{ariaLabel:Qe.Tp.pages.Explore.General.table,width:o,exploreId:n,onCellFilterAdded:this.onCellFilterAdded,timeZone:a,splitOpenFn:this.onSplitOpen("table")}))}renderRawPrometheus(o){const{exploreId:n,datasourceInstance:a,timeZone:s}=this.props;return t.createElement(ge,{panelId:"Raw Prometheus",title:"Raw Prometheus",icon:"gf-prometheus"},t.createElement(Dr,{showRawPrometheus:!0,ariaLabel:Qe.Tp.pages.Explore.General.table,width:o,exploreId:n,onCellFilterAdded:a?.modifyQuery?this.onCellFilterAdded:void 0,timeZone:s,splitOpenFn:this.onSplitOpen("table")}))}renderLogsPanel(o){const{exploreId:n,syncedTimes:a,theme:s,queryResponse:r}=this.props,i=parseInt(s.spacing(2).slice(0,-2),10),l=(0,m.css)({display:"flex",flexDirection:"column",gap:s.spacing(1)});return t.createElement(ge,{panelId:"Logs",title:"Logs",icon:"gf-logs",className:l},t.createElement(or,{exploreId:n,loadingState:r.state,syncedTimes:a,width:o-i,onClickFilterLabel:this.onClickFilterLabel,onClickFilterOutLabel:this.onClickFilterOutLabel,onStartScanning:this.onStartScanning,onStopScanning:this.onStopScanning,eventBus:this.logsEventBus,splitOpenFn:this.onSplitOpen("logs"),scrollElement:this.scrollElement,isFilterLabelActive:this.isFilterLabelActive,onClickFilterValue:this.onClickFilterValue,onClickFilterOutValue:this.onClickFilterOutValue}))}renderLogsSamplePanel(){const{logsSample:o,timeZone:n,setSupplementaryQueryEnabled:a,exploreId:s,datasourceInstance:r,queries:i}=this.props;return t.createElement(ge,{panelId:"Logs Sample",title:"Logs Sample",icon:"gf-logs"},t.createElement(ar,{queryResponse:o.data,timeZone:n,enabled:o.enabled,queries:i,datasourceInstance:r,splitOpen:this.onSplitOpen("logsSample"),setLogsSampleEnabled:l=>a(s,l,Z.cF.LogsSample)}))}renderNodeGraphPanel(){const{exploreId:o,showTrace:n,queryResponse:a,datasourceInstance:s}=this.props,r=s?s?.type:"unknown";return t.createElement(ge,{panelId:"Node Graph",title:"Node Graph",icon:"code-branch"},t.createElement(fr,{dataFrames:a.nodeGraphFrames,exploreId:o,withTraceView:n,datasourceType:r,splitOpenFn:this.onSplitOpen("nodeGraph")}))}renderFlameGraphPanel(){const{queryResponse:o}=this.props;return t.createElement(ge,{panelId:"Flame Graph",title:"Flame Graph",icon:"fire"},t.createElement(Ha,{dataFrames:o.flameGraphFrames}))}renderTraceViewPanel(){const{queryResponse:o,exploreId:n}=this.props,a=o.series.filter(s=>s.meta?.preferredVisualisationType==="trace");return a.length&&t.createElement(ge,{panelId:"Traces",title:"Traces",icon:"file-alt"},t.createElement(jr,{exploreId:n,dataFrames:a,splitOpenFn:this.onSplitOpen("traceView"),scrollElement:this.scrollElement}))}render(){const{datasourceInstance:o,exploreId:n,graphResult:a,queryResponse:s,isLive:r,theme:i,showMetrics:l,showTable:d,showRawPrometheus:c,showLogs:p,showTrace:u,showCustom:v,showNodeGraph:g,showFlameGraph:E,showLogsSample:f,correlationEditorDetails:b,correlationEditorHelperData:S,showQueryInspector:w,setShowQueryInspector:y}=this.props,{contentOutlineVisible:x}=this.state,T=Ur(i),R=s&&s.state!==de.Gu.NotStarted,A=!(0,Ue.gQ)().queryHistoryAvailable,O=s.state===de.Gu.Done&&[s.logsFrames,s.graphFrames,s.nodeGraphFrames,s.flameGraphFrames,s.tableFrames,s.rawPrometheusFrames,s.traceFrames,s.customFrames].every(H=>H.length===0);let k;const V=b?.editorMode;return!!(V||b?.correlationDirty)&&S!==void 0&&(k=t.createElement(sa,{exploreId:n,correlations:S})),t.createElement(Ko,{refreshDependencies:this.props.queries},t.createElement(Ma,{exploreId:n,onChangeTime:this.onChangeTime,onContentOutlineToogle:this.onContentOutlineToogle,isContentOutlineOpen:x}),t.createElement("div",{style:{position:"relative",height:"100%",paddingLeft:i.spacing(2)}},t.createElement("div",{className:T.wrapper},x&&t.createElement(Jo,{scroller:this.scrollElement,panelId:`content-outline-container-${n}`}),t.createElement(mt.E,{testId:Qe.Tp.pages.Explore.General.scrollView,scrollRefCallback:H=>this.scrollElement=H||void 0,hideHorizontalTrack:!0},t.createElement("div",{className:T.exploreContainer},o?t.createElement(t.Fragment,null,t.createElement(ge,{panelId:"Queries",title:"Queries",icon:"arrow",mergeSingleChild:!0},t.createElement(Nt._,{className:T.queryContainer},k,t.createElement(Er,{exploreId:n}),t.createElement(Hr,{addQueryRowButtonDisabled:r||V&&o.meta.mixed,addQueryRowButtonHidden:!1,richHistoryRowButtonHidden:A,queryInspectorButtonActive:w,onClickAddQueryRowButton:this.onClickAddQueryRowButton,onClickQueryInspectorButton:()=>y(!w)}),t.createElement(Pr,{exploreId:n}))),t.createElement(jo.Ay,{onResize:this.onResize,disableHeight:!0},({width:H})=>H===0?null:t.createElement("main",{className:(0,m.cx)(T.exploreMain),style:{width:H}},t.createElement(Y.Xw,null,R&&t.createElement(t.Fragment,null,l&&a&&t.createElement(Y.Xw,null,this.renderGraphPanel(H)),c&&t.createElement(Y.Xw,null,this.renderRawPrometheus(H)),d&&t.createElement(Y.Xw,null,this.renderTablePanel(H)),p&&t.createElement(Y.Xw,null,this.renderLogsPanel(H)),g&&t.createElement(Y.Xw,null,this.renderNodeGraphPanel()),E&&t.createElement(Y.Xw,null,this.renderFlameGraphPanel()),u&&t.createElement(Y.Xw,null,this.renderTraceViewPanel()),f&&t.createElement(Y.Xw,null,this.renderLogsSamplePanel()),v&&t.createElement(Y.Xw,null,this.renderCustom(H)),O&&t.createElement(Y.Xw,null,this.renderNoData())))))):this.renderEmptyState(T.exploreContainer))))))}}function Gr(e,{exploreId:o}){const n=e.explore,{syncedTimes:a}=n,s=n.panes[o],r=(0,ft.O)(e.user),{datasourceInstance:i,queryKeys:l,queries:d,isLive:c,graphResult:p,tableResult:u,logsResult:v,showLogs:g,showMetrics:E,showTable:f,showTrace:b,showCustom:S,absoluteRange:w,queryResponse:y,showNodeGraph:x,showFlameGraph:T,showRawPrometheus:R,supplementaryQueries:A,correlationEditorHelperData:O}=s,k=(0,j.h1)(o)(e),V=A[Z.cF.LogsSample],z=!!(V.dataProvider!==void 0&&!v&&(p||u));return{datasourceInstance:i,queryKeys:l,queries:d,isLive:c,graphResult:p,logsResult:v??void 0,absoluteRange:w,queryResponse:y,syncedTimes:a,timeZone:r,showLogs:g,showMetrics:E,showTable:f,showTrace:b,showCustom:S,showNodeGraph:x,showRawPrometheus:R,showFlameGraph:T,splitted:(0,K.pF)(e),loading:k,logsSample:V,showLogsSample:z,correlationEditorHelperData:O,correlationEditorDetails:n.correlationEditorDetails}}const Kr={changeSize:we.QZ,modifyQueries:j.PD,scanStart:j.GI,scanStopAction:j.q9,setQueries:j.Rk,updateTimeRange:pe.GH,addQueryRow:j._0,splitOpen:G.ve,setSupplementaryQueryEnabled:j.TO},Zr=(0,me.connect)(Gr,Kr),Yr=(0,N.cV)(Zr(qr));var lo=h(60734),Jr=h(61453),Xr=h(82344),_r=h(61396),ei=h(32067),ti=h(90820);function ni(e){const{onClose:o,queryResponse:n,timeZone:a,isMixed:s,exploreId:r}=e,[i,l]=(0,t.useState)({withTransforms:!1,withFieldConfig:!0}),d=n?.series||[];let c=n?.errors;!c?.length&&n?.error&&(c=[n.error]);const p=(0,N.of)(si);(0,t.useEffect)(()=>{(0,M.rR)("grafana_explore_query_inspector_opened")},[]);const u={label:"Stats",value:"stats",icon:"chart-line",content:t.createElement(ei.N,{data:n,timeZone:n?.request?.timezone??U.vp})},v={label:"JSON",value:"json",icon:"brackets-curly",content:t.createElement(_r.w,{data:n,onClose:o})},g={label:"Data",value:"data",icon:"database",content:t.createElement(Jr.q,{data:d,dataName:"Explore",isLoading:n.state===de.Gu.Loading,options:i,timeZone:a,app:Ye.Jk.Explore,formattedDataDescription:"Matches the format in the panel",onOptionsChange:l})},E={label:"Query",value:"query",icon:"info-circle",content:t.createElement("div",{className:p.queryInspectorWrapper},t.createElement(ti.e,{instanceId:s?(0,ct.qM)(0,(0,je.uq)(r)):(0,je.uq)(r),data:n,onRefreshQuery:()=>e.runQueries({exploreId:r})}))},f=[u,E,v,g];if(c?.length){const b={label:"Error",value:"error",icon:"exclamation-triangle",content:t.createElement(Xr.y,{errors:c})};f.push(b)}return t.createElement(fn,null,t.createElement(lo.q,{tabs:f,onClose:o,closeIconTooltip:"Close query inspector"}))}function oi(e,{exploreId:o}){const a=e.explore.panes[o],{queryResponse:s}=a;return{queryResponse:s,isMixed:a.datasourceInstance?.meta.mixed||!1}}const ai={runQueries:j.Od},si=e=>({queryInspectorWrapper:(0,m.css)({paddingBottom:e.spacing(3)})}),ri=(0,me.connect)(oi,ai)(ni),ii=(0,m.css)({label:"explorePaneContainer",display:"flex",flexDirection:"column",minWidth:"600px",height:"100%"});function li({exploreId:e}){ui(e);const o=(0,t.useRef)(new Qo.o),n=(0,t.useRef)(null),[a,s]=(0,t.useState)(!1);return(0,t.useEffect)(()=>{const r=o.current;return()=>r.removeAllListeners()},[]),t.createElement(mt.E,{hideVerticalTrack:!0},t.createElement("div",{className:ii,ref:n,"data-testid":Qe.Tp.pages.Explore.General.container},t.createElement(Yr,{exploreId:e,eventBus:o.current,showQueryInspector:a,setShowQueryInspector:s}),a&&t.createElement(ri,{exploreId:e,onClose:()=>s(!1),timeZone:(0,yn.O)()})))}function ci(e,o){return{pane:e.explore.panes[o.exploreId]}}const di=(0,me.connect)(ci)(li);function ui(e){const o=(0,t.useMemo)(()=>(0,K.qq)(e),[e]),n=(0,t.useRef)();n.current=(0,F.useSelector)(o),(0,t.useEffect)(()=>()=>{(0,je._u)(n.current?.querySubscription)},[])}var Se=h(72433),re=h(81523),co=h(69529),pi=h(82537),hi=h(56389);const mi=()=>({kind:"QueryTemplateList",apiVersion:"peakq.grafana.app/v0alpha1",metadata:{resourceVersion:"1783293408052252672",remainingItemCount:0},items:[{kind:"QueryTemplate",apiVersion:"peakq.grafana.app/v0alpha1",metadata:{name:"AElastic2nkf9",generateName:"AElastic",namespace:"default",uid:"65327fce-c545-489d-ada5-16f909453d12",resourceVersion:"1783293341664808960",creationTimestamp:"2024-04-25T20:32:58Z"},spec:{title:"Elastic Query Template",targets:[{variables:{},properties:{refId:"A",datasource:{type:"elasticsearch",uid:"elastic-uid"},alias:"",metrics:[{id:"1",type:"count"}],bucketAggs:[{field:"@timestamp",id:"2",settings:{interval:"auto"},type:"date_histogram"}],timeField:"@timestamp",query:"test:test "}}]}},{kind:"QueryTemplate",apiVersion:"peakq.grafana.app/v0alpha1",metadata:{name:"ALoki296tj",generateName:"ALoki",namespace:"default",uid:"3e71de65-efa7-40e3-8f23-124212cca455",resourceVersion:"1783214217151647744",creationTimestamp:"2024-04-25T11:05:55Z"},spec:{title:"Loki Query Template",vars:[{key:"__value",defaultValues:[""],valueListDefinition:{customValues:""}}],targets:[{variables:{__value:[{path:"$.datasource.jsonData.derivedFields.0.url",position:{start:0,end:14},format:"raw"},{path:"$.datasource.jsonData.derivedFields.1.url",position:{start:0,end:14},format:"raw"},{path:"$.datasource.jsonData.derivedFields.2.url",position:{start:0,end:14},format:"raw"}]},properties:{refId:"A",datasource:{type:"loki",uid:"loki-uid"},queryType:"range",editorMode:"code",expr:'{test="test"}'}}]}}]}),gi={all:{url:hi.C1,response:mi()}},{useAllQueryTemplatesQuery:fi,useAddQueryTemplateMutation:yi}=pi.g;function vi(){return B.$.featureToggles.queryLibrary}const Fl={data:gi};var bi=h(48840),st=h(76412);const Ei={setQueries:j.Rk,changeDatasource:Ae.wh},xi=(0,me.connect)(void 0,Ei);function Si({rootDatasourceUid:e,queries:o,disabled:n=!1,changeDatasource:a,setQueries:s}){const[r,i]=(0,t.useState)(!1),l=(0,F.useSelector)(K.pF),d=(0,F.useSelector)(K.Kl),c=(0,F.useSelector)(K.K6),p=(E,f)=>!d.dsToExplore.find(b=>b.datasource.uid===E)?.exploreIds.includes(f),u=(E,f)=>f!==void 0&&E!==void 0&&p(f,E)?{fallbackText:"Switch data source and run query",translation:(0,st.t)("explore.run-query.switch-datasource-button","Switch data source and run query")}:{fallbackText:"Run query",translation:(0,st.t)("explore.run-query.run-query-button","Run query")},v=async E=>{const f=p(e,E);f&&await a({exploreId:E,datasource:e}),s(E,o),(0,M.rR)("grafana_explore_query_history_run",{queryHistoryEnabled:B.$.queryHistoryEnabled,differentDataSource:f})},g=()=>{const E=n||o.length===0||e===void 0;if(l){const f=t.createElement(fe.W,null,c.map((b,S)=>{const w=u(b[0],e),y=S===0?(0,st.t)("explore.run-query.left-pane","Left pane"):(0,st.t)("explore.run-query.right-pane","Right pane");return t.createElement(fe.W.Item,{key:S,ariaLabel:w.fallbackText,onClick:()=>{v(b[0])},label:`${y}: ${w.translation}`,disabled:E||b[0]===void 0})}));return t.createElement(Ke.m,{onVisibleChange:b=>i(b),placement:"bottom-start",overlay:f},t.createElement(ne.I,{"aria-label":"run query options",variant:"canvas",isOpen:r},(0,st.t)("explore.run-query.run-query-button","Run query")))}else{const f=d.exploreToDS[0]?.exploreId,b=u(f,e);return t.createElement(W.$n,{variant:"secondary","aria-label":b.translation,onClick:()=>v(f),disabled:E||f===void 0},b.translation)}};return t.createElement(t.Fragment,null,g())}const uo=xi(Si);function Ci({query:e,rootDatasourceUid:o}){return t.createElement(uo,{queries:e?[e]:[],rootDatasourceUid:o})}const wi=Ci;var Ri=h(12942);const Ft=()=>(0,N.of)(Ti),Ti=e=>({logo:(0,m.css)({marginRight:e.spacing(2),width:"16px"}),header:(0,m.css)({margin:0,fontSize:e.typography.h5.fontSize,color:e.colors.text.secondary}),mainText:(0,m.css)({margin:0,fontSize:e.typography.body.fontSize,textOverflow:"ellipsis"}),otherText:(0,m.css)({margin:0,fontSize:e.typography.body.fontSize,color:e.colors.text.secondary,textOverflow:"ellipsis"}),singleLine:(0,m.css)({display:"-webkit-box",WebkitBoxOrient:"vertical",WebkitLineClamp:1,overflow:"hidden"})});function Li(){const e=Ft();return t.createElement("div",null,t.createElement("span",{className:e.logo},t.createElement(Ri.e,{src:"https://secure.gravatar.com/avatar",alt:"unknown"})),t.createElement("span",{className:e.otherText},"Unknown"))}function tn(e){const{value:o}=(0,bt.A)(async()=>await(0,Le.l)().get(e),[e]);return o}function Ii(e){const o=tn(e.row.original.datasourceRef),n=Ft();return t.createElement("p",{className:n.otherText},o?.meta.name)}function Fi(e){const o=Ft(),n=(0,be.KQ)(e.row.original.createdAtTimestamp).format("YYYY-MM-DD HH:mm:ss");return t.createElement("p",{className:o.otherText},n)}function Oi(e){const o=tn(e.row.original.datasourceRef),n=Ft();if(!o)return t.createElement(nt.y,null);if(!e.row.original.query)return t.createElement("div",null,"No queries");const a=e.row.original.query,s=e.row.original.description,r=o?.name||"";return t.createElement("div",{"aria-label":`Query template for ${r}: ${s}`},t.createElement("p",{className:n.header},t.createElement("img",{className:n.logo,src:o?.meta.info.logos.small||"public/img/icn-datasource.svg",alt:o?.meta.info.description}),r),t.createElement("p",{className:(0,m.cx)(n.mainText,n.singleLine)},o?.getQueryDisplayText?.(a)),t.createElement("p",{className:(0,m.cx)(n.otherText,n.singleLine)},s))}const Di=[{id:"description",header:"Data source and query",cell:Oi},{id:"addedBy",header:"Added by",cell:Li},{id:"datasourceType",header:"Datasource type",cell:Ii,sortType:"string"},{id:"createdAtTimestamp",header:"Date added",cell:Fi,sortType:(e,o,n,a)=>{const s=e.original.createdAtTimestamp||0,r=o.original.createdAtTimestamp||0;return a?s-r:r-s}},{id:"actions",header:"",cell:({row:{original:e}})=>t.createElement(wi,{query:e.query,rootDatasourceUid:e.datasourceRef?.uid})}],Ai={tableWithSpacing:(0,m.css)({"th:first-child":{width:"50%"}})};function Ni({queryTemplateRows:e}){return t.createElement(bi.j,{className:Ai.tableWithSpacing,columns:Di,data:e,getRowId:o=>o.index})}function ki(){const{data:e,isLoading:o,error:n}=fi();if(n)return t.createElement(co.p,{variant:"not-found",message:"Something went wrong"},n.message);if(o)return t.createElement(nt.y,null);if(!e||e.length===0)return t.createElement(co.p,{message:"Query Library",variant:"not-found"},t.createElement("p",null,"You haven't saved any queries to your library yet. Start adding them from Explore or your Query History tab."));const a=e.map((s,r)=>{const i=s.targets[0]?.datasource,l=(0,ao.tR)().getInstanceSettings(i)?.meta.name||"";return{index:r.toString(),datasourceRef:i,datasourceType:l,createdAtTimestamp:s?.createdAtTimestamp||0,query:s.targets[0],description:s.title}});return t.createElement(Ni,{queryTemplateRows:a})}function Pi(){return t.createElement(ki,null)}var Mi=h(47097),po=h(67647),De=h(3591),ho=h(21744),nn=h(82467),on=h(3169),Me=h(28444),an=h(72635),zi=h(26272),Hi=h(55882);const $i=[{value:"Public",label:"Public"},{value:"Private",label:"Private"}],Bi=(0,C.t)("explore.add-to-library-modal.info","You're about to save this query. Once saved, you can easily access it in the Query Library tab for future use and reference."),Vi=({onCancel:e,onSave:o,query:n})=>{const{register:a,handleSubmit:s}=(0,qe.mN)(),r=tn(n.datasource),i=(0,t.useMemo)(()=>r?.getQueryDisplayText?.(n)||(0,re.ev)(n),[r,n]),l=d=>{o(d)};return t.createElement("form",{onSubmit:s(l)},t.createElement("p",null,Bi),t.createElement(ie.D,{label:(0,C.t)("explore.add-to-library-modal.query","Query")},t.createElement(ho.f,{readOnly:!0,value:i})),t.createElement(ie.D,{label:(0,C.t)("explore.add-to-library-modal.data-source-name","Data source name")},t.createElement(Hi.s,{current:r?.uid,disabled:!0})),t.createElement(ie.D,{label:(0,C.t)("explore.add-to-library-modal.data-source-type","Data source type")},t.createElement(Ne.p,{disabled:!0,defaultValue:r?.meta.name})),t.createElement(ie.D,{label:(0,C.t)("explore.add-to-library-modal.description","Description")},t.createElement(Ne.p,{id:"query-template-description",autoFocus:!0,...a("description")})),t.createElement(ie.D,{label:(0,C.t)("explore.add-to-library-modal.visibility","Visibility")},t.createElement(_e.z,{options:$i,value:"Public",disabled:!0})),t.createElement(Fe.K,{showLabel:!0,disabled:!0,label:(0,C.t)("explore.add-to-library-modal.auto-star","Auto-star this query to add it to your starred list in the Query Library.")}),t.createElement(Be.a.ButtonRow,null,t.createElement(W.$n,{variant:"secondary",onClick:()=>e(),fill:"outline"},"Cancel"),t.createElement(W.$n,{variant:"primary",type:"submit"},"Save")))},Wi=({query:e})=>{const[o,n]=(0,t.useState)(!1),[a,{isSuccess:s}]=yi(),r=async d=>{(await a(d)).error||(0,De.J7)().publish({type:zi.r1.alertSuccess.name,payload:[(0,an.t)("explore.rich-history-card.query-template-added","Query template successfully added to the library")]})},i=(0,an.t)("explore.rich-history-card.add-to-library","Add to library"),l=d=>{const c=(0,be.KQ)().toISOString(),p=d.description||`Imported from Explore - ${c}`;r({title:p,targets:[e]})};return vi()&&!s?t.createElement(t.Fragment,null,t.createElement(W.$n,{variant:"secondary","aria-label":i,onClick:()=>n(!0)},i),t.createElement(Be.a,{title:(0,an.t)("explore.add-to-library-modal.title","Add query to Query Library"),isOpen:o,onDismiss:()=>n(!1)},t.createElement(Vi,{onCancel:()=>n(()=>!1),query:e,onSave:d=>{l(d),n(!1)}}))):void 0},Qi={changeDatasource:Ae.wh,deleteHistoryItem:Se.VM,commentHistoryItem:Se.H9,starHistoryItem:Se.sh,setQueries:j.Rk},ji=(0,me.connect)(void 0,Qi),Ui=e=>{const o="240px",n="170px",a=e.colors.background.secondary;return{queryCard:(0,m.css)`
      position: relative;
      display: flex;
      flex-direction: column;
      border: 1px solid ${e.colors.border.weak};
      margin: ${e.spacing(1)} 0;
      background-color: ${a};
      border-radius: ${e.shape.radius.default};
      .starred {
        color: ${e.v1.palette.orange};
      }
    `,cardRow:(0,m.css)`
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: ${e.spacing(1)};
      border-bottom: none;
      :first-of-type {
        border-bottom: 1px solid ${e.colors.border.weak};
        padding: ${e.spacing(.5,1)};
      }
      img {
        height: ${e.typography.fontSize}px;
        max-width: ${e.typography.fontSize}px;
        margin-right: ${e.spacing(1)};
      }
    `,queryActionButtons:(0,m.css)`
      max-width: ${n};
      display: flex;
      justify-content: flex-end;
      font-size: ${e.typography.size.base};
      button {
        margin-left: ${e.spacing(1)};
      }
    `,queryContainer:(0,m.css)`
      font-weight: ${e.typography.fontWeightMedium};
      width: calc(100% - ${o});
    `,updateCommentContainer:(0,m.css)`
      width: calc(100% + ${o});
      margin-top: ${e.spacing(1)};
    `,comment:(0,m.css)`
      overflow-wrap: break-word;
      font-size: ${e.typography.bodySmall.fontSize};
      font-weight: ${e.typography.fontWeightRegular};
      margin-top: ${e.spacing(.5)};
    `,commentButtonRow:(0,m.css)`
      > * {
        margin-top: ${e.spacing(1)};
        margin-right: ${e.spacing(1)};
      }
    `,textArea:(0,m.css)`
      width: 100%;
    `,runButton:(0,m.css)`
      max-width: ${n};
      display: flex;
      justify-content: flex-end;
      button {
        height: auto;
        padding: ${e.spacing(.5,2)};
        line-height: 1.4;
        span {
          white-space: normal !important;
        }
      }
    `,loader:(0,m.css)`
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: ${e.colors.background.secondary};
    `}};function qi(e){const{queryHistoryItem:o,commentHistoryItem:n,starHistoryItem:a,deleteHistoryItem:s,datasourceInstances:r}=e,[i,l]=(0,t.useState)(!1),[d,c]=(0,t.useState)(o.comment),p=(0,N.of)(Ui),u=r?r.find(R=>R.uid===o.datasourceUid):void 0,v=async()=>{const R=[...o.queries.map(O=>O.datasource?.type||"unknown")];(0,M.rR)("grafana_explore_query_history_copy_query",{datasources:R,mixed:!!u?.meta.mixed});const A=o.queries.map(O=>{let k=r?.find(V=>V.uid===o.datasourceUid);return k?.meta.mixed&&(k=r?.find(V=>V.uid===O.datasource?.uid)),(0,re.Ax)(O,k)}).join(`
`);(0,je.uJ)(A),(0,Oe.JD)((0,nn.dx)((0,on.tZ)((0,C.t)("explore.rich-history-notification.query-copied","Query copied to clipboard"))))},g=async()=>{const R=(0,re.U3)(o);await(0,Wt.VP)(R)},E=()=>{const R=A=>{s(A),(0,Oe.JD)((0,nn.dx)((0,on.tZ)((0,C.t)("explore.rich-history-notification.query-deleted","Query deleted")))),(0,M.rR)("grafana_explore_query_history_deleted",{queryHistoryEnabled:B.$.queryHistoryEnabled})};o.starred?(0,De.J7)().publish(new Me.bY({title:(0,C.t)("explore.rich-history-card.delete-query-confirmation-title","Delete"),text:(0,C.t)("explore.rich-history-card.delete-starred-query-confirmation-text","Are you sure you want to permanently delete your starred query?"),yesText:(0,C.t)("explore.rich-history-card.confirm-delete","Delete"),icon:"trash-alt",onConfirm:()=>R(o.id)})):R(o.id)},f=()=>{a(o.id,!o.starred),(0,M.rR)("grafana_explore_query_history_starred",{queryHistoryEnabled:B.$.queryHistoryEnabled,newValue:!o.starred})},b=()=>l(!i),S=()=>{n(o.id,d),l(!1),(0,M.rR)("grafana_explore_query_history_commented",{queryHistoryEnabled:B.$.queryHistoryEnabled})},w=()=>{l(!1),c(o.comment)},y=R=>{R.key==="Enter"&&(R.shiftKey||R.ctrlKey)&&S(),R.key==="Escape"&&w()},x=t.createElement("div",{className:p.updateCommentContainer,"aria-label":d?(0,C.t)("explore.rich-history-card.update-comment-form","Update comment form"):(0,C.t)("explore.rich-history-card.add-comment-form","Add comment form")},t.createElement(ho.f,{onKeyDown:y,value:d,placeholder:d?void 0:(0,C.t)("explore.rich-history-card.optional-description","An optional description of what the query does."),onChange:R=>c(R.currentTarget.value),className:p.textArea}),t.createElement("div",{className:p.commentButtonRow},t.createElement(W.$n,{onClick:S},t.createElement(C.x6,{i18nKey:"explore.rich-history-card.save-comment"},"Save comment")),t.createElement(W.$n,{variant:"secondary",onClick:w},t.createElement(C.x6,{i18nKey:"explore.rich-history-card.cancel"},"Cancel")))),T=t.createElement("div",{className:p.queryActionButtons},t.createElement(We.K,{name:"comment-alt",onClick:b,tooltip:o.comment?.length>0?(0,C.t)("explore.rich-history-card.edit-comment-tooltip","Edit comment"):(0,C.t)("explore.rich-history-card.add-comment-tooltip","Add comment")}),t.createElement(We.K,{name:"copy",onClick:v,tooltip:(0,C.t)("explore.rich-history-card.copy-query-tooltip","Copy query to clipboard")}),u&&t.createElement(We.K,{name:"share-alt",onClick:g,tooltip:t.createElement(C.x6,{i18nKey:"explore.rich-history-card.copy-shortened-link-tooltip"},"Copy shortened link to clipboard")}),t.createElement(We.K,{name:"trash-alt",title:(0,C.t)("explore.rich-history-card.delete-query-title","Delete query"),tooltip:(0,C.t)("explore.rich-history-card.delete-query-tooltip","Delete query"),onClick:E}),t.createElement(We.K,{name:o.starred?"favorite":"star",iconType:o.starred?"mono":"default",onClick:f,tooltip:o.starred?(0,C.t)("explore.rich-history-card.unstar-query-tooltip","Unstar query"):(0,C.t)("explore.rich-history-card.star-query-tooltip","Star query")}));return t.createElement("div",{className:p.queryCard},t.createElement("div",{className:p.cardRow},t.createElement(mo,{dsApi:u,size:"sm"}),T),t.createElement("div",{className:(0,m.cx)(p.cardRow)},t.createElement("div",{className:p.queryContainer},o?.queries.map((R,A)=>{const O=r?.find(k=>k.uid===R.datasource?.uid);return t.createElement(Ki,{query:{query:R,datasource:O},key:`${R}-${A}`,showDsInfo:u?.meta.mixed})}),!i&&o.comment&&t.createElement("div",{"aria-label":(0,C.t)("explore.rich-history-card.query-comment-label","Query comment"),className:p.comment},o.comment),i&&x),!i&&t.createElement(Wi,{query:o?.queries[0]}),!i&&t.createElement("div",{className:p.runButton},t.createElement(uo,{queries:o.queries,rootDatasourceUid:u?.uid}))))}const Gi=e=>({queryRow:(0,m.css)`
    border-top: 1px solid ${e.colors.border.weak};
    display: flex;
    flex-direction: row;
    padding: 4px 0px;
    gap: 4px;
    :first-child {
      border-top: none;
    }
  `,dsInfoContainer:(0,m.css)`
    display: flex;
    align-items: center;
  `,queryText:(0,m.css)`
    word-break: break-all;
  `}),Ki=({query:e,showDsInfo:o=!1})=>{const n=(0,N.of)(Gi);return t.createElement("div",{className:n.queryRow},o&&t.createElement("div",{className:n.dsInfoContainer},t.createElement(mo,{dsApi:e.datasource,size:"md"}),": "),t.createElement("span",{"aria-label":(0,C.t)("explore.rich-history-card.query-text-label","Query text"),className:n.queryText},(0,re.Ax)(e.query,e.datasource)))},Zi=e=>o=>(0,m.css)`
  display: flex;
  align-items: center;
  font-size: ${o.typography[e==="sm"?"bodySmall":"body"].fontSize};
  font-weight: ${o.typography.fontWeightMedium};
  white-space: nowrap;
`;function mo({dsApi:e,size:o}){const n=(0,t.useCallback)(s=>Zi(o)(s),[o]),a=(0,N.of)(n);return t.createElement("div",{className:a},t.createElement("img",{src:e?.meta.info.logos.small||"public/img/icn-datasource.svg",alt:e?.type||(0,C.t)("explore.rich-history-card.datasource-not-exist","Data source does not exist anymore"),"aria-label":(0,C.t)("explore.rich-history-card.datasource-icon-label","Data source icon")}),t.createElement("div",{"aria-label":(0,C.t)("explore.rich-history-card.datasource-name-label","Data source name")},e?.name||(0,C.t)("explore.rich-history-card.datasource-not-exist","Data source does not exist anymore")))}const go=ji(qi),Yi=(e,o)=>({container:(0,m.css)`
      display: flex;
    `,labelSlider:(0,m.css)`
      font-size: ${e.typography.bodySmall.fontSize};
      &:last-of-type {
        margin-top: ${e.spacing(3)};
      }
      &:first-of-type {
        font-weight: ${e.typography.fontWeightMedium};
        margin-bottom: ${e.spacing(2)};
      }
    `,containerContent:(0,m.css)`
      /* 134px is based on the width of the Query history tabs bar, so the content is aligned to right side of the tab */
      width: calc(100% - 134px);
    `,containerSlider:(0,m.css)`
      width: 129px;
      margin-right: ${e.spacing(1)};
    `,fixedSlider:(0,m.css)`
      position: fixed;
    `,slider:(0,m.css)`
      bottom: 10px;
      height: ${o-180}px;
      width: 129px;
      padding: ${e.spacing(1)} 0;
    `,selectors:(0,m.css)`
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
    `,filterInput:(0,m.css)`
      margin-bottom: ${e.spacing(1)};
    `,multiselect:(0,m.css)`
      width: 100%;
      margin-bottom: ${e.spacing(1)};
    `,sort:(0,m.css)`
      width: 170px;
    `,sessionName:(0,m.css)`
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
      margin-top: ${e.spacing(3)};
      h4 {
        margin: 0 10px 0 0;
      }
    `,heading:(0,m.css)`
      font-size: ${e.typography.h4.fontSize};
      margin: ${e.spacing(2,.25,1,.25)};
    `,footer:(0,m.css)`
      height: 60px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: ${e.typography.fontWeightLight};
      font-size: ${e.typography.bodySmall.fontSize};
      a {
        font-weight: ${e.typography.fontWeightMedium};
        margin-left: ${e.spacing(.25)};
      }
    `,queries:(0,m.css)`
      font-size: ${e.typography.bodySmall.fontSize};
      font-weight: ${e.typography.fontWeightRegular};
      margin-left: ${e.spacing(.5)};
    `});function Ji(e){const{queries:o,totalQueries:n,loading:a,richHistorySearchFilters:s,updateFilters:r,clearRichHistoryResults:i,loadMoreRichHistory:l,richHistorySettings:d,height:c}=e,p=(0,F.useSelector)(K.Kl),u=(0,N.of)(Yi,c),v=(0,re.TR)();(0,t.useEffect)(()=>{const y=!d.activeDatasourcesOnly&&d.lastUsedDatasourceFilters?d.lastUsedDatasourceFilters:p.dsToExplore.map(T=>v.find(R=>R.uid===T.datasource?.uid)?.name).filter(T=>!!T),x={search:"",sortOrder:re.xB.Descending,datasourceFilters:y,from:0,to:d.retentionPeriod,starred:!1};return r(x),()=>{i()}},[]);const{value:g,loading:E}=(0,bt.A)(async()=>{const x=await(s?.datasourceFilters&&s?.datasourceFilters.length>0?s?.datasourceFilters:v.map(T=>T.uid)).map(async T=>{try{return(0,Le.l)().get(T)}catch{return Promise.resolve()}});return x!==void 0?(await Promise.all(x)).filter(R=>!!R):[]},[s?.datasourceFilters]);if(!s)return t.createElement("span",null,t.createElement(C.x6,{i18nKey:"explore.rich-history-queries-tab.loading"},"Loading..."));const f=(0,re.x8)(o,s.sortOrder),b=yo(),S=o.length&&o.length!==n,w=[s.from||0,s.to||d.retentionPeriod];return t.createElement("div",{className:u.container},t.createElement("div",{className:u.containerSlider},t.createElement("div",{className:u.fixedSlider},t.createElement("div",{className:u.labelSlider},t.createElement(C.x6,{i18nKey:"explore.rich-history-queries-tab.filter-history"},"Filter history")),t.createElement("div",{className:u.labelSlider},(0,re.IA)(w[0])),t.createElement("div",{className:u.slider},t.createElement(Mi.F,{tooltipAlwaysVisible:!1,min:0,max:d.retentionPeriod,value:w,orientation:"vertical",formatTooltipResult:re.IA,reverse:!0,onAfterChange:y=>{r({from:y[0],to:y[1]})}})),t.createElement("div",{className:u.labelSlider},(0,re.IA)(w[1])))),t.createElement("div",{className:u.containerContent,"data-testid":"query-history-queries-tab"},t.createElement("div",{className:u.selectors},!d.activeDatasourcesOnly&&t.createElement(Ie.KF,{className:u.multiselect,options:v.map(y=>({value:y.name,label:y.name})),value:s.datasourceFilters,placeholder:(0,C.t)("explore.rich-history-queries-tab.filter-placeholder","Filter queries for data sources(s)"),"aria-label":(0,C.t)("explore.rich-history-queries-tab.filter-aria-label","Filter queries for data sources(s)"),onChange:y=>{r({datasourceFilters:y.map(x=>x.value)})}}),t.createElement("div",{className:u.filterInput},t.createElement(po.Z,{escapeRegex:!1,placeholder:(0,C.t)("explore.rich-history-queries-tab.search-placeholder","Search queries"),value:s.search,onChange:y=>r({search:y})})),t.createElement("div",{"aria-label":(0,C.t)("explore.rich-history-queries-tab.sort-aria-label","Sort queries"),className:u.sort},t.createElement(Ie.l6,{value:b.filter(y=>y.value===s.sortOrder),options:b,placeholder:(0,C.t)("explore.rich-history-queries-tab.sort-placeholder","Sort queries by"),onChange:y=>r({sortOrder:y.value})}))),(a||E)&&t.createElement("span",null,t.createElement(C.x6,{i18nKey:"explore.rich-history-queries-tab.loading-results"},"Loading results...")),!(a||E)&&Object.keys(f).map(y=>t.createElement("div",{key:y},t.createElement("div",{className:u.heading},y," ",t.createElement("span",{className:u.queries},S?t.createElement(C.x6,{i18nKey:"explore.rich-history-queries-tab.displaying-partial-queries",defaults:"Displaying {{ count }} queries",values:{count:f[y].length}}):t.createElement(C.x6,{i18nKey:"explore.rich-history-queries-tab.displaying-queries",defaults:"{{ count }} queries",values:{count:f[y].length}}))),f[y].map(x=>t.createElement(go,{datasourceInstances:g,queryHistoryItem:x,key:x.id})))),S?t.createElement("div",null,t.createElement(C.x6,{i18nKey:"explore.rich-history-queries-tab.showing-queries",defaults:"Showing {{ shown }} of {{ total }} <0>Load more</0>",values:{shown:o.length,total:n},components:[t.createElement(W.$n,{onClick:l,key:"loadMoreButton"},"Load more")]})):null,t.createElement("div",{className:u.footer},B.$.queryHistoryEnabled?"":(0,C.t)("explore.rich-history-queries-tab.history-local","The history is local to your browser and is not shared with others."))))}var Xi=h(39640);const _i=e=>({container:(0,m.css)`
      font-size: ${e.typography.bodySmall.fontSize};
    `,spaceBetween:(0,m.css)`
      margin-bottom: ${e.spacing(3)};
    `,input:(0,m.css)`
      max-width: 200px;
    `,bold:(0,m.css)`
      font-weight: ${e.typography.fontWeightBold};
    `,bottomMargin:(0,m.css)`
      margin-bottom: ${e.spacing(1)};
    `}),fo=[{value:2,label:(0,C.t)("explore.rich-history-settings-tab.retention-period.2-days","2 days")},{value:5,label:(0,C.t)("explore.rich-history-settings-tab.retention-period.5-days","5 days")},{value:7,label:(0,C.t)("explore.rich-history-settings-tab.retention-period.1-week","1 week")},{value:14,label:(0,C.t)("explore.rich-history-settings-tab.retention-period.2-weeks","2 weeks")}];function el(e){const{retentionPeriod:o,starredTabAsFirstTab:n,activeDatasourcesOnly:a,onChangeRetentionPeriod:s,toggleStarredTabAsFirstTab:r,toggleActiveDatasourcesOnly:i,deleteRichHistory:l}=e,d=(0,N.of)(_i),c=fo.find(u=>u.value===o),p=()=>{(0,De.J7)().publish(new Me.bY({title:(0,C.t)("explore.rich-history-settings-tab.delete-title","Delete"),text:(0,C.t)("explore.rich-history-settings-tab.delete-confirm-text","Are you sure you want to permanently delete your query history?"),yesText:(0,C.t)("explore.rich-history-settings-tab.delete-confirm","Delete"),icon:"trash-alt",onConfirm:()=>{l(),(0,Oe.JD)((0,nn.dx)((0,on.tZ)((0,C.t)("explore.rich-history-settings-tab.query-history-deleted","Query history deleted"))))}}))};return t.createElement("div",{className:d.container},(0,Ue.gQ)().changeRetention?t.createElement(ie.D,{label:(0,C.t)("explore.rich-history-settings-tab.history-time-span","History time span"),description:(0,C.t)("explore.rich-history-settings-tab.history-time-span-description","Select the period of time for which Grafana will save your query history. Up to {{MAX_HISTORY_ITEMS}} entries will be stored.",{MAX_HISTORY_ITEMS:Xi.$H})},t.createElement("div",{className:d.input},t.createElement(Ie.l6,{value:c,options:fo,onChange:s}))):t.createElement(Ge.F,{severity:"info",title:(0,C.t)("explore.rich-history-settings-tab.history-time-span","History time span")},(0,C.t)("explore.rich-history-settings-tab.alert-info","Grafana will keep entries up to {{optionLabel}}.Starred entries won't be deleted.",{optionLabel:c?.label})),t.createElement(xe.I,{label:(0,C.t)("explore.rich-history-settings-tab.change-default-tab","Change the default active tab from \u201CQuery history\u201D to \u201CStarred\u201D"),className:d.spaceBetween},t.createElement(Fe.K,{id:"explore-query-history-settings-default-active-tab",value:n,onChange:r})),(0,Ue.gQ)().onlyActiveDataSource&&t.createElement(xe.I,{label:(0,C.t)("explore.rich-history-settings-tab.only-show-active-datasource","Only show queries for data source currently active in Explore"),className:d.spaceBetween},t.createElement(Fe.K,{id:"explore-query-history-settings-data-source-behavior",value:a,onChange:i})),(0,Ue.gQ)().clearHistory&&t.createElement("div",null,t.createElement("div",{className:d.bold},t.createElement(C.x6,{i18nKey:"explore.rich-history-settings-tab.clear-query-history"},"Clear query history")),t.createElement("div",{className:d.bottomMargin},t.createElement(C.x6,{i18nKey:"explore.rich-history-settings-tab.clear-history-info"},"Delete all of your query history, permanently.")),t.createElement(W.$n,{variant:"destructive",onClick:p},t.createElement(C.x6,{i18nKey:"explore.rich-history-settings-tab.clear-query-history-button"},"Clear query history"))))}const tl=e=>({container:(0,m.css)`
      display: flex;
    `,containerContent:(0,m.css)`
      width: 100%;
    `,selectors:(0,m.css)`
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
    `,multiselect:(0,m.css)`
      width: 100%;
      margin-bottom: ${e.spacing(1)};
    `,filterInput:(0,m.css)`
      margin-bottom: ${e.spacing(1)};
    `,sort:(0,m.css)`
      width: 170px;
    `,footer:(0,m.css)`
      height: 60px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: ${e.typography.fontWeightLight};
      font-size: ${e.typography.bodySmall.fontSize};
      a {
        font-weight: ${e.typography.fontWeightMedium};
        margin-left: ${e.spacing(.25)};
      }
    `});function nl(e){const{updateFilters:o,clearRichHistoryResults:n,loadMoreRichHistory:a,richHistorySettings:s,queries:r,totalQueries:i,loading:l,richHistorySearchFilters:d}=e,c=(0,N.of)(tl),p=(0,F.useSelector)(K.Kl),u=(0,re.TR)();(0,t.useEffect)(()=>{const f=s.activeDatasourcesOnly&&s.lastUsedDatasourceFilters?s.lastUsedDatasourceFilters:p.dsToExplore.map(S=>u.find(w=>w.uid===S.datasource?.uid)?.name).filter(S=>!!S),b={search:"",sortOrder:re.xB.Descending,datasourceFilters:f,from:0,to:s.retentionPeriod,starred:!0};return o(b),()=>{n()}},[]);const{value:v,loading:g}=(0,bt.A)(async()=>{const b=await(d?.datasourceFilters&&d?.datasourceFilters.length>0?d?.datasourceFilters:u.map(S=>S.uid)).map(async S=>{try{return(0,Le.l)().get(S)}catch{return Promise.resolve()}});return b!==void 0?(await Promise.all(b)).filter(w=>!!w):[]},[d?.datasourceFilters]);if(!d)return t.createElement("span",null,t.createElement(C.x6,{i18nKey:"explore.rich-history-starred-tab.loading"},"Loading..."),";");const E=yo();return t.createElement("div",{className:c.container},t.createElement("div",{className:c.containerContent},t.createElement("div",{className:c.selectors},!s.activeDatasourcesOnly&&t.createElement(Ie.KF,{className:c.multiselect,options:u.map(f=>({value:f.name,label:f.name})),value:d.datasourceFilters,placeholder:(0,C.t)("explore.rich-history-starred-tab.filter-queries-placeholder","Filter queries for data sources(s)"),"aria-label":(0,C.t)("explore.rich-history-starred-tab.filter-queries-aria-label","Filter queries for data sources(s)"),onChange:f=>{o({datasourceFilters:f.map(b=>b.value)})}}),t.createElement("div",{className:c.filterInput},t.createElement(po.Z,{escapeRegex:!1,placeholder:(0,C.t)("explore.rich-history-starred-tab.search-queries-placeholder","Search queries"),value:d.search,onChange:f=>o({search:f})})),t.createElement("div",{"aria-label":(0,C.t)("explore.rich-history-starred-tab.sort-queries-aria-label","Sort queries"),className:c.sort},t.createElement(Ie.l6,{value:E.filter(f=>f.value===d.sortOrder),options:E,placeholder:(0,C.t)("explore.rich-history-starred-tab.sort-queries-placeholder","Sort queries by"),onChange:f=>o({sortOrder:f.value})}))),l&&g&&t.createElement("span",null,t.createElement(C.x6,{i18nKey:"explore.rich-history-starred-tab.loading-results"},"Loading results...")),!(l&&g)&&r.map(f=>t.createElement(go,{queryHistoryItem:f,key:f.id,datasourceInstances:v})),r.length&&r.length!==i?t.createElement("div",null,t.createElement(C.x6,{i18nKey:"explore.rich-history-starred-tab.showing-queries",defaults:"Showing {{ shown }} of {{ total }} <0>Load more</0>",values:{shown:r.length,total:i},components:[t.createElement(W.$n,{onClick:a,key:"loadMoreButton"},"Load more")]})):null,t.createElement("div",{className:c.footer},B.$.queryHistoryEnabled?"":(0,C.t)("explore.rich-history-starred-tab.local-history-message","The history is local to your browser and is not shared with others."))))}const yo=()=>[{label:(0,C.t)("explore.rich-history.newest-first","Newest first"),value:re.xB.Descending},{label:(0,C.t)("explore.rich-history.oldest-first","Oldest first"),value:re.xB.Ascending},{label:(0,C.t)("explore.rich-history.datasource-a-z","Data source A-Z"),value:re.xB.DatasourceAZ},{label:(0,C.t)("explore.rich-history.datasource-z-a","Data source Z-A"),value:re.xB.DatasourceZA}].filter(e=>(0,Ue.gQ)().availableFilters.includes(e.value));function ol(e){const{richHistory:o,richHistoryTotal:n,height:a,deleteRichHistory:s,onClose:r,firstTab:i}=e,[l,d]=(0,t.useState)(!1),{queryLibraryAvailable:c}=Ze(),p=T=>{e.updateHistorySettings({...e.richHistorySettings,...T})},u=T=>{const R={...e.richHistorySearchFilters,...T,page:1};e.updateHistorySearchFilters(R),v()},v=(0,_.debounce)(()=>{e.loadRichHistory(),d(!0)},300),g=T=>{T.value!==void 0&&p({retentionPeriod:T.value})},E=()=>p({starredTabAsFirstTab:!e.richHistorySettings.starredTabAsFirstTab}),f=()=>p({activeDatasourcesOnly:!e.richHistorySettings.activeDatasourcesOnly});(0,t.useEffect)(()=>{d(!1)},[o]);const b={label:wt.queryLibrary,value:ke.QueryLibrary,content:t.createElement(Pi,null),icon:"book"},S={label:wt.queryHistory,value:ke.RichHistory,content:t.createElement(Ji,{queries:o,totalQueries:n||0,loading:l,updateFilters:u,clearRichHistoryResults:()=>e.clearRichHistoryResults(),loadMoreRichHistory:()=>e.loadMoreRichHistory(),richHistorySettings:e.richHistorySettings,richHistorySearchFilters:e.richHistorySearchFilters,height:a}),icon:"history"},w={label:(0,C.t)("explore.rich-history.starred","Starred"),value:ke.Starred,content:t.createElement(nl,{queries:o,totalQueries:n||0,loading:l,updateFilters:u,clearRichHistoryResults:()=>e.clearRichHistoryResults(),loadMoreRichHistory:()=>e.loadMoreRichHistory(),richHistorySettings:e.richHistorySettings,richHistorySearchFilters:e.richHistorySearchFilters}),icon:"star"},y={label:(0,C.t)("explore.rich-history.settings","Settings"),value:ke.Settings,content:t.createElement(el,{retentionPeriod:e.richHistorySettings.retentionPeriod,starredTabAsFirstTab:e.richHistorySettings.starredTabAsFirstTab,activeDatasourcesOnly:e.richHistorySettings.activeDatasourcesOnly,onChangeRetentionPeriod:g,toggleStarredTabAsFirstTab:E,toggleActiveDatasourcesOnly:f,deleteRichHistory:s}),icon:"sliders-v-alt"};let x=(c?[b]:[]).concat([S,w,y]);return t.createElement(lo.q,{tabs:x,onClose:r,defaultTab:i,closeIconTooltip:(0,C.t)("explore.rich-history.close-tooltip","Close query history"),testId:Qe.Tp.pages.Explore.QueryHistory.container})}function al(e){const o=e.explore,n=o.richHistorySearchFilters,{richHistorySettings:a,richHistory:s,richHistoryTotal:r}=o;return{richHistory:s,richHistoryTotal:r,richHistorySettings:a,richHistorySearchFilters:n}}const sl={initRichHistory:Se.PA,loadRichHistory:Se.jX,loadMoreRichHistory:Se.Uu,clearRichHistoryResults:Se.wk,updateHistorySettings:Se.fP,updateHistorySearchFilters:Se.Bj,deleteRichHistory:Se.s1},rl=(0,me.connect)(al,sl);function il(e){const o=(0,N.$j)(),{richHistory:n,richHistoryTotal:a,deleteRichHistory:s,initRichHistory:r,loadRichHistory:i,loadMoreRichHistory:l,clearRichHistoryResults:d,richHistorySettings:c,updateHistorySettings:p,richHistorySearchFilters:u,updateHistorySearchFilters:v,onClose:g}=e;(0,t.useEffect)(()=>{r()},[r]);const{selectedTab:E}=Ze(),[f,b]=(0,t.useState)(!1);return(0,t.useEffect)(()=>{f||(b(!0),(0,M.rR)("grafana_explore_query_history_opened",{queryHistoryEnabled:B.$.queryHistoryEnabled,selectedTab:E}))},[f,E]),!c||!E?t.createElement("span",null,t.createElement(C.x6,{i18nKey:"explore.rich-history-container.loading"},"Loading...")):t.createElement(ol,{richHistory:n,richHistoryTotal:a,firstTab:E,onClose:g,height:o.components.horizontalDrawer.defaultHeight,deleteRichHistory:s,richHistorySettings:c,richHistorySearchFilters:u,updateHistorySettings:p,updateHistorySearchFilters:v,loadRichHistory:i,loadMoreRichHistory:l,clearRichHistoryResults:d})}const ll=rl(il);var vo=h(19361),bo=h(15961);function cl(e){const o=(0,ln.C)("explore"),{chrome:n}=(0,He.Il)();(0,t.useEffect)(()=>{if(!e.panes||typeof e.panes!="string")return;let a;try{a=JSON.parse(e.panes)}catch{return}typeof a!="object"||a===null||Promise.allSettled(Object.values(a).map(s=>!s||typeof s!="object"||!(0,bo.C)("datasource",s)||!s.datasource||typeof s.datasource!="string"?Promise.reject():(0,Le.l)().get(s.datasource))).then(s=>s.filter(bo.s).map(r=>r.value)).then(s=>{if(s.length===0){h.g.document.title=`${o.main.text} - ${vo.M.AppTitle}`,n.update({pageNav:void 0});return}const r=s.map(i=>i.name).join(" | ");n.update({pageNav:{text:r}}),h.g.document.title=`${o.main.text} - ${r} - ${vo.M.AppTitle}`})},[e.panes,o.main.text,n])}function dl(){const{keybindings:e}=(0,He.Il)(),o=(0,F.useDispatch)();(0,t.useEffect)(()=>{e.setupTimeRangeBindings(!1);const n=[];return n.push((0,De.J7)().subscribe(Me.Rh,()=>{o((0,pe.$_)())})),n.push((0,De.J7)().subscribe(Me.Io,a=>{o((0,pe.Iy)(a.payload.direction))})),n.push((0,De.J7)().subscribe(Me.U0,a=>{o((0,pe.ke)(a.payload.scale))})),n.push((0,De.J7)().subscribe(Me.Bt,()=>{o((0,pe.Xk)())})),n.push((0,De.J7)().subscribe(Me.VZ,()=>{o((0,pe.GA)())})),()=>{n.forEach(a=>a.unsubscribe())}},[o,e])}const ul=e=>{const o=(0,F.useDispatch)(),{width:n}=(0,_t.A)(),a=(0,F.useSelector)(K.K6),s=(0,F.useSelector)(K.pF),[r,i]=(0,t.useState)(.5),l=(0,F.useSelector)(p=>p.explore),d=p=>{const u=n/2,v=(0,_.inRange)(p,u-100,u+100);o(v?(0,G.nD)({largerExploreId:void 0}):(0,G.nD)({largerExploreId:p>u?a[1][0]:a[0][0]})),i(p/n)};let c=0;return s&&(!l.evenSplitPanes&&l.maxedExploreId?c=l.maxedExploreId===a[1][0]?n-e:e:l.evenSplitPanes?c=Math.floor(n/2):r!==void 0&&(c=n*r)),{updateSplitSize:d,widthCalc:c}};function pl(){const{location:e}=(0,He.Il)();(0,t.useEffect)(()=>{const o=e.getSearchObject();(o.from||o.to)&&e.partial({from:void 0,to:void 0},!0)},[e])}const sn=200;function hl(e){return t.createElement(Ea,null,t.createElement(ml,{...e}))}function ml(e){const o=(0,N.of)(gl),n=(0,N.$j)();pl(),(0,Bn.s)(e.queryParams),cl(e.queryParams);const{chrome:a}=(0,He.Il)(),s=(0,ln.C)("explore"),{updateSplitSize:r,widthCalc:i}=ul(sn),l=(0,F.useSelector)(K.K6),d=(0,F.useSelector)(K.pF),c=(0,F.useSelector)(K.vC),{drawerOpened:p,setDrawerOpened:u,queryLibraryAvailable:v}=Ze(),g=B.$.featureToggles.correlations&&(c?.editorMode||!1);return(0,t.useEffect)(()=>{a.update({sectionNav:s})},[a,s]),dl(),t.createElement("div",{className:(0,m.cx)(o.pageScrollbarWrapper,{[o.correlationsEditorIndicator]:g})},t.createElement("h1",{className:"sr-only"},t.createElement(C.x6,{i18nKey:"nav.explore.title"})),t.createElement(Fo,null),g&&t.createElement(Lo,{panes:l}),t.createElement(Te.g,{splitOrientation:"vertical",paneSize:i,minSize:sn,maxSize:sn*-1,primary:"second",splitVisible:d,parentStyle:g?{height:`calc(100% - ${n.spacing(6)}`}:{},paneStyle:{overflow:"auto",display:"flex",flexDirection:"column"},onDragFinished:E=>E&&r(E)},l.map(([E])=>t.createElement(Y.Xw,{key:E,style:"page"},t.createElement(di,{exploreId:E})))),p&&t.createElement(fn,{initialHeight:v?"75vh":void 0},t.createElement(ll,{onClose:()=>{u(!1)}})))}const gl=e=>({pageScrollbarWrapper:(0,m.css)({width:"100%",flexGrow:1,minHeight:0,height:"100%",position:"relative",overflow:"hidden"}),correlationsEditorIndicator:(0,m.css)({borderLeft:`4px solid ${e.colors.primary.main}`,borderRight:`4px solid ${e.colors.primary.main}`,borderBottom:`4px solid ${e.colors.primary.main}`,overflow:"scroll"})})},10940:(rn,ze,h)=>{h.d(ze,{A:()=>B});var m=h(96540),t=function(N,Y){var Te=(0,m.useRef)(function(){});(0,m.useEffect)(function(){Te.current=N}),(0,m.useEffect)(function(){if(Y!==null){var He=setInterval(function(){return Te.current()},Y||0);return function(){return clearInterval(He)}}},[Y])};const B=t}}]);

//# sourceMappingURL=explore.c601db9bd93781ff19e1.js.map